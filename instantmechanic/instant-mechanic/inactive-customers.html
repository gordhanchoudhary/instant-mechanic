<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Journey Dashboard - Instant Mechanic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }
        
        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.3);
        }
        .btn-success { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.3);
        }
        
        .filters {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }
        
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .widget-toggles {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .toggle-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #10b981;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }
        
        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }
        
        .filter-input {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 14px;
            background: white;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Business Overview Stats */
        .business-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .business-overview.hidden {
            display: none;
        }
        
        .overview-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }
        
        .overview-card h3 {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .funnel-stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .funnel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .funnel-item:last-child {
            border-bottom: none;
        }
        
        .funnel-label {
            font-size: 14px;
            color: #374151;
        }
        
        .funnel-value {
            font-weight: 700;
            font-size: 16px;
        }
        
        .funnel-percentage {
            font-size: 12px;
            color: #6b7280;
            margin-left: 5px;
        }
        
        /* Main Stats Grid - Single Line Layout */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            text-align: center;
            border: 1px solid #e2e8f0;
            transition: transform 0.2s;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stat-number.blue { color: #3b82f6; }
        .stat-number.green { color: #10b981; }
        .stat-number.orange { color: #f59e0b; }
        .stat-number.red { color: #ef4444; }
        .stat-number.purple { color: #8b5cf6; }
        .stat-number.cyan { color: #06b6d4; }
        .stat-number.indigo { color: #6366f1; }
        .stat-number.pink { color: #ec4899; }
        
        .stat-label {
            color: #6b7280;
            font-weight: 500;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .stat-sublabel {
            color: #9ca3af;
            font-size: 11px;
            margin-top: 4px;
        }
        
        /* Customer Table */
        .customers-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .table-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
        }
        
        .table-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }
        
        .table-count {
            color: #6b7280;
            font-size: 14px;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
        }
        
        th {
            background: #f9fafb;
            font-weight: 700;
            color: #374151;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        tbody tr:hover {
            background: #f8fafc;
        }
        
        .customer-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 180px;
        }
        
        .customer-name {
            font-weight: 700;
            color: #1e293b;
            font-size: 15px;
        }
        
        .mobile-number {
            font-family: 'SF Mono', Monaco, monospace;
            font-weight: 500;
            color: #3b82f6;
            font-size: 13px;
        }
        
        .customer-id {
            font-size: 11px;
            color: #9ca3af;
        }
        
        .repeat-user-badge {
            padding: 2px 6px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 2px;
        }
        
        .journey-stage {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 200px;
        }
        
        .stage-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .stage-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
        }
        
        .stage-completed { background: #10b981; }
        .stage-pending { background: #f59e0b; }
        .stage-skipped { background: #6b7280; }
        
        .booking-summary {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 160px;
        }
        
        .booking-count {
            font-weight: 600;
            color: #374151;
        }
        
        .booking-types {
            display: flex;
            gap: 6px;
        }
        
        .booking-type-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .response-time {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 120px;
        }
        
        .response-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }
        
        .response-excellent { background: #dcfce7; color: #166534; }
        .response-good { background: #dbeafe; color: #1e40af; }
        .response-average { background: #fef3c7; color: #92400e; }
        .response-poor { background: #fee2e2; color: #991b1b; }
        .response-none { background: #f1f5f9; color: #64748b; }
        
        .agent-remarks {
            max-width: 200px;
            font-size: 12px;
        }
        
        .remarks-content {
            background: #fef3c7;
            padding: 8px;
            border-radius: 6px;
            border-left: 3px solid #f59e0b;
            font-style: italic;
            word-wrap: break-word;
        }
        
        .no-remarks {
            color: #9ca3af;
            font-style: italic;
        }
        
        .badge {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .badge-success { 
            background: #dcfce7; 
            color: #166534; 
        }
        .badge-warning { 
            background: #fef3c7; 
            color: #92400e; 
        }
        .badge-danger { 
            background: #fee2e2; 
            color: #991b1b; 
        }
        .badge-secondary { 
            background: #f1f5f9; 
            color: #475569; 
        }
        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }
        .badge-purple {
            background: #ede9fe;
            color: #6b21a8;
        }
        
        .ai-badge { background: #dbeafe; color: #1e40af; }
        .manual-badge { background: #f3e8ff; color: #7c2d12; }
        
        .agent-name {
            font-weight: 600;
            color: #7c3aed;
        }
        
        .created-time {
            color: #6b7280;
            font-size: 13px;
        }
        
        .chat-metrics {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
        }
        
        .chat-count {
            background: #eff6ff;
            color: #1e40af;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            min-width: 32px;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 80px;
            color: #6b7280;
            font-size: 16px;
        }
        
        .no-data {
            text-align: center;
            padding: 80px 20px;
            color: #6b7280;
            font-size: 16px;
        }
        
        @media (max-width: 1400px) {
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 15px;
            }
        }
        
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: stretch;
                padding: 20px;
            }
            
            .header h1 {
                text-align: center;
                font-size: 24px;
            }
            
            .filters-row {
                grid-template-columns: 1fr;
            }
            
            .business-overview {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            th, td {
                padding: 12px 8px;
                font-size: 12px;
            }
            
            .widget-toggles {
                flex-direction: column;
                gap: 10px;
            }
            
            .stat-number {
                font-size: 24px;
            }
            
            .stat-card {
                padding: 15px 10px;
                min-height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Customer Journey Dashboard</h1>
                <div class="header-subtitle">Track complete customer flow: Chat ‚Üí Location ‚Üí Price ‚Üí Booking ‚Üí Payment</div>
            </div>
            <div class="header-actions">
                <button class="btn btn-success" onclick="fetchData()">
                    üîÑ Refresh Data
                </button>
                <button class="btn btn-primary" onclick="exportCSV()">
                    üìä Export CSV
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filters-header">
                <h3 style="font-size: 18px; font-weight: 700; color: #1e293b;">Filters & Settings</h3>
                <div class="widget-toggles">
                    <div class="toggle-group">
                        <span>Business Overview</span>
                        <div class="toggle-switch active" onclick="toggleBusinessOverview()" id="businessToggle">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="filters-row">
                <div class="filter-group">
                    <label>Date</label>
                    <input type="date" id="dateFilter" class="filter-input" value="2025-09-12">
                </div>
                <div class="filter-group">
                    <label>Agent</label>
                    <select id="agentFilter" class="filter-input">
                        <option value="">All Agents</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Journey Stage</label>
                    <select id="journeyFilter" class="filter-input">
                        <option value="">All Stages</option>
                        <option value="chat_only">Chat Only</option>
                        <option value="location_shared">Location Shared</option>
                        <option value="price_shared">Price Shared</option>
                        <option value="booking_made">Booking Made</option>
                        <option value="payment_done">Payment Done</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Response Time</label>
                    <select id="responseFilter" class="filter-input">
                        <option value="">All Response Times</option>
                        <option value="excellent">Excellent (‚â§30s)</option>
                        <option value="good">Good (30s-1min)</option>
                        <option value="average">Average (1-3min)</option>
                        <option value="poor">Poor (3-5min)</option>
                        <option value="none">No Response (>5min)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>User Type</label>
                    <select id="carUserFilter" class="filter-input">
                        <option value="">All Users</option>
                        <option value="car">Car Users</option>
                        <option value="not_car">Non-Car Users</option>
                        <option value="repeat">Repeat Users</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Booking Type</label>
                    <select id="bookingTypeFilter" class="filter-input">
                        <option value="">All Types</option>
                        <option value="AI">AI Booking</option>
                        <option value="Manual">Manual Booking</option>
                        <option value="None">Non Booking</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Business Overview -->
        <div class="business-overview" id="businessOverview">
            <div class="overview-card">
                <h3>Customer Journey Funnel</h3>
                <div class="funnel-stats">
                    <div class="funnel-item">
                        <span class="funnel-label">1. Started Chat</span>
                        <span>
                            <span class="funnel-value" id="funnelChat">-</span>
                            <span class="funnel-percentage">(100%)</span>
                        </span>
                    </div>
                    <div class="funnel-item">
                        <span class="funnel-label">2. Shared Location</span>
                        <span>
                            <span class="funnel-value" id="funnelLocation">-</span>
                            <span class="funnel-percentage" id="funnelLocationPct">(--%)</span>
                        </span>
                    </div>
                    <div class="funnel-item">
                        <span class="funnel-label">3. Received Price</span>
                        <span>
                            <span class="funnel-value" id="funnelPrice">-</span>
                            <span class="funnel-percentage" id="funnelPricePct">(--%)</span>
                        </span>
                    </div>
                    <div class="funnel-item">
                        <span class="funnel-label">4. Made Booking</span>
                        <span>
                            <span class="funnel-value" id="funnelBooking">-</span>
                            <span class="funnel-percentage" id="funnelBookingPct">(--%)</span>
                        </span>
                    </div>
                    <div class="funnel-item">
                        <span class="funnel-label">5. Made Payment</span>
                        <span>
                            <span class="funnel-value" id="funnelPayment">-</span>
                            <span class="funnel-percentage" id="funnelPaymentPct">(--%)</span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="overview-card">
                <h3>Booking Performance</h3>
                <div class="funnel-stats">
                    <div class="funnel-item">
                        <span class="funnel-label">Total Bookings</span>
                        <span class="funnel-value" id="totalBookings">-</span>
                    </div>
                    <div class="funnel-item">
                        <span class="funnel-label">AI Bookings</span>
                        <span>
                            <span class="funnel-value" id="aiBookings">-</span>
                            <span class="funnel-percentage" id="aiBookingsPct">(--%)</span>
                        </span>
                    </div>
                    <div class="funnel-item">
                        <span class="funnel-label">Manual Bookings</span>
                        <span>
                            <span class="funnel-value" id="manualBookings">-</span>
                            <span class="funnel-percentage" id="manualBookingsPct">(--%)</span>
                        </span>
                    </div>
                    <div class="funnel-item">
                        <span class="funnel-label">Cancelled Bookings</span>
                        <span>
                            <span class="funnel-value" id="cancelledBookings">-</span>
                            <span class="funnel-percentage" id="cancelledBookingsPct">(--%)</span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="overview-card">
                <h3>Agent Performance</h3>
                <div class="funnel-stats">
                    <div class="funnel-item">
                        <span class="funnel-label">Avg Response Time</span>
                        <span class="funnel-value" id="avgResponseTime">-</span>
                    </div>
                    <div class="funnel-item">
                        <span class="funnel-label">Excellent Response</span>
                        <span>
                            <span class="funnel-value" id="excellentResponse">-</span>
                            <span class="funnel-percentage" id="excellentResponsePct">(--%)</span>
                        </span>
                    </div>
                    <div class="funnel-item">
                        <span class="funnel-label">Agent Contacted</span>
                        <span>
                            <span class="funnel-value" id="agentContacted">-</span>
                            <span class="funnel-percentage" id="agentContactedPct">(--%)</span>
                        </span>
                    </div>
                    <div class="funnel-item">
                        <span class="funnel-label">No Response</span>
                        <span>
                            <span class="funnel-value" id="noResponse">-</span>
                            <span class="funnel-percentage" id="noResponsePct">(--%)</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Stats - Single Line -->
        <div class="stats-grid" id="detailedStats">
            <div class="stat-card">
                <div class="stat-number blue" id="totalCustomers">-</div>
                <div class="stat-label">Total Customers</div>
                <div class="stat-sublabel">Started Chat</div>
            </div>
            <div class="stat-card">
                <div class="stat-number green" id="withLocation">-</div>
                <div class="stat-label">With Location</div>
                <div class="stat-sublabel">Shared Location</div>
            </div>
            <div class="stat-card">
                <div class="stat-number orange" id="priceShared">-</div>
                <div class="stat-label">Price Shared</div>
                <div class="stat-sublabel">Received RescueCharge</div>
            </div>
            <div class="stat-card">
                <div class="stat-number purple" id="hasBookings">-</div>
                <div class="stat-label">Has Bookings</div>
                <div class="stat-sublabel">Made Booking</div>
            </div>
            <div class="stat-card">
                <div class="stat-number cyan" id="paidCustomers">-</div>
                <div class="stat-label">Paid Customers</div>
                <div class="stat-sublabel">Made Payment</div>
            </div>
            <div class="stat-card">
                <div class="stat-number indigo" id="repeatUsers">-</div>
                <div class="stat-label">Repeat Users</div>
                <div class="stat-sublabel">Returning Customers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number pink" id="nonCarUsers">-</div>
                <div class="stat-label">Non-Car Users</div>
                <div class="stat-sublabel">Wrong Target</div>
            </div>
            <div class="stat-card">
                <div class="stat-number red" id="avgChatPerCustomer">-</div>
                <div class="stat-label">Avg Chat Count</div>
                <div class="stat-sublabel">Per Customer</div>
            </div>
            <div class="stat-card">
                <div class="stat-number orange" id="cancelledCalls">-</div>
                <div class="stat-label">Cancelled Users</div>
                <div class="stat-sublabel">All Bookings Cancelled</div>
            </div>
            <div class="stat-card">
                <div class="stat-number green" id="netBookings">-</div>
                <div class="stat-label">Net Bookings</div>
                <div class="stat-sublabel">Active Bookings</div>
            </div>
        </div>

        <!-- Customers Table -->
        <div class="customers-table">
            <div class="table-header">
                <h3 class="table-title">Customer Journey Details</h3>
                <div class="table-count">Showing: <span id="filteredCount">0</span> customers</div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Customer Info</th>
                            <th>Agent</th>
                            <th>Journey Stage</th>
                            <th>Bookings Summary</th>
                            <th>Response Time</th>
                            <th>Agent Remarks</th>
                            <th>Chat Activity</th>
                            <th>First Chat</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody">
                        <tr>
                            <td colspan="9" class="loading">Loading customer data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allCustomers = [];
        let filteredCustomers = [];

        // Business overview visibility preference
        let businessOverviewVisible = true;

        // Load business overview preference from localStorage
        function loadBusinessOverviewPreference() {
            const saved = localStorage.getItem('businessOverviewVisible');
            return saved !== null ? JSON.parse(saved) : true;
        }

        // Save business overview preference to localStorage
        function saveBusinessOverviewPreference(visible) {
            localStorage.setItem('businessOverviewVisible', JSON.stringify(visible));
        }

        // Initialize business overview visibility
        function initializeBusinessOverview() {
            businessOverviewVisible = loadBusinessOverviewPreference();
            
            document.getElementById('businessOverview').classList.toggle('hidden', !businessOverviewVisible);
            document.getElementById('businessToggle').classList.toggle('active', businessOverviewVisible);
        }

        // Toggle business overview visibility
        function toggleBusinessOverview() {
            businessOverviewVisible = !businessOverviewVisible;
            saveBusinessOverviewPreference(businessOverviewVisible);
            initializeBusinessOverview();
        }

        // NEW CANCELLATION LOGIC: Check if ALL bookings are cancelled for a customer
        function isFullyCancelled(customer) {
            if (customer.booking_details.length === 0) return false;
            
            // Check if ALL bookings are cancelled
            const allCancelled = customer.booking_details.every(booking => booking.is_cancelled === true);
            return allCancelled;
        }

        // Calculate agent response time in seconds
        function calculateResponseTime(customer) {
            if (customer.recalls_agent_notify.length === 0) return null;
            
            // Get the last (most recent) agent notify time
            const lastNotify = customer.recalls_agent_notify[customer.recalls_agent_notify.length - 1];
            const notifyTime = new Date(lastNotify.created_at);
            
            // Find first contact (whatsapp or call)
            let firstContactTime = null;
            
            const whatsappTimes = customer.recalls_whatsapp.map(w => new Date(w.created_at));
            const callTimes = customer.recalls_calls.map(c => new Date(c.created_at));
            
            // Combine and sort all contact times
            const allContactTimes = [...whatsappTimes, ...callTimes].sort((a, b) => a - b);
            
            if (allContactTimes.length > 0) {
                firstContactTime = allContactTimes[0];
            }
            
            if (!firstContactTime || firstContactTime < notifyTime) return null;
            
            const responseTimeMs = firstContactTime - notifyTime;
            return Math.floor(responseTimeMs / 1000); // Return seconds
        }

        // Get response time category
        function getResponseTimeCategory(seconds) {
            if (seconds === null || seconds > 300) return 'none'; // >5 min or no response
            if (seconds <= 30) return 'excellent'; // ‚â§30s
            if (seconds <= 60) return 'good'; // 30s-1min
            if (seconds <= 180) return 'average'; // 1-3min
            if (seconds <= 300) return 'poor'; // 3-5min
            return 'none';
        }

        // Format response time for display
        function formatResponseTime(seconds) {
            if (seconds === null || seconds > 300) return 'No Response';
            if (seconds < 60) return `${seconds}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            if (remainingSeconds === 0) return `${minutes}m`;
            return `${minutes}m ${remainingSeconds}s`;
        }

        // Check if customer is repeat user (different day creation vs chat, accounting for late night edge case)
        function isRepeatUser(customer) {
            if (!customer.user_created_at || !customer.datefilter_chat_1st_message_time) {
                return false;
            }
            
            const createdAt = new Date(customer.user_created_at);
            const firstChat = new Date(customer.datefilter_chat_1st_message_time);
            
            // Convert to IST for comparison
            const istCreated = new Date(createdAt.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
            const istChat = new Date(firstChat.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
            
            const createdDay = istCreated.getDate();
            const createdMonth = istCreated.getMonth();
            const createdYear = istCreated.getFullYear();
            const createdHour = istCreated.getHours();
            
            const chatDay = istChat.getDate();
            const chatMonth = istChat.getMonth();
            const chatYear = istChat.getFullYear();
            
            // Same day = not repeat
            if (createdDay === chatDay && createdMonth === chatMonth && createdYear === chatYear) {
                return false;
            }
            
            // Special case: if user created between 11:45 PM and midnight of previous day, don't consider as repeat
            if (createdHour >= 23 && createdHour <= 23 && istCreated.getMinutes() >= 45) {
                const nextDay = new Date(istCreated);
                nextDay.setDate(nextDay.getDate() + 1);
                
                if (nextDay.getDate() === chatDay && 
                    nextDay.getMonth() === chatMonth && 
                    nextDay.getFullYear() === chatYear) {
                    return false;
                }
            }
            
            // Different days = repeat user
            return true;
        }

        // Global function - Open chat in new window
        function viewChat(mobile, agent) {
            const agentParam = agent ? encodeURIComponent(agent) : '';
            const url = `https://instantmechanic.online/inactive-cx.html?mobile=${mobile}&agent=${agentParam}`;
            window.open(url, '_blank');
        }

        // Determine customer journey stage
        function getJourneyStage(customer) {
            const hasBooking = customer.booking_details.length > 0;
            const hasPaidBooking = customer.booking_details.some(b => 
                b.payment_status === 'paid' || b.payment_status === 'partially-paid'
            );
            
            if (hasPaidBooking) {
                return 'payment_done';
            } else if (hasBooking) {
                return 'booking_made';
            } else if (customer.price_shared_with_customer) {
                return 'price_shared';
            } else if (customer.is_location_shared) {
                return 'location_shared';
            } else {
                return 'chat_only';
            }
        }

        // Get journey stage display info
        function getJourneyStageInfo(stage) {
            const stages = {
                'chat_only': { label: 'Chat Started', color: '#6b7280', progress: 1 },
                'location_shared': { label: 'Location Shared', color: '#3b82f6', progress: 2 },
                'price_shared': { label: 'Price Shared', color: '#f59e0b', progress: 3 },
                'booking_made': { label: 'Booking Made', color: '#8b5cf6', progress: 4 },
                'payment_done': { label: 'Payment Done', color: '#10b981', progress: 5 }
            };
            return stages[stage] || stages.chat_only;
        }

        // Fetch data from API
        async function fetchData() {
            try {
                document.getElementById('customersTableBody').innerHTML = 
                    '<tr><td colspan="9" class="loading">üîÑ Loading customer data...</td></tr>';
                
                const dateValue = document.getElementById('dateFilter').value;
                const apiUrl = `https://ai.instantmechanic.online/bot/api/inactive-cx-track?date=${dateValue}`;
                
                console.log('Fetching data for date:', dateValue);
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allCustomers = await response.json();
                console.log('Fetched customers:', allCustomers.length);
                
                // Sort customers by first chat time (latest first)
                allCustomers.sort((a, b) => {
                    const timeA = a.datefilter_chat_1st_message_time ? new Date(a.datefilter_chat_1st_message_time) : new Date(0);
                    const timeB = b.datefilter_chat_1st_message_time ? new Date(b.datefilter_chat_1st_message_time) : new Date(0);
                    return timeB - timeA;
                });
                
                updateAgentFilter();
                applyFilters();
                updateBusinessMetrics();
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('customersTableBody').innerHTML = 
                    `<tr><td colspan="9" style="text-align: center; padding: 40px; color: #ef4444;">
                        ‚ö†Ô∏è Error loading data: ${error.message}
                        <br><small>Please check the date and try again</small>
                    </td></tr>`;
                
                resetMetrics();
            }
        }

        // Update agent filter options
        function updateAgentFilter() {
            const agentFilter = document.getElementById('agentFilter');
            const agents = [...new Set(allCustomers.map(c => c.support_agent).filter(a => a))];
            
            agentFilter.innerHTML = '<option value="">All Agents</option>';
            agents.forEach(agent => {
                agentFilter.innerHTML += `<option value="${agent}">${agent}</option>`;
            });
        }

        // Apply filters
        function applyFilters() {
            const agentFilter = document.getElementById('agentFilter').value;
            const journeyFilter = document.getElementById('journeyFilter').value;
            const responseFilter = document.getElementById('responseFilter').value;
            const carUserFilter = document.getElementById('carUserFilter').value;
            const bookingTypeFilter = document.getElementById('bookingTypeFilter').value;

            filteredCustomers = allCustomers.filter(customer => {
                // Agent filter
                if (agentFilter && customer.support_agent !== agentFilter) return false;

                // Journey stage filter
                if (journeyFilter) {
                    const customerStage = getJourneyStage(customer);
                    if (customerStage !== journeyFilter) return false;
                }

                // Response time filter
                if (responseFilter) {
                    const responseTime = calculateResponseTime(customer);
                    const category = getResponseTimeCategory(responseTime);
                    if (category !== responseFilter) return false;
                }

                // Car user filter
                if (carUserFilter === 'car' && customer.is_not_car_user) return false;
                if (carUserFilter === 'not_car' && !customer.is_not_car_user) return false;
                if (carUserFilter === 'repeat' && !isRepeatUser(customer)) return false;

                // Booking type filter
                if (bookingTypeFilter) {
                    if (bookingTypeFilter === 'None') {
                        // Show only users with no bookings
                        if (customer.booking_details.length > 0) return false;
                    } else if (bookingTypeFilter === 'Manual') {
                        // Show only users with manual bookings
                        if (customer.booking_details.length === 0) return false;
                        const hasManualBooking = customer.booking_details.some(b => b.booking_type === 'Manual');
                        if (!hasManualBooking) return false;
                    } else if (bookingTypeFilter === 'AI') {
                        // Show only users with AI bookings
                        if (customer.booking_details.length === 0) return false;
                        const hasAIBooking = customer.booking_details.some(b => b.booking_type === 'AI');
                        if (!hasAIBooking) return false;
                    }
                }

                return true;
            });

            updateTable();
            updateBusinessMetrics();
        }

        // Update business metrics with corrected cancellation logic
        function updateBusinessMetrics() {
            const total = filteredCustomers.length;
            
            // Journey funnel metrics
            const withLocation = filteredCustomers.filter(c => c.is_location_shared).length;
            const priceShared = filteredCustomers.filter(c => c.price_shared_with_customer).length;
            const hasBookings = filteredCustomers.filter(c => c.booking_details.length > 0).length;
            const hasPaidBookings = filteredCustomers.filter(c => 
                c.booking_details.some(b => b.payment_status === 'paid' || b.payment_status === 'partially-paid')
            ).length;
            
            // Booking metrics - CORRECTED CANCELLATION LOGIC
            const totalBookings = filteredCustomers.reduce((sum, c) => sum + c.booking_details.length, 0);
            const aiBookings = filteredCustomers.reduce((sum, c) => 
                sum + c.booking_details.filter(b => b.booking_type === 'AI').length, 0);
            const manualBookings = filteredCustomers.reduce((sum, c) => 
                sum + c.booking_details.filter(b => b.booking_type === 'Manual').length, 0);
            
            // NEW: Only count customers where ALL bookings are cancelled
            const fullyCancelledUsers = filteredCustomers.filter(c => isFullyCancelled(c)).length;
            
            // Agent response metrics
            const responseTimes = filteredCustomers.map(c => calculateResponseTime(c));
            const validResponseTimes = responseTimes.filter(t => t !== null && t <= 300);
            const avgResponseTime = validResponseTimes.length > 0 ? 
                Math.round(validResponseTimes.reduce((a, b) => a + b, 0) / validResponseTimes.length) : null;
            
            const excellentResponses = responseTimes.filter(t => t !== null && t <= 30).length;
            const contacted = filteredCustomers.filter(c => 
                c.recalls_calls.length > 0 || c.recalls_whatsapp.length > 0
            ).length;
            const noResponse = filteredCustomers.filter(c => {
                const responseTime = calculateResponseTime(c);
                return responseTime === null || responseTime > 300;
            }).length;
            
            // Other metrics
            const repeatUsers = filteredCustomers.filter(c => isRepeatUser(c)).length;
            const nonCarUsers = filteredCustomers.filter(c => c.is_not_car_user).length;
            const avgChatCount = total > 0 ? 
                Math.round(filteredCustomers.reduce((sum, c) => sum + c.chat_count, 0) / total) : 0;
            
            // NEW: Net bookings calculation - count customers with at least one active booking
            const activeBookingUsers = filteredCustomers.filter(c => {
                if (c.booking_details.length === 0) return false;
                return !isFullyCancelled(c); // Has bookings and not fully cancelled
            }).length;

            // Update funnel
            document.getElementById('funnelChat').textContent = total;
            document.getElementById('funnelLocation').textContent = withLocation;
            document.getElementById('funnelLocationPct').textContent = 
                total > 0 ? `(${Math.round((withLocation/total)*100)}%)` : '(0%)';
            document.getElementById('funnelPrice').textContent = priceShared;
            document.getElementById('funnelPricePct').textContent = 
                total > 0 ? `(${Math.round((priceShared/total)*100)}%)` : '(0%)';
            document.getElementById('funnelBooking').textContent = hasBookings;
            document.getElementById('funnelBookingPct').textContent = 
                total > 0 ? `(${Math.round((hasBookings/total)*100)}%)` : '(0%)';
            document.getElementById('funnelPayment').textContent = hasPaidBookings;
            document.getElementById('funnelPaymentPct').textContent = 
                total > 0 ? `(${Math.round((hasPaidBookings/total)*100)}%)` : '(0%)';

            // Update booking performance
            document.getElementById('totalBookings').textContent = totalBookings;
            document.getElementById('aiBookings').textContent = aiBookings;
            document.getElementById('aiBookingsPct').textContent = 
                totalBookings > 0 ? `(${Math.round((aiBookings/totalBookings)*100)}%)` : '(0%)';
            document.getElementById('manualBookings').textContent = manualBookings;
            document.getElementById('manualBookingsPct').textContent = 
                totalBookings > 0 ? `(${Math.round((manualBookings/totalBookings)*100)}%)` : '(0%)';
            document.getElementById('cancelledBookings').textContent = fullyCancelledUsers;
            document.getElementById('cancelledBookingsPct').textContent = 
                hasBookings > 0 ? `(${Math.round((fullyCancelledUsers/hasBookings)*100)}%)` : '(0%)';

            // Update agent performance
            document.getElementById('avgResponseTime').textContent = 
                avgResponseTime !== null ? formatResponseTime(avgResponseTime) : 'No Data';
            document.getElementById('excellentResponse').textContent = excellentResponses;
            document.getElementById('excellentResponsePct').textContent = 
                total > 0 ? `(${Math.round((excellentResponses/total)*100)}%)` : '(0%)';
            document.getElementById('agentContacted').textContent = contacted;
            document.getElementById('agentContactedPct').textContent = 
                total > 0 ? `(${Math.round((contacted/total)*100)}%)` : '(0%)';
            document.getElementById('noResponse').textContent = noResponse;
            document.getElementById('noResponsePct').textContent = 
                total > 0 ? `(${Math.round((noResponse/total)*100)}%)` : '(0%)';

            // Update detailed stats
            document.getElementById('totalCustomers').textContent = total;
            document.getElementById('withLocation').textContent = withLocation;
            document.getElementById('priceShared').textContent = priceShared;
            document.getElementById('hasBookings').textContent = hasBookings;
            document.getElementById('paidCustomers').textContent = hasPaidBookings;
            document.getElementById('repeatUsers').textContent = repeatUsers;
            document.getElementById('nonCarUsers').textContent = nonCarUsers;
            document.getElementById('avgChatPerCustomer').textContent = avgChatCount;
            document.getElementById('cancelledCalls').textContent = fullyCancelledUsers;
            document.getElementById('netBookings').textContent = activeBookingUsers;
            document.getElementById('filteredCount').textContent = total;
        }

        // Reset metrics on error
        function resetMetrics() {
            const elements = [
                'funnelChat', 'funnelLocation', 'funnelPrice', 'funnelBooking', 'funnelPayment',
                'totalBookings', 'aiBookings', 'manualBookings', 'cancelledBookings',
                'avgResponseTime', 'excellentResponse', 'agentContacted', 'noResponse',
                'totalCustomers', 'withLocation', 'priceShared', 'hasBookings', 
                'paidCustomers', 'repeatUsers', 'nonCarUsers', 'avgChatPerCustomer', 
                'cancelledCalls', 'netBookings', 'filteredCount'
            ];
            elements.forEach(id => {
                document.getElementById(id).textContent = '-';
            });
            
            const percentElements = [
                'funnelLocationPct', 'funnelPricePct', 'funnelBookingPct', 'funnelPaymentPct',
                'aiBookingsPct', 'manualBookingsPct', 'cancelledBookingsPct',
                'excellentResponsePct', 'agentContactedPct', 'noResponsePct'
            ];
            percentElements.forEach(id => {
                document.getElementById(id).textContent = '(0%)';
            });
        }

        // Render journey stage
        function renderJourneyStage(customer) {
            const stage = getJourneyStage(customer);
            
            const stages = [
                { key: 'chat_only', label: 'Chat', completed: true },
                { key: 'location_shared', label: 'Location', completed: customer.is_location_shared },
                { key: 'price_shared', label: 'Price', completed: customer.price_shared_with_customer },
                { key: 'booking_made', label: 'Booking', completed: customer.booking_details.length > 0 },
                { key: 'payment_done', label: 'Payment', completed: customer.booking_details.some(b => 
                    b.payment_status === 'paid' || b.payment_status === 'partially-paid'
                )}
            ];
            
            return stages.map(s => {
                const iconClass = s.completed ? 'stage-completed' : 
                                 s.key === stage ? 'stage-pending' : 'stage-skipped';
                const icon = s.completed ? '‚úì' : s.key === stage ? '‚óã' : '‚óã';
                
                return `
                    <div class="stage-item">
                        <div class="stage-icon ${iconClass}">${icon}</div>
                        <span>${s.label}</span>
                    </div>
                `;
            }).join('');
        }

        // Render booking summary with updated cancellation logic
        function renderBookingSummary(customer) {
            if (customer.booking_details.length === 0) {
                return '<span class="badge badge-secondary">No Bookings</span>';
            }
            
            const aiCount = customer.booking_details.filter(b => b.booking_type === 'AI').length;
            const manualCount = customer.booking_details.filter(b => b.booking_type === 'Manual').length;
            const cancelledCount = customer.booking_details.filter(b => b.is_cancelled).length;
            const isFullyCanc = isFullyCancelled(customer);
            
            let html = `<div class="booking-summary">`;
            html += `<div class="booking-count">${customer.booking_details.length} Booking${customer.booking_details.length > 1 ? 's' : ''}</div>`;
            html += `<div class="booking-types">`;
            
            if (aiCount > 0) {
                html += `<span class="booking-type-badge ai-badge">AI: ${aiCount}</span>`;
            }
            if (manualCount > 0) {
                html += `<span class="booking-type-badge manual-badge">Manual: ${manualCount}</span>`;
            }
            if (isFullyCanc) {
                html += `<span class="booking-type-badge badge-danger">All Cancelled</span>`;
            } else if (cancelledCount > 0) {
                html += `<span class="booking-type-badge badge-warning">Partial Cancel: ${cancelledCount}</span>`;
            }
            
            html += `</div></div>`;
            return html;
        }

        // Render response time
        function renderResponseTime(customer) {
            const responseTime = calculateResponseTime(customer);
            const category = getResponseTimeCategory(responseTime);
            const formattedTime = formatResponseTime(responseTime);
            
            return `
                <div class="response-time">
                    <span class="response-badge response-${category}">${formattedTime}</span>
                </div>
            `;
        }

        // Render agent remarks
        function renderAgentRemarks(customer) {
            if (customer.recalls_agent_remarks.length === 0) {
                return '<span class="no-remarks">No remarks</span>';
            }
            
            // Get the latest remark
            const latestRemark = customer.recalls_agent_remarks[customer.recalls_agent_remarks.length - 1];
            
            if (!latestRemark.remarks || latestRemark.remarks.trim() === '') {
                return '<span class="no-remarks">No remarks</span>';
            }
            
            return `
                <div class="remarks-content">
                    "${latestRemark.remarks}"
                </div>
            `;
        }

        // Update table
        function updateTable() {
            const tbody = document.getElementById('customersTableBody');
            
            if (filteredCustomers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="no-data">
                            üì≠ No customers found matching the selected filters
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredCustomers.map(customer => {
                const isRepeat = isRepeatUser(customer);
                
                return `
                    <tr>
                        <td>
                            <div class="customer-info">
                                <div class="customer-name">${customer.name || 'No Name'}</div>
                                <div class="mobile-number">${customer.mobile}</div>
                                <div class="customer-id">ID: ${customer.customer_id}</div>
                                ${isRepeat ? '<div class="repeat-user-badge">REPEAT USER</div>' : ''}
                            </div>
                        </td>
                        <td>
                            <div class="agent-name">${customer.support_agent || 'Not Assigned'}</div>
                            <div class="created-time">${customer.related_team || ''}</div>
                        </td>
                        <td>
                            <div class="journey-stage">
                                ${renderJourneyStage(customer)}
                            </div>
                        </td>
                        <td>
                            ${renderBookingSummary(customer)}
                        </td>
                        <td>
                            ${renderResponseTime(customer)}
                        </td>
                        <td>
                            <div class="agent-remarks">
                                ${renderAgentRemarks(customer)}
                            </div>
                        </td>
                        <td>
                            <div class="chat-metrics">
                                <span class="chat-count">${customer.chat_count}</span>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                                    ${customer.recalls_calls.length > 0 ? 'üìû' : ''} 
                                    ${customer.recalls_whatsapp.length > 0 ? 'üí¨' : ''}
                                    ${customer.recalls_agent_remarks.length > 0 ? 'üìù' : ''}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="created-time">
                                ${customer.datefilter_chat_1st_message_time ? 
                                    new Date(customer.datefilter_chat_1st_message_time).toLocaleTimeString('en-IN', {
                                        hour: '2-digit', 
                                        minute: '2-digit', 
                                        timeZone: 'Asia/Kolkata'
                                    }) : 'No Chat'}
                                <br>
                                <small>${customer.datefilter_chat_1st_message_time ? 
                                    new Date(customer.datefilter_chat_1st_message_time).toLocaleDateString('en-IN', {
                                        timeZone: 'Asia/Kolkata'
                                    }) : ''}</small>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" 
                                onclick="viewChat('${customer.mobile}', '${customer.support_agent || ''}')">
                                üí¨ Chat
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Export to CSV with updated cancellation logic
        function exportCSV() {
            const headers = [
                'Customer ID', 'Name', 'Mobile', 'Agent', 'Team', 'Journey Stage', 'Is Repeat User',
                'Location Shared', 'Price Shared', 'Total Bookings', 'AI Bookings', 'Manual Bookings',
                'Fully Cancelled', 'Partial Cancellations', 'User Type', 'Response Time (s)', 'Response Category', 
                'Chat Count', 'Calls', 'WhatsApp', 'Agent Remarks', 'First Chat Time', 'Created At'
            ];
            
            const rows = filteredCustomers.map(customer => {
                const stage = getJourneyStage(customer);
                const aiBookings = customer.booking_details.filter(b => b.booking_type === 'AI').length;
                const manualBookings = customer.booking_details.filter(b => b.booking_type === 'Manual').length;
                const responseTime = calculateResponseTime(customer);
                const responseCategory = getResponseTimeCategory(responseTime);
                const latestRemark = customer.recalls_agent_remarks.length > 0 ? 
                    customer.recalls_agent_remarks[customer.recalls_agent_remarks.length - 1].remarks || 'No remarks' : 'No remarks';
                
                const cancelledCount = customer.booking_details.filter(b => b.is_cancelled).length;
                const isFullyCanc = isFullyCancelled(customer);
                
                return [
                    customer.customer_id,
                    customer.name || 'No Name',
                    customer.mobile,
                    customer.support_agent || 'Not Assigned',
                    customer.related_team || '',
                    getJourneyStageInfo(stage).label,
                    isRepeatUser(customer) ? 'Yes' : 'No',
                    customer.is_location_shared ? 'Yes' : 'No',
                    customer.price_shared_with_customer ? 'Yes' : 'No',
                    customer.booking_details.length,
                    aiBookings,
                    manualBookings,
                    isFullyCanc ? 'Yes' : 'No',
                    cancelledCount,
                    customer.is_not_car_user ? 'Non-Car User' : 'Car User',
                    responseTime || 'No Response',
                    responseCategory,
                    customer.chat_count,
                    customer.recalls_calls.length,
                    customer.recalls_whatsapp.length,
                    latestRemark,
                    customer.datefilter_chat_1st_message_time || 'No Chat',
                    customer.user_created_at
                ];
            });
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customer-journey-${document.getElementById('dateFilter').value}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('dateFilter').addEventListener('change', fetchData);
        document.getElementById('agentFilter').addEventListener('change', applyFilters);
        document.getElementById('journeyFilter').addEventListener('change', applyFilters);
        document.getElementById('responseFilter').addEventListener('change', applyFilters);
        document.getElementById('carUserFilter').addEventListener('change', applyFilters);
        document.getElementById('bookingTypeFilter').addEventListener('change', applyFilters);

        // Initialize and load data
        document.addEventListener('DOMContentLoaded', function() {
            initializeBusinessOverview();
            fetchData();
        });
    </script>
</body>
</html>

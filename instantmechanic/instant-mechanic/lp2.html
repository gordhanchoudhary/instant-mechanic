<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Instant Mechanic ‚Äì Hourly Business Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Data labels plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --info-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      --danger-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
      
      --text-primary: #1a202c;
      --text-secondary: #718096;
      --text-muted: #a0aec0;
      --border-color: #e2e8f0;
      --bg-primary: #ffffff;
      --bg-secondary: #f7fafc;
      --bg-accent: #edf2f7;
      
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--text-primary);
      font-weight: 400;
      line-height: 1.6;
    }

    .page {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header Section */
    .header-section {
      text-align: center;
      margin-bottom: 32px;
      color: white;
    }

    .main-title {
      font-size: clamp(28px, 4vw, 42px);
      font-weight: 800;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 16px;
      opacity: 0.9;
      font-weight: 500;
      margin-bottom: 24px;
    }

    /* Controls Section */
    .controls-section {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 32px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .date-picker-container {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.2);
      padding: 12px 20px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .date-picker-container label {
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .date-picker-container input[type="date"] {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      backdrop-filter: blur(10px);
    }

    #dateInfo {
      color: white;
      font-weight: 500;
      font-size: 14px;
      opacity: 0.9;
    }

    /* Summary Cards */
    .summary-section {
      margin-bottom: 40px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin: 0;
    }

    .section-icon {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .summary-card {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .summary-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
    }

    .summary-card:nth-child(1)::before { background: var(--primary-gradient); }
    .summary-card:nth-child(2)::before { background: var(--success-gradient); }
    .summary-card:nth-child(3)::before { background: var(--warning-gradient); }
    .summary-card:nth-child(4)::before { background: var(--info-gradient); }
    .summary-card:nth-child(5)::before { background: var(--secondary-gradient); }
    .summary-card:nth-child(6)::before { background: var(--danger-gradient); }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .summary-card:nth-child(1) .card-icon { background: var(--primary-gradient); }
    .summary-card:nth-child(2) .card-icon { background: var(--success-gradient); }
    .summary-card:nth-child(3) .card-icon { background: var(--warning-gradient); }
    .summary-card:nth-child(4) .card-icon { background: var(--info-gradient); }
    .summary-card:nth-child(5) .card-icon { background: var(--secondary-gradient); }
    .summary-card:nth-child(6) .card-icon { background: var(--danger-gradient); }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
      margin-bottom: 12px;
    }

    .card-values {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    /* Main Content */
    .main-content {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: 32px;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-color);
    }

    .charts-section {
      margin-bottom: 40px;
    }

    .charts-section:last-child {
      margin-bottom: 0;
    }

    .charts-section .section-header {
      margin-bottom: 24px;
    }

    .charts-section .section-title {
      color: var(--text-primary);
    }

    .charts-section .section-icon {
      background: var(--primary-gradient);
    }

    /* Chart Grid Layouts */
    .chart-grid-2x2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 24px;
    }

    .chart-grid-1x1 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    .chart-card {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      height: 400px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .chart-card:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-xl);
    }

    .chart-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary-gradient);
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .chart-badge {
      background: var(--primary-gradient);
      color: white;
      padding: 4px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
    }

    .chart-container {
      flex: 1;
      position: relative;
      margin-top: 8px;
    }

    .chart-container canvas {
      border-radius: var(--radius-sm);
    }

    /* Footer */
    .dashboard-footer {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-md);
      padding: 16px 24px;
      margin-top: 32px;
      text-align: center;
    }

    .footer-text {
      color: white;
      font-size: 13px;
      font-weight: 500;
      opacity: 0.9;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .page {
        padding: 16px;
      }

      .summary-grid {
        grid-template-columns: 1fr;
      }

      .chart-grid-2x2 {
        grid-template-columns: 1fr;
      }

      .main-content {
        padding: 20px;
      }

      .controls-section {
        flex-direction: column;
        align-items: stretch;
      }

      .date-picker-container {
        justify-content: center;
      }

      .main-title {
        font-size: 32px;
      }
    }

    @media (max-width: 480px) {
      .chart-grid-2x2 {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .chart-card {
        height: 320px;
        padding: 16px;
      }

      .summary-card {
        padding: 16px;
      }
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Status Indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
    }

    .status-success {
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .status-error {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* Pulse effect for real-time updates */
    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Header Section -->
    <div class="header-section">
      <h1 class="main-title">Instant Mechanic</h1>
      <div class="subtitle">
        üìä Hourly Business Dashboard &nbsp;‚Ä¢&nbsp; Bars = Hour-wise Performance &nbsp;‚Ä¢&nbsp; Lines = Cumulative Growth
      </div>
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
      <div class="date-picker-container">
        <label for="datePicker">üìÖ Select Date:</label>
        <input type="date" id="datePicker" />
      </div>
      <div id="dateInfo" class="status-indicator status-success">
        <div class="loading" id="loadingIndicator" style="display: none;"></div>
        <span id="dateText">Loading data...</span>
      </div>
    </div>

    <!-- Summary Cards Section -->
    <div class="summary-section">
      <div class="section-header">
        <div class="section-icon">
          <i data-lucide="trending-up"></i>
        </div>
        <h2 class="section-title">Key Performance Metrics</h2>
      </div>
      
      <div class="summary-grid">
        <div class="summary-card">
          <div class="card-header">
            <div class="card-title">Total Spend</div>
            <div class="card-icon">
              <i data-lucide="credit-card"></i>
            </div>
          </div>
          <div class="card-subtitle">Cumulative ad spend at 2nd, 5th, 10th, 17th, 23rd hour</div>
          <div class="card-values" id="summarySpend">Loading...</div>
        </div>

        <div class="summary-card">
          <div class="card-header">
            <div class="card-title">Total Revenue</div>
            <div class="card-icon">
              <i data-lucide="dollar-sign"></i>
            </div>
          </div>
          <div class="card-subtitle">Cumulative revenue at 2nd, 5th, 10th, 17th, 23rd hour</div>
          <div class="card-values" id="summaryRevenue">Loading...</div>
        </div>

        <div class="summary-card">
          <div class="card-header">
            <div class="card-title">Avg Cost Per Customer</div>
            <div class="card-icon">
              <i data-lucide="user-plus"></i>
            </div>
          </div>
          <div class="card-subtitle">Average customer acquisition cost by hour</div>
          <div class="card-values" id="summaryCPCust">Loading...</div>
        </div>

        <div class="summary-card">
          <div class="card-header">
            <div class="card-title">Avg Cost Per Booking</div>
            <div class="card-icon">
              <i data-lucide="calendar-check"></i>
            </div>
          </div>
          <div class="card-subtitle">Average booking acquisition cost by hour</div>
          <div class="card-values" id="summaryCPBook">Loading...</div>
        </div>

        <div class="summary-card">
          <div class="card-header">
            <div class="card-title">Return on Ad Spend</div>
            <div class="card-icon">
              <i data-lucide="target"></i>
            </div>
          </div>
          <div class="card-subtitle">Revenue multiplier for each rupee spent</div>
          <div class="card-values" id="summaryROAS">Loading...</div>
        </div>

        <div class="summary-card">
          <div class="card-header">
            <div class="card-title">Conversion Metrics</div>
            <div class="card-icon">
              <i data-lucide="activity"></i>
            </div>
          </div>
          <div class="card-subtitle">Customer, booking & cancellation insights</div>
          <div class="card-values" id="summaryTotals">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Core Metrics Section -->
      <div class="charts-section">
        <div class="section-header">
          <div class="section-icon">
            <i data-lucide="bar-chart-3"></i>
          </div>
          <h2 class="section-title">Core Business Metrics</h2>
        </div>
        
        <div class="chart-grid-2x2">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Customer Acquisition</h3>
              <div class="chart-badge">Hourly + Cumulative</div>
            </div>
            <div class="chart-container">
              <canvas id="customersChart"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Revenue Generation</h3>
              <div class="chart-badge">‚Çπ Performance</div>
            </div>
            <div class="chart-container">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Service Bookings</h3>
              <div class="chart-badge">Conversion Track</div>
            </div>
            <div class="chart-container">
              <canvas id="bookingsChart"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Cancelled Bookings</h3>
              <div class="chart-badge">Loss Prevention</div>
            </div>
            <div class="chart-container">
              <canvas id="cancelledChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced Analytics Section -->
      <div class="charts-section">
        <div class="section-header">
          <div class="section-icon">
            <i data-lucide="trending-up"></i>
          </div>
          <h2 class="section-title">Advanced Performance Analytics</h2>
        </div>
        
        <div class="chart-grid-1x1">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Customer Conversion Analysis</h3>
              <div class="chart-badge">Efficiency Metrics</div>
            </div>
            <div class="chart-container">
              <canvas id="graph5"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Ad Spend vs Customer Acquisition</h3>
              <div class="chart-badge">ROI Analysis</div>
            </div>
            <div class="chart-container">
              <canvas id="graph6"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Ad Spend vs Booking Performance</h3>
              <div class="chart-badge">Cost Efficiency</div>
            </div>
            <div class="chart-container">
              <canvas id="graph7"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Revenue vs Spend Performance</h3>
              <div class="chart-badge">ROAS Tracking</div>
            </div>
            <div class="chart-container">
              <canvas id="graph8"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="dashboard-footer">
      <div class="footer-text" id="lastUpdated">
        üîÑ Loading dashboard data...
      </div>
    </div>
  </div>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();
    
    Chart.register(ChartDataLabels);

    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGlnFKI4M5RKKbU-DVD2ZMvXmcWXrCbn66l5j-0xnsJrMlAgQrUUNleVkZylxUaXLuEVeA6jeBSs_0/pub?gid=1708068657&single=true&output=csv";

    let allRows = [];
    let availableDates = [];
    let latestDateKey = null;
    let selectedDateKey = null;
    const charts = {};

    const summarySpendEl   = document.getElementById("summarySpend");
    const summaryRevenueEl = document.getElementById("summaryRevenue");
    const summaryCPCustEl  = document.getElementById("summaryCPCust");
    const summaryCPBookEl  = document.getElementById("summaryCPBook");
    const summaryROASEl    = document.getElementById("summaryROAS");
    const summaryTotalsEl  = document.getElementById("summaryTotals");

    // Enhanced color schemes for better visualization
    const colorSchemes = {
      primary: {
        bar: 'rgba(102, 126, 234, 0.8)',
        barBorder: 'rgba(102, 126, 234, 1)',
        line: 'rgba(239, 68, 68, 1)',
        gradient: 'rgba(102, 126, 234, 0.1)'
      },
      success: {
        bar: 'rgba(34, 197, 94, 0.8)',
        barBorder: 'rgba(34, 197, 94, 1)',
        line: 'rgba(249, 115, 22, 1)',
        gradient: 'rgba(34, 197, 94, 0.1)'
      },
      warning: {
        bar: 'rgba(251, 191, 36, 0.8)',
        barBorder: 'rgba(251, 191, 36, 1)',
        line: 'rgba(168, 85, 247, 1)',
        gradient: 'rgba(251, 191, 36, 0.1)'
      },
      info: {
        bar: 'rgba(59, 130, 246, 0.8)',
        barBorder: 'rgba(59, 130, 246, 1)',
        line: 'rgba(236, 72, 153, 1)',
        gradient: 'rgba(59, 130, 246, 0.1)'
      }
    };

    function getTodayKey() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm   = String(today.getMonth() + 1).padStart(2, "0");
      const dd   = String(today.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function parseIndianDateAndKey(str) {
      const [d, m, y] = str.split("-").map(Number);
      const dateObj = new Date(y, m - 1, d);
      const dateKey = `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      return { dateObj, dateKey };
    }

    function parseCsv(text) {
      const rows = text.trim().split("\n").map(r => r.split(","));
      const header = rows[0].map(h => h.trim());

      const idxDate   = header.indexOf("date");
      const idxTime   = header.indexOf("Time");
      const idxCust   = header.indexOf("total_customers");
      const idxRev    = header.indexOf("total_revenue");
      const idxBook   = header.indexOf("total_booking");
      const idxCancel = header.indexOf("total_cancelled_booking");
      const idxSpend  = header.indexOf("total_spend");

      if (idxDate === -1 || idxTime === -1 || idxCust === -1 ||
          idxRev === -1 || idxBook === -1 || idxCancel === -1 || idxSpend === -1) {
        alert("Missing columns. Required: date, Time, total_customers, total_revenue, total_booking, total_cancelled_booking, total_spend");
        return null;
      }

      const data = rows.slice(1).map(r => {
        const { dateObj, dateKey } = parseIndianDateAndKey(r[idxDate]);
        const timeRaw = r[idxTime] || "00:00:00";
        const hourStr = timeRaw.split(":")[0];
        const hour = Number(hourStr);

        return {
          dateObj,
          dateKey,
          hour,
          total_customers: Number(r[idxCust] || 0),
          total_revenue: Number(r[idxRev] || 0),
          total_booking: Number(r[idxBook] || 0),
          total_cancelled: Number(r[idxCancel] || 0),
          total_spend: Number(r[idxSpend] || 0)
        };
      });

      if (!data.length) return null;

      const dateSet = new Set(data.map(r => r.dateKey));
      const dateList = Array.from(dateSet).sort();
      const lastDateKey = dateList[dateList.length - 1];

      return { rows: data, dateKeys: dateList, latestDateKey: lastDateKey };
    }

    function computeSeries(rows, key) {
      const cumulative = [];
      const hourly = [];
      rows.forEach((row, i) => {
        const value = row[key];
        cumulative.push(value);
        hourly.push(i === 0 ? value : value - rows[i-1][key]);
      });
      return { cumulative, hourly };
    }

    function createOrUpdateChart(id, config) {
      const ctx = document.getElementById(id).getContext("2d");
      if (charts[id]) {
        charts[id].data = config.data;
        charts[id].options = config.options;
        charts[id].update();
      } else {
        charts[id] = new Chart(ctx, config);
      }
    }

    function createEnhancedChartOptions(title, yAxisLabel) {
      return {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { 
          mode: "index", 
          intersect: false,
          animationDuration: 300
        },
        animation: {
          duration: 1000,
          easing: 'easeInOutQuart'
        },
        plugins: {
          legend: { 
            position: "bottom", 
            labels: { 
              boxWidth: 16, 
              font: { 
                size: 12,
                weight: '600'
              },
              padding: 20,
              usePointStyle: true,
              pointStyle: 'circle'
            } 
          },
          datalabels: {
            color: '#374151',
            font: { 
              size: 10, 
              weight: "600" 
            },
            clamp: true,
            clip: false,
            backgroundColor: 'rgba(255, 255, 255, 0.8)',
            borderColor: 'rgba(0, 0, 0, 0.1)',
            borderWidth: 1,
            borderRadius: 4,
            padding: 4
          },
          tooltip: {
            backgroundColor: 'rgba(17, 24, 39, 0.95)',
            titleColor: 'rgba(255, 255, 255, 1)',
            bodyColor: 'rgba(255, 255, 255, 0.9)',
            borderColor: 'rgba(75, 85, 99, 0.2)',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 },
            callbacks: {
              label: function(ctx) {
                const v = ctx.parsed.y ?? 0;
                const prefix = ctx.dataset.label.includes('‚Çπ') || ctx.dataset.label.includes('Revenue') || ctx.dataset.label.includes('Spend') || ctx.dataset.label.includes('Cost') ? '‚Çπ' : '';
                const suffix = ctx.dataset.label.includes('%') || ctx.dataset.label.includes('Rate') ? '%' : '';
                const multiplier = ctx.dataset.label.includes('ROAS') ? 'x' : '';
                return `${ctx.dataset.label}: ${prefix}${v.toLocaleString("en-IN")}${suffix}${multiplier}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: { 
              display: true, 
              text: "Hour of Day", 
              font: { 
                size: 13,
                weight: '600' 
              },
              color: '#374151'
            },
            ticks: { 
              autoSkip: false, 
              font: { 
                size: 11,
                weight: '500'
              },
              color: '#6B7280'
            },
            grid: {
              color: 'rgba(229, 231, 235, 0.8)',
              lineWidth: 1
            }
          },
          y: {
            beginAtZero: true,
            title: { 
              display: !!yAxisLabel, 
              text: yAxisLabel,
              font: { 
                size: 13,
                weight: '600' 
              },
              color: '#374151'
            },
            ticks: {
              font: { 
                size: 11,
                weight: '500'
              },
              color: '#6B7280'
            },
            grid: {
              color: 'rgba(229, 231, 235, 0.5)',
              lineWidth: 1
            }
          }
        }
      };
    }

    function updateSummaryCards(hours, customers, revenue, bookings, spend, cancelled) {
      const checkpoints = [2, 5, 10, 17, 23];
      const fmtMoney = v => "‚Çπ" + Math.round(v).toLocaleString("en-IN");
      const fmtMoney0 = v => "‚Çπ" + (v || 0).toFixed(0);
      const fmtRoas = v => (v && v > 0 ? v.toFixed(1) + "x" : "‚Äî");

      if (!hours.length) {
        ["summarySpend", "summaryRevenue", "summaryCPCust", "summaryCPBook", "summaryROAS", "summaryTotals"].forEach(id => {
          document.getElementById(id).innerHTML = '<div class="status-indicator status-error">üìä No data available</div>';
        });
        return;
      }

      const linesSpend   = [];
      const linesRevenue = [];
      const linesCPCust  = [];
      const linesCPBook  = [];
      const linesROAS    = [];
      const linesTotals  = [];

      checkpoints.forEach(h => {
        const label = h + "h";
        const idx = hours.indexOf(h);

        if (idx === -1) {
          [linesSpend, linesRevenue, linesCPCust, linesCPBook, linesROAS, linesTotals].forEach(arr => {
            arr.push(`<span style="opacity: 0.5">${label} ‚Üí ‚Äî</span>`);
          });
          return;
        }

        const cumSpend    = spend.cumulative[idx];
        const cumRevenue  = revenue.cumulative[idx];
        const cumCust     = customers.cumulative[idx];
        const cumBook     = bookings.cumulative[idx];
        const cumCancel   = cancelled.cumulative[idx];

        const avgCPCust   = cumCust > 0 ? cumSpend / cumCust : 0;
        const avgCPBook   = cumBook > 0 ? cumSpend / cumBook : 0;
        const roas        = cumSpend > 0 ? cumRevenue / cumSpend : 0;
        const conv        = (cumCust > 0) ? (cumBook / cumCust) * 100 : null;
        const cancelRate  = (cumBook > 0) ? (cumCancel / cumBook) * 100 : null;
        const convStr     = conv !== null ? conv.toFixed(1) + "%" : "‚Äî";
        const cancelStr   = cancelRate !== null ? cancelRate.toFixed(1) + "%" : "‚Äî";

        linesSpend.push(`<strong>${label}</strong> ‚Üí ${fmtMoney(cumSpend)}`);
        linesRevenue.push(`<strong>${label}</strong> ‚Üí ${fmtMoney(cumRevenue)}`);
        linesCPCust.push(`<strong>${label}</strong> ‚Üí ${fmtMoney0(avgCPCust)}`);
        linesCPBook.push(`<strong>${label}</strong> ‚Üí ${fmtMoney0(avgCPBook)}`);
        linesROAS.push(`<strong>${label}</strong> ‚Üí <span style="color: ${roas > 1 ? '#16a34a' : roas > 0.5 ? '#ea580c' : '#dc2626'}">${fmtRoas(roas)}</span>`);
        linesTotals.push(
          `<strong>${label}</strong> ‚Üí ${cumCust.toLocaleString("en-IN")} üë•, ` +
          `${cumBook.toLocaleString("en-IN")} üìÖ (${convStr}), ` +
          `${cumCancel.toLocaleString("en-IN")} ‚ùå (${cancelStr})`
        );
      });

      summarySpendEl.innerHTML   = linesSpend.join("<br>");
      summaryRevenueEl.innerHTML = linesRevenue.join("<br>");
      summaryCPCustEl.innerHTML  = linesCPCust.join("<br>");
      summaryCPBookEl.innerHTML  = linesCPBook.join("<br>");
      summaryROASEl.innerHTML    = linesROAS.join("<br>");
      summaryTotalsEl.innerHTML  = linesTotals.join("<br>");
    }

    function renderDashboardForDate(dateKey) {
      if (!allRows.length) return;

      const rows = allRows
        .filter(r => r.dateKey === dateKey)
        .sort((a, b) => a.hour - b.hour);

      const dateInfo = document.getElementById("dateText");
      if (!rows.length) {
        dateInfo.textContent = "No data available for this date";
        dateInfo.className = "status-indicator status-error";
        Object.values(charts).forEach(ch => {
          ch.data.labels = [];
          ch.data.datasets.forEach(d => d.data = []);
          ch.update();
        });
        ["summarySpend", "summaryRevenue", "summaryCPCust", "summaryCPBook", "summaryROAS", "summaryTotals"].forEach(id => {
          document.getElementById(id).innerHTML = '<div class="status-indicator status-error">üìä No data available</div>';
        });
        return;
      }

      const hours = rows.map(r => r.hour);

      const customers = computeSeries(rows, "total_customers");
      const revenue   = computeSeries(rows, "total_revenue");
      const bookings  = computeSeries(rows, "total_booking");
      const cancelled = computeSeries(rows, "total_cancelled");
      const spend     = computeSeries(rows, "total_spend");

      const hourlyCustomers = customers.hourly;
      const hourlyRevenue   = revenue.hourly;
      const hourlyBookings  = bookings.hourly;
      const hourlyCancelled = cancelled.hourly;
      const hourlySpend     = spend.hourly;

      updateSummaryCards(hours, customers, revenue, bookings, spend, cancelled);

      const conversionRate = hourlyCustomers.map((c, i) =>
        c > 0 ? (hourlyBookings[i] / c) * 100 : 0
      );
      const costPerCustomer = hourlyCustomers.map((c, i) =>
        c > 0 ? hourlySpend[i] / c : 0
      );
      const costPerBooking = hourlyBookings.map((b, i) =>
        b > 0 ? hourlySpend[i] / b : 0
      );
      const roas = hourlySpend.map((s, i) =>
        s > 0 ? (hourlyRevenue[i] / s) : 0
      );

      // Customer Chart
      createOrUpdateChart("customersChart", {
        type: "bar",
        data: {
          labels: hours.map(h => h + "h"),
          datasets: [
            {
              type: "bar",
              label: "Hourly Customers",
              data: hourlyCustomers,
              backgroundColor: colorSchemes.primary.bar,
              borderColor: colorSchemes.primary.barBorder,
              borderWidth: 2,
              borderRadius: 6,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "line",
              label: "Cumulative Customers",
              data: customers.cumulative,
              borderColor: colorSchemes.primary.line,
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 8,
              pointBackgroundColor: '#fff',
              pointBorderColor: colorSchemes.primary.line,
              pointBorderWidth: 3,
              fill: true,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            }
          ]
        },
        options: createEnhancedChartOptions("Customer Acquisition", "Number of Customers")
      });

      // Revenue Chart
      createOrUpdateChart("revenueChart", {
        type: "bar",
        data: {
          labels: hours.map(h => h + "h"),
          datasets: [
            {
              type: "bar",
              label: "Hourly Revenue (‚Çπ)",
              data: hourlyRevenue,
              backgroundColor: colorSchemes.success.bar,
              borderColor: colorSchemes.success.barBorder,
              borderWidth: 2,
              borderRadius: 6,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => v ? "‚Çπ" + v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "line",
              label: "Cumulative Revenue (‚Çπ)",
              data: revenue.cumulative,
              borderColor: colorSchemes.success.line,
              backgroundColor: 'rgba(249, 115, 22, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 8,
              pointBackgroundColor: '#fff',
              pointBorderColor: colorSchemes.success.line,
              pointBorderWidth: 3,
              fill: true,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => v ? "‚Çπ" + v.toLocaleString("en-IN") : ""
              }
            }
          ]
        },
        options: createEnhancedChartOptions("Revenue Generation", "Revenue (‚Çπ)")
      });

      // Bookings Chart
      createOrUpdateChart("bookingsChart", {
        type: "bar",
        data: {
          labels: hours.map(h => h + "h"),
          datasets: [
            {
              type: "bar",
              label: "Hourly Bookings",
              data: hourlyBookings,
              backgroundColor: colorSchemes.warning.bar,
              borderColor: colorSchemes.warning.barBorder,
              borderWidth: 2,
              borderRadius: 6,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "line",
              label: "Cumulative Bookings",
              data: bookings.cumulative,
              borderColor: colorSchemes.warning.line,
              backgroundColor: 'rgba(168, 85, 247, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 8,
              pointBackgroundColor: '#fff',
              pointBorderColor: colorSchemes.warning.line,
              pointBorderWidth: 3,
              fill: true,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            }
          ]
        },
        options: createEnhancedChartOptions("Service Bookings", "Number of Bookings")
      });

      // Cancelled Bookings Chart
      createOrUpdateChart("cancelledChart", {
        type: "bar",
        data: {
          labels: hours.map(h => h + "h"),
          datasets: [
            {
              type: "bar",
              label: "Hourly Cancelled",
              data: hourlyCancelled,
              backgroundColor: colorSchemes.info.bar,
              borderColor: colorSchemes.info.barBorder,
              borderWidth: 2,
              borderRadius: 6,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "line",
              label: "Cumulative Cancelled",
              data: cancelled.cumulative,
              borderColor: colorSchemes.info.line,
              backgroundColor: 'rgba(236, 72, 153, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 8,
              pointBackgroundColor: '#fff',
              pointBorderColor: colorSchemes.info.line,
              pointBorderWidth: 3,
              fill: true,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            }
          ]
        },
        options: createEnhancedChartOptions("Cancelled Bookings", "Number of Cancellations")
      });

      // Graph 5 - Conversion Analysis
      createOrUpdateChart("graph5", {
        type: "bar",
        data: {
          labels: hours.map(h => h + "h"),
          datasets: [
            {
              type: "bar",
              label: "Hourly Customers",
              data: hourlyCustomers,
              backgroundColor: "rgba(99, 102, 241, 0.8)",
              borderColor: "rgba(99, 102, 241, 1)",
              borderWidth: 2,
              borderRadius: 6,
              datalabels: {
                anchor: "end", align: "top",
                formatter: v => v ? v : ""
              }
            },
            {
              type: "bar",
              label: "Hourly Bookings",
              data: hourlyBookings,
              backgroundColor: "rgba(245, 158, 11, 0.8)",
              borderColor: "rgba(245, 158, 11, 1)",
              borderWidth: 2,
              borderRadius: 6,
              datalabels: {
                anchor: "end", align: "top",
                formatter: v => v ? v : ""
              }
            },
            {
              type: "line",
              label: "Conversion Rate (%)",
              data: conversionRate,
              borderColor: "rgba(239, 68, 68, 1)",
              backgroundColor: "rgba(239, 68, 68, 0.1)",
              borderWidth: 4,
              yAxisID: "y1",
              tension: 0.4,
              pointRadius: 6,
              pointHoverRadius: 10,
              pointBackgroundColor: '#fff',
              pointBorderColor: "rgba(239, 68, 68, 1)",
              pointBorderWidth: 3,
              fill: true,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => v > 0 ? v.toFixed(1) + "%" : ""
              }
            }
          ]
        },
        options: {
          ...createEnhancedChartOptions("Conversion Analysis", "Customers / Bookings"),
          scales: {
            ...createEnhancedChartOptions("Conversion Analysis", "Customers / Bookings").scales,
            y1: {
              position: "right",
              beginAtZero: true,
              title: { 
                display: true, 
                text: "Conversion Rate (%)",
                font: { size: 13, weight: '600' },
                color: '#374151'
              },
              grid: { drawOnChartArea: false },
              ticks: {
                font: { size: 11, weight: '500' },
                color: '#6B7280'
              }
            }
          }
        }
      });

      // Graph 6 - Customer Acquisition Cost
      createOrUpdateChart("graph6", {
        type: "bar",
        data: {
          labels: hours.map(h => h + "h"),
          datasets: [
            {
              type: "bar",
              label: "Hourly Ad Spend (‚Çπ)",
              data: hourlySpend,
              backgroundColor: "rgba(239, 68, 68, 0.8)",
              borderColor: "rgba(239, 68, 68, 1)",
              borderWidth: 2,
              borderRadius: 6,
              datalabels: {
                anchor: "end", align: "top",
                formatter: v => v ? "‚Çπ" + v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "bar",
              label: "Hourly Customers",
              data: hourlyCustomers,
              backgroundColor: "rgba(99, 102, 241, 0.8)",
              borderColor: "rgba(99, 102, 241, 1)",
              borderWidth: 2,
              borderRadius: 6,
              datalabels: {
                anchor: "end", align: "top",
                formatter: v => v ? v : ""
              }
            },
            {
              type: "line",
              label: "Cost per Customer (‚Çπ)",
              data: costPerCustomer,
              borderColor: "rgba(34, 197, 94, 1)",
              backgroundColor: "rgba(34, 197, 94, 0.1)",
              borderWidth: 4,
              yAxisID: "y1",
              tension: 0.4,
              pointRadius: 6,
              pointHoverRadius: 10,
              pointBackgroundColor: '#fff',
              pointBorderColor: "rgba(34, 197, 94, 1)",
              pointBorderWidth: 3,
              fill: true,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => v > 0 ? "‚Çπ" + v.toFixed(0) : ""
              }
            }
          ]
        },
        options: {
          ...createEnhancedChartOptions("Customer Acquisition Cost", "Spend (‚Çπ) / Customers"),
          scales: {
            ...createEnhancedChartOptions("Customer Acquisition Cost", "Spend (‚Çπ) / Customers").scales,
            y1: {
              position: "right",
              beginAtZero: true,
              title: { 
                display: true, 
                text: "Cost per Customer (‚Çπ)",
                font: { size: 13, weight: '600' },
                color: '#374151'
              },
              grid: { drawOnChartArea: false },
              ticks: {
                font: { size: 11, weight: '500' },
                color: '#6B7280'
              }
            }
          }
        }
      });

      // Graph 7 - Booking Acquisition Cost
      createOrUpdateChart("graph7", {
        type: "bar",
        data: {
          labels: hours.map(h => h + "h"),
          datasets: [
            {
              type: "bar",
              label: "Hourly Bookings",
              data: hourlyBookings,
              backgroundColor: "rgba(99, 102, 241, 0.8)",
              borderColor: "rgba(99, 102, 241, 1)",
              borderWidth: 2,
              borderRadius: 6,
              datalabels: {
                anchor: "end", align: "top",
                formatter: v => v ? v : ""
              }
            },
            {
              type: "bar",
              label: "Hourly Ad Spend (‚Çπ)",
              data: hourlySpend,
              backgroundColor: "rgba(239, 68, 68, 0.8)",
              borderColor: "rgba(239, 68, 68, 1)",
              borderWidth: 2,
              borderRadius: 6,
              datalabels: {
                anchor: "end", align: "top",
                formatter: v => v ? "‚Çπ" + v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "line",
              label: "Cost per Booking (‚Çπ)",
              data: costPerBooking,
              borderColor: "rgba(34, 197, 94, 1)",
              backgroundColor: "rgba(34, 197, 94, 0.1)",
              borderWidth: 4,
              yAxisID: "y1",
              tension: 0.4,
              pointRadius: 6,
              pointHoverRadius: 10,
              pointBackgroundColor: '#fff',
              pointBorderColor: "rgba(34, 197, 94, 1)",
              pointBorderWidth: 3,
              fill: true,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => v > 0 ? "‚Çπ" + v.toFixed(0) : ""
              }
            }
          ]
        },
        options: {
          ...createEnhancedChartOptions("Booking Acquisition Cost", "Bookings / Spend (‚Çπ)"),
          scales: {
            ...createEnhancedChartOptions("Booking Acquisition Cost", "Bookings / Spend (‚Çπ)").scales,
            y1: {
              position: "right",
              beginAtZero: true,
              title: { 
                display: true, 
                text: "Cost per Booking (‚Çπ)",
                font: { size: 13, weight: '600' },
                color: '#374151'
              },
              grid: { drawOnChartArea: false },
              ticks: {
                font: { size: 11, weight: '500' },
                color: '#6B7280'
              }
            }
          }
        }
      });

      // Graph 8 - ROAS Analysis
      createOrUpdateChart("graph8", {
        type: "bar",
        data: {
          labels: hours.map(h => h + "h"),
          datasets: [
            {
              type: "bar",
              label: "Hourly Revenue (‚Çπ)",
              data: hourlyRevenue,
              backgroundColor: "rgba(99, 102, 241, 0.8)",
              borderColor: "rgba(99, 102, 241, 1)",
              borderWidth: 2,
              borderRadius: 6,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => v ? "‚Çπ" + v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "bar",
              label: "Hourly Ad Spend (‚Çπ)",
              data: hourlySpend,
              backgroundColor: "rgba(239, 68, 68, 0.8)",
              borderColor: "rgba(239, 68, 68, 1)",
              borderWidth: 2,
              borderRadius: 6,
              datalabels: {
                display: false
              }
            },
            {
              type: "line",
              label: "ROAS (x)",
              data: roas,
              borderColor: "rgba(34, 197, 94, 1)",
              backgroundColor: "rgba(34, 197, 94, 0.1)",
              borderWidth: 4,
              yAxisID: "y1",
              tension: 0.4,
              pointRadius: 6,
              pointHoverRadius: 10,
              pointBackgroundColor: '#fff',
              pointBorderColor: "rgba(34, 197, 94, 1)",
              pointBorderWidth: 3,
              fill: true,
              datalabels: {
                anchor: "end",
                align: "top",
                formatter: v => (v && v > 0.2) ? v.toFixed(1) + "x" : ""
              }
            }
          ]
        },
        options: {
          ...createEnhancedChartOptions("ROAS Performance", "Revenue / Spend (‚Çπ)"),
          scales: {
            ...createEnhancedChartOptions("ROAS Performance", "Revenue / Spend (‚Çπ)").scales,
            y1: {
              position: "right",
              beginAtZero: true,
              title: { 
                display: true, 
                text: "ROAS (x)",
                font: { size: 13, weight: '600' },
                color: '#374151'
              },
              grid: { drawOnChartArea: false },
              ticks: {
                font: { size: 11, weight: '500' },
                color: '#6B7280'
              }
            }
          }
        }
      });

      const [y,m,d] = dateKey.split("-");
      dateInfo.textContent = `üìÖ ${d}-${m}-${y} ‚Ä¢ ${hours.length} hours of data`;
      dateInfo.className = "status-indicator status-success";
    }

    async function refreshDashboard() {
      const loadingIndicator = document.getElementById("loadingIndicator");
      const dateText = document.getElementById("dateText");
      
      try {
        loadingIndicator.style.display = "block";
        dateText.textContent = "Refreshing data...";
        
        const cacheBust = (SHEET_CSV_URL.includes("?") ? "&" : "?") + "cb=" + Date.now();
        const res = await fetch(SHEET_CSV_URL + cacheBust);
        const text = await res.text();
        const parsed = parseCsv(text);
        if (!parsed) return;

        allRows = parsed.rows;
        availableDates = parsed.dateKeys;
        latestDateKey = parsed.latestDateKey;

        const datePicker = document.getElementById("datePicker");
        const todayKey = getTodayKey();

        if (!selectedDateKey) {
          selectedDateKey = availableDates.includes(todayKey)
            ? todayKey
            : latestDateKey;
        } else if (!availableDates.includes(selectedDateKey)) {
          selectedDateKey = availableDates.includes(todayKey)
            ? todayKey
            : latestDateKey;
        }

        datePicker.min = availableDates[0];
        datePicker.max = latestDateKey;
        datePicker.value = selectedDateKey;

        renderDashboardForDate(selectedDateKey);

        const updateTime = new Date().toLocaleString("en-IN", {
          timeZone: 'Asia/Kolkata',
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        document.getElementById("lastUpdated").innerHTML =
          `üîÑ Last updated: <strong>${updateTime}</strong> &nbsp;‚Ä¢&nbsp; üìä Available dates: <strong>${availableDates.length}</strong> &nbsp;‚Ä¢&nbsp; üéØ Auto-refresh every 5 minutes`;

        loadingIndicator.style.display = "none";
      } catch (e) {
        console.error("Error loading sheet:", e);
        loadingIndicator.style.display = "none";
        dateText.textContent = "Error loading data";
        dateText.className = "status-indicator status-error";
        document.getElementById("lastUpdated").innerHTML =
          "‚ùå <strong>Error loading data.</strong> Check your connection and try again.";
      }
    }

    document.getElementById("datePicker").addEventListener("change", e => {
      selectedDateKey = e.target.value;
      renderDashboardForDate(selectedDateKey);
    });

    // Initialize dashboard
    refreshDashboard();
    setInterval(refreshDashboard, 5 * 60 * 1000);

    // Add some visual feedback for loading states
    document.addEventListener('DOMContentLoaded', () => {
      // Add pulse animation to cards during initial load
      const cards = document.querySelectorAll('.summary-card, .chart-card');
      cards.forEach(card => card.classList.add('pulse'));
      
      setTimeout(() => {
        cards.forEach(card => card.classList.remove('pulse'));
      }, 3000);
    });
  </script>
</body>
</html>

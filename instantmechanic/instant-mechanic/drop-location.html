<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instant Mechanic - Towing Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .customer-info {
            background: #f8fafc;
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .customer-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .customer-mobile {
            color: #64748b;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #64748b;
        }

        .main-content {
            padding: 30px 20px;
            background: #f8fafc;
            min-height: calc(100vh - 200px);
        }

        .location-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .location-btn {
            background: white;
            border: none;
            padding: 40px 20px;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-weight: 600;
            position: relative;
            min-height: 140px;
            font-size: 18px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 3px solid transparent;
        }

        /* Default state */
        .location-btn {
            color: #64748b;
        }

        /* Active state - Blue */
        .location-btn.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.3);
        }

        /* Completed state - Green */
        .location-btn.completed {
            border-color: #10b981;
            background: white;
            color: #10b981;
        }

        /* Active + Completed state */
        .location-btn.active.completed {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }

        .location-btn:hover {
            transform: translateY(-6px);
            box-shadow: 0 16px 50px rgba(0,0,0,0.15);
        }

        .location-btn.completed:hover {
            box-shadow: 0 16px 50px rgba(16, 185, 129, 0.2);
        }

        .location-btn.active:hover {
            box-shadow: 0 16px 50px rgba(59, 130, 246, 0.4);
        }

        .location-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .location-text {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .location-status {
            font-size: 14px;
            font-weight: 600;
            padding: 6px 16px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .location-btn .location-status.pending {
            background: #f1f5f9;
            color: #64748b;
        }

        .location-btn.active .location-status.current {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .location-btn.completed .location-status.done {
            background: #d1fae5;
            color: #047857;
        }

        .location-btn.active.completed .location-status.done {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box {
            width: 100%;
            padding: 18px 50px 18px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .search-box:focus {
            border-color: #3b82f6;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.15);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 18px;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 16px 16px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .suggestion-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.2s ease;
            font-size: 15px;
        }

        .suggestion-item:hover {
            background: #f8fafc;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .current-location {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .current-location-label {
            font-size: 12px;
            color: #3b82f6;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .current-location-address {
            font-size: 15px;
            color: #1e293b;
            line-height: 1.4;
        }

        .edit-btn {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            margin-left: 8px;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .edit-btn:hover {
            background: #eff6ff;
        }

        .map-container {
            height: 350px;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-instructions {
            text-align: center;
            color: #64748b;
            font-size: 15px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .submit-btn {
                position: fixed;       /* Fixes the button relative to the viewport */
    bottom: 20px;          
            width: 90%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(16, 185, 129, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.3);
        }

        .distance-info {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            display: none;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
        }

        .distance-text {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .distance-label {
            font-size: 14px;
            opacity: 0.9;
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .header {
                padding: 15px;
            }
            
            .main-content {
                padding: 20px 15px;
            }
            
            .location-btn {
                padding: 5px 15px;
                min-height: 120px;
            }
            
            .location-text {
                font-size: 18px;
            }
            
            .location-icon {
                font-size: 28px;
            }
            
            .search-box {
                padding: 16px 45px 16px 18px;
            }
            
            .map-container {
                height: 300px;
            }
            
            .submit-btn {
                padding: 18px;
                font-size: 16px;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">


        <div id="customerInfo" class="customer-info hidden">
            <div class="customer-name" id="customerName"></div>
            <div class="customer-mobile">
                <span>üìû</span>
                <span id="customerMobile"></span>
            </div>
        </div>

        <div id="loadingDiv" class="loading">
            <div>Loading customer data...</div>
        </div>

        <div id="mainContent" class="hidden">
            <div class="main-content">
                <div class="location-buttons">
                    <button class="location-btn" id="pickupBtn" onclick="selectMode('pickup')">
                        <div class="location-icon">üìç</div>
                        <div class="location-text">Pickup</div>
                        <div class="location-status pending" id="pickupStatus">Select</div>
                    </button>
                    <button class="location-btn" id="dropBtn" onclick="selectMode('drop')">
                        <div class="location-icon">üéØ</div>
                        <div class="location-text">Drop</div>
                        <div class="location-status pending" id="dropStatus">Select</div>
                    </button>
                </div>

                <div id="currentLocationDiv" class="current-location hidden">
                    <div class="current-location-label" id="currentLocationLabel">PICKUP LOCATION</div>
                    <div class="current-location-address" id="currentLocationAddress">
                        Current Location
                        <button class="edit-btn" onclick="editCurrentLocation()">‚úèÔ∏è</button>
                    </div>
                </div>

                <div class="search-container">
                    <input 
                        type="text" 
                        class="search-box" 
                        id="searchInput" 
                        placeholder="Search for pickup location..."
                        oninput="handleSearchChange()"
                        onfocus="showSuggestions = true"
                    >
                    <div class="search-icon">üîç</div>
                    <div class="suggestions hidden" id="suggestions"></div>
                </div>

                <div class="map-instructions">
                    Tap on the map to select location or search above
                </div>

                <div class="map-container">
                    <div id="map"></div>
                </div>

                <!-- Distance info hidden from UI but used for API -->
                <div id="distanceInfo" class="distance-info">
                    <div class="distance-text" id="distanceText">0 km</div>
                    <div class="distance-label">Estimated Distance</div>
                </div>

                <button class="submit-btn" id="submitBtn" onclick="handleSubmit()">
                    Submit Locations
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let customerData = null;
        let map = null;
        let pickupLocation = null;
        let dropLocation = null;
        let selectedMode = 'pickup';
        let markers = { pickup: null, drop: null };
        let autocompleteService = null;
        let placesService = null;
        let directionsService = null;
        let directionsRenderer = null;
        let showSuggestions = false;
        let distanceKm = 0;

        const API_KEY = 'AIzaSyAEFSrFGkBtDgc962tBB4WVlSssDhiZkUI';
        const WHATSAPP_NUMBER = '918130377099';

        // Get mobile number from URL
        function getMobileFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('mobile') || '918882786969';
        }

        // Initialize the application
        async function init() {
            await fetchCustomerData();
            initializeMap();
        }

        // Fetch customer data from API
        async function fetchCustomerData() {
            try {
                const mobile = getMobileFromUrl();
                const response = await fetch(`https://ai.instantmechanic.online/bot/customer_chats/?mobile=${mobile}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.data.length > 0) {
                    customerData = data.data[0];
                    displayCustomerInfo();
                    
                    if (customerData.location) {
                        const coords = extractCoordsFromUrl(customerData.location);
                        if (coords) {
                            pickupLocation = {
                                lat: coords.lat,
                                lng: coords.lng,
                                address: 'Current Location',
                                fromApi: true
                            };
                            updateLocationStatus();
                            showCurrentLocation();
                            selectMode('drop');
                        }
                    }
                }
                
                if (!pickupLocation) {
                    selectMode('pickup');
                } else {
                    selectMode('drop');
                }
                
                document.getElementById('loadingDiv').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            } catch (error) {
                console.error('Error fetching customer data:', error);
                selectMode('pickup');
                document.getElementById('loadingDiv').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            }
        }

        // Display customer information
        function displayCustomerInfo() {
            if (customerData) {
                document.getElementById('customerName').textContent = customerData.name;
                document.getElementById('customerMobile').textContent = customerData.mobile;
                document.getElementById('customerInfo').classList.remove('hidden');
            }
        }

        // Extract coordinates from Google Maps URL
        function extractCoordsFromUrl(url) {
            const match = url.match(/q=([0-9.-]+),([0-9.-]+)/);
            if (match) {
                return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
            }
            return null;
        }

        // Convert coordinates to Google Maps URL format
        function coordsToGoogleMapsUrl(lat, lng) {
            return `https://maps.google.com/?q=${lat},${lng}`;
        }

        // Initialize Google Maps
        function initializeMap() {
            if (window.google) {
                setupMap();
            } else {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=places&callback=setupMap`;
                script.async = true;
                document.head.appendChild(script);
            }
        }

        // Setup the map
        function setupMap() {
            const mapElement = document.getElementById('map');
            map = new google.maps.Map(mapElement, {
                center: { lat: 28.6139, lng: 77.2090 },
                zoom: 12,
                styles: [
                    {
                        featureType: 'poi.business',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            autocompleteService = new google.maps.places.AutocompleteService();
            placesService = new google.maps.places.PlacesService(map);
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#667eea',
                    strokeWeight: 4
                }
            });

            map.addListener('click', (event) => {
                handleMapClick(event.latLng);
            });

            if (pickupLocation) {
                updateMarkers();
            }
        }

        // Handle map click
        function handleMapClick(latLng) {
            const lat = latLng.lat();
            const lng = latLng.lng();
            
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = {
                        lat,
                        lng,
                        address: results[0].formatted_address,
                        fromApi: false
                    };

                    if (selectedMode === 'pickup') {
                        pickupLocation = location;
                    } else {
                        dropLocation = location;
                    }
                    
                    updateLocationStatus();
                    updateMarkers();
                    clearSearch();
                }
            });
        }

        // Select mode (pickup or drop)
        function selectMode(mode) {
            selectedMode = mode;
            
            document.getElementById('pickupBtn').classList.remove('active');
            document.getElementById('dropBtn').classList.remove('active');
            document.getElementById(mode + 'Btn').classList.add('active');
            
            const searchInput = document.getElementById('searchInput');
            searchInput.placeholder = `Search for ${mode} location...`;
            
            updateCurrentLocationDisplay();
        }

        // Handle search input change
        function handleSearchChange() {
            const query = document.getElementById('searchInput').value;
            
            if (query.length > 2 && autocompleteService) {
                autocompleteService.getPlacePredictions(
                    { 
                        input: query, 
                        componentRestrictions: { country: 'in' },
                        types: ['establishment', 'geocode']
                    },
                    (predictions, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            displaySuggestions(predictions || []);
                        }
                    }
                );
            } else {
                hideSuggestions();
            }
        }

        // Display search suggestions
        function displaySuggestions(predictions) {
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';
            
            if (predictions.length > 0) {
                predictions.forEach(prediction => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = prediction.description;
                    item.onclick = () => selectSuggestion(prediction);
                    suggestionsDiv.appendChild(item);
                });
                
                suggestionsDiv.classList.remove('hidden');
            } else {
                hideSuggestions();
            }
        }

        // Select a suggestion
        function selectSuggestion(prediction) {
            placesService.getDetails(
                { placeId: prediction.place_id },
                (place, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        const location = {
                            lat: place.geometry.location.lat(),
                            lng: place.geometry.location.lng(),
                            address: place.formatted_address,
                            fromApi: false
                        };

                        if (selectedMode === 'pickup') {
                            pickupLocation = location;
                        } else {
                            dropLocation = location;
                        }
                        
                        updateLocationStatus();
                        updateMarkers();
                        clearSearch();
                    }
                }
            );
        }

        // Hide suggestions
        function hideSuggestions() {
            document.getElementById('suggestions').classList.add('hidden');
        }

        // Clear search input
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            hideSuggestions();
        }

        // Update location status indicators
        function updateLocationStatus() {
            const pickupBtn = document.getElementById('pickupBtn');
            const dropBtn = document.getElementById('dropBtn');
            const pickupStatus = document.getElementById('pickupStatus');
            const dropStatus = document.getElementById('dropStatus');
            
            // Update pickup button
            if (pickupLocation) {
                pickupBtn.classList.add('completed');
                pickupStatus.textContent = 'DONE';
                pickupStatus.className = 'location-status done';
            } else {
                pickupBtn.classList.remove('completed');
                if (selectedMode === 'pickup') {
                    pickupStatus.textContent = 'CURRENT';
                    pickupStatus.className = 'location-status current';
                } else {
                    pickupStatus.textContent = 'SELECT';
                    pickupStatus.className = 'location-status pending';
                }
            }
            
            // Update drop button  
            if (dropLocation) {
                dropBtn.classList.add('completed');
                dropStatus.textContent = 'DONE';
                dropStatus.className = 'location-status done';
            } else {
                dropBtn.classList.remove('completed');
                if (selectedMode === 'drop') {
                    dropStatus.textContent = 'CURRENT';
                    dropStatus.className = 'location-status current';
                } else {
                    dropStatus.textContent = 'SELECT';
                    dropStatus.className = 'location-status pending';
                }
            }
            
            updateCurrentLocationDisplay();
        }

        // Show current location info
        function showCurrentLocation() {
            updateCurrentLocationDisplay();
        }

        // Update current location display
        function updateCurrentLocationDisplay() {
            const currentLocationDiv = document.getElementById('currentLocationDiv');
            const label = document.getElementById('currentLocationLabel');
            const address = document.getElementById('currentLocationAddress');
            
            const currentLocation = selectedMode === 'pickup' ? pickupLocation : dropLocation;
            
            if (currentLocation) {
                label.textContent = selectedMode.toUpperCase() + ' LOCATION';
                address.innerHTML = `${currentLocation.address} <button class="edit-btn" onclick="editCurrentLocation()">‚úèÔ∏è</button>`;
                currentLocationDiv.classList.remove('hidden');
            } else {
                currentLocationDiv.classList.add('hidden');
            }
        }

        // Edit current location
        function editCurrentLocation() {
            if (selectedMode === 'pickup') {
                pickupLocation = null;
            } else {
                dropLocation = null;
            }
            updateLocationStatus();
            updateMarkers();
        }

        // Update map markers
        function updateMarkers() {
            Object.values(markers).forEach(marker => {
                if (marker) marker.setMap(null);
            });

            markers = { pickup: null, drop: null };

            if (pickupLocation) {
                markers.pickup = new google.maps.Marker({
                    position: { lat: pickupLocation.lat, lng: pickupLocation.lng },
                    map: map,
                    title: 'Pickup Location',
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="20" cy="20" r="18" fill="#22c55e" stroke="white" stroke-width="3"/>
                                <text x="20" y="26" text-anchor="middle" fill="white" font-size="14" font-weight="bold">P</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(40, 40)
                    }
                });
            }

            if (dropLocation) {
                markers.drop = new google.maps.Marker({
                    position: { lat: dropLocation.lat, lng: dropLocation.lng },
                    map: map,
                    title: 'Drop Location',
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="20" cy="20" r="18" fill="#ef4444" stroke="white" stroke-width="3"/>
                                <text x="20" y="26" text-anchor="middle" fill="white" font-size="14" font-weight="bold">D</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(40, 40)
                    }
                });
            }

            if (pickupLocation && dropLocation) {
                const bounds = new google.maps.LatLngBounds();
                bounds.extend({ lat: pickupLocation.lat, lng: pickupLocation.lng });
                bounds.extend({ lat: dropLocation.lat, lng: dropLocation.lng });
                map.fitBounds(bounds);
                calculateDistance();
            } else if (pickupLocation || dropLocation) {
                const location = pickupLocation || dropLocation;
                map.setCenter({ lat: location.lat, lng: location.lng });
                map.setZoom(15);
            }
        }

        // Calculate distance between pickup and drop
        function calculateDistance() {
            if (pickupLocation && dropLocation && directionsService) {
                directionsService.route({
                    origin: { lat: pickupLocation.lat, lng: pickupLocation.lng },
                    destination: { lat: dropLocation.lat, lng: dropLocation.lng },
                    travelMode: google.maps.TravelMode.DRIVING
                }, (response, status) => {
                    if (status === 'OK') {
                        const route = response.routes[0];
                        const distance = route.legs[0].distance;
                        
                        document.getElementById('distanceText').textContent = distance.text;
                        const distanceMatch = distance.text.match(/([0-9.]+)/);
                        distanceKm = distanceMatch ? parseFloat(distanceMatch[1]) : 0;
                        
                        directionsRenderer.setDirections(response);
                        directionsRenderer.setMap(map);
                    }
                });
            } else {
                if (directionsRenderer) {
                    directionsRenderer.setMap(null);
                }
                distanceKm = 0;
            }
        }

        // Redirect to WhatsApp
        function redirectToWhatsApp() {
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}`;
            window.location.href = whatsappUrl;
        }

        // Handle form submission
        async function handleSubmit() {
            console.log('handleSubmit called');
            
            if (!pickupLocation || !dropLocation) {
                alert('Please select both pickup and drop locations');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            
            // Simple loading state - just disable button
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.6';
                submitBtn.innerHTML = 'Saving...';
            }

            try {
                // Prepare data in the required format
                const submitData = {
                    mobile: getMobileFromUrl(),
                    pickup_url: coordsToGoogleMapsUrl(pickupLocation.lat, pickupLocation.lng),
                    drop_url: coordsToGoogleMapsUrl(dropLocation.lat, dropLocation.lng),
                    distance: distanceKm.toString()
                };

                console.log('Submitting towing request:', submitData);

                // Make API call
                const response = await fetch('https://ai.instantmechanic.online/bot/save-locations/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(submitData)
                });

                console.log('Response status:', response.status);
                
                const result = await response.json();
                console.log('API Response:', result);

                // Check if API call was successful
                if (response.ok) {
                    console.log('Success - redirecting to WhatsApp');
                    // Success - silently redirect to WhatsApp
                    redirectToWhatsApp();
                } else {
                    // API returned error
                    throw new Error(result.message || 'Failed to book service');
                }

            } catch (error) {
                console.error('Error submitting request:', error);
                
                // Reset button
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.innerHTML = 'Save Locations';
                }
                
                alert('Failed to book service. Please try again.');
            }
        }

        // Close suggestions when clicking outside
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.search-container')) {
                hideSuggestions();
            }
        });

        // Initialize app when page loads
        window.addEventListener('load', init);
        
        // Make setupMap globally available for Google Maps callback
        window.setupMap = setupMap;
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Booking Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f3f6fb; padding:20px; }
    h2 { color:#1f2937; }

    .filters {
      background:#fff; padding:15px; border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      display:flex; gap:15px; align-items:center; margin-bottom:15px;
    }

    table {
      width:100%; border-collapse:collapse; background:#fff;
      border-radius:10px; overflow:hidden;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
    }

    th {
      background:linear-gradient(135deg,#2563eb,#1d4ed8);
      color:white; padding:10px; text-align:left;
    }

    td { padding:10px; border-bottom:1px solid #eee; }

    tr:hover { background:#f1f5ff; }

    .badge {
      padding:4px 10px; border-radius:20px; font-size:12px; font-weight:bold;
    }

    .company { background:#dcfce7; color:#166534; }
    .mechanic { background:#fff7ed; color:#9a3412; }

    .export-btn {
      background:#16a34a; color:white; border:none;
      padding:8px 14px; border-radius:6px; cursor:pointer;
    }

    /* Loader */
    #loader { display:none; text-align:center; margin:40px 0; }
    .spinner {
      width:40px; height:40px;
      border:4px solid #e5e7eb;
      border-top:4px solid #2563eb;
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin:0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<h2>ðŸ“Š Booking Dashboard</h2>

<div class="filters">
  <label><input type="radio" name="mode" value="single" checked onchange="toggleMode()"> Single Date</label>
  <label><input type="radio" name="mode" value="range" onchange="toggleMode()"> Date Range</label>

  <input type="date" id="singleDate">
  <input type="date" id="startDate" style="display:none">
  <input type="date" id="endDate" style="display:none">

  <button class="export-btn" onclick="exportCSV()">â¬‡ Export CSV</button>
</div>

<div id="loader">
  <div class="spinner"></div>
  <p id="slowText" style="display:none; margin-top:10px; color:#1d4ed8; font-weight:600;">
    You requested data for multiple dates, please wait for a few seconds...
  </p>
</div>

<table>
  <thead>
    <tr>
      <th>Booking ID</th>
      <th>Created</th>
      <th>Customer</th>
      <th>Car</th>
      <th>Problem</th>
      <th>Price</th>
      <th>Payment Status</th>
      <th>Payment ID</th>
    </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<script>
let currentData = [];
let loaderTimer;

function toggleMode() {
  const mode = document.querySelector('input[name="mode"]:checked').value;

  if (mode === "single") {
    singleDate.style.display = "inline";
    startDate.style.display = "none";
    endDate.style.display = "none";
    loadBookings();
  } else {
    singleDate.style.display = "none";
    startDate.style.display = "inline";
    endDate.style.display = "inline";
  }
}

singleDate.addEventListener("change", loadBookings);
startDate.addEventListener("change", loadBookings);
endDate.addEventListener("change", loadBookings);

function getPaymentLabel(b) {
  if (b.payment_status === "partially-paid") return "Paid Online to Company";
  if (b.payment_status === "pending") return "Paid to Mechanic";
  return b.payment_status;
}

function showLoader() {
  loader.style.display = "block";
  slowText.style.display = "none";

  loaderTimer = setTimeout(() => {
    slowText.style.display = "block";
  }, 7000);
}

function hideLoader() {
  clearTimeout(loaderTimer);
  loader.style.display = "none";
  slowText.style.display = "none";
}

function loadBookings() {
  let url = "https://ai.instantmechanic.online/bot/api/booking/by-date/";
  const mode = document.querySelector('input[name="mode"]:checked').value;

  if (mode === "single") {
    if (!singleDate.value) return;
    url += `?date=${singleDate.value}`;
  } else {
    if (!startDate.value || !endDate.value) return;
    url += `?start_date=${startDate.value}&end_date=${endDate.value}`;
  }

  showLoader();

  fetch(url)
    .then(r => r.json())
    .then(data => {
      hideLoader();
      currentData = data.filter(b => b.is_cancelled === false && b.is_gomechanic_call === false);

      let html = "";
      currentData.forEach(b => {
        html += `
          <tr>
            <td>${b.id}</td>
            <td>${new Date(b.created_at).toLocaleString("en-IN")}</td>
            <td>${b.customer_mobile}</td>
            <td>${b.car}</td>
            <td>${b.problem}</td>
            <td>â‚¹${b.company_profit}</td>
            <td>
              <span class="badge ${b.payment_status === 'partially-paid' ? 'company' : 'mechanic'}">
                ${getPaymentLabel(b)}
              </span>
            </td>
            <td>${b.payment_status === 'partially-paid' ? b.payment_id : "-"}</td>
          </tr>
        `;
      });
      rows.innerHTML = html;
    })
    .catch(() => {
      hideLoader();
      alert("Failed to load bookings. Please try again.");
    });
}

function exportCSV() {
  let csv = "ID,Created,Customer,Car,Problem,Company Profit,Payment Status,Payment ID\n";
  currentData.forEach(b => {
    csv += `${b.id},${b.created_at},${b.customer_mobile},"${b.car}","${b.problem}",${b.company_profit},${getPaymentLabel(b)},${b.payment_id || ""}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "booking_report.csv";
  link.click();
}

// Auto-load today
const today = new Date().toISOString().split("T")[0];
singleDate.value = today;
loadBookings();
</script>

</body>
</html>

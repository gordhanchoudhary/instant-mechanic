<!DOCTYPE html>
<html>
<head>
  <title>Instant Mechanic â€“ Booking Dashboard</title>
  <style>
    body {
      font-family: Inter, system-ui, sans-serif;
      background: #f4f7fb;
      padding: 20px;
    }

    h2 { color: #1f2937; }

    .filters {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.05);
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,.05);
    }

    th {
      background: linear-gradient(135deg,#2563eb,#1d4ed8);
      color: white;
      padding: 10px;
      text-align: left;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    tr:hover { background: #f1f5ff; }

    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .company { background: #dcfce7; color: #166534; }
    .mechanic { background: #fff7ed; color: #9a3412; }

    .export-btn {
      background: #16a34a;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }

    .export-btn:hover { background: #15803d; }
  </style>
</head>
<body>

<h2>ðŸ“Š Booking Payment Dashboard</h2>

<div class="filters">
  <label><input type="radio" name="mode" value="single" checked> Single Date</label>
  <label><input type="radio" name="mode" value="range"> Date Range</label>

  <input type="date" id="singleDate">
  <input type="date" id="startDate" style="display:none">
  <input type="date" id="endDate" style="display:none">

  <button class="export-btn" onclick="exportCSV()">â¬‡ Export CSV</button>
</div>

<table>
  <thead>
    <tr>
      <th>Booking ID</th>
      <th>Created</th>
      <th>Customer</th>
      <th>Car</th>
      <th>Problem</th>
      <th>Company Profit</th>
      <th>Payment Status</th>
      <th>Payment ID</th>
    </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<script>
let currentData = [];

document.querySelectorAll("input[name='mode']").forEach(r => {
  r.addEventListener("change", toggleMode);
});

singleDate.addEventListener("change", loadBookings);
startDate.addEventListener("change", loadBookings);
endDate.addEventListener("change", loadBookings);

function toggleMode() {
  if (mode.value === "single") {
    singleDate.style.display = "inline";
    startDate.style.display = "none";
    endDate.style.display = "none";
  } else {
    singleDate.style.display = "none";
    startDate.style.display = "inline";
    endDate.style.display = "inline";
  }
  loadBookings();
}

function getPaymentLabel(b) {
  if (b.payment_status === "partially-paid") return "Paid Online to Company";
  if (b.payment_status === "pending") return "Paid to Mechanic";
  return b.payment_status;
}

function loadBookings() {
  let url = "https://ai.instantmechanic.online/bot/api/booking/by-date/";

  if (document.querySelector("input[name='mode']:checked").value === "single") {
    if (!singleDate.value) return;
    url += `?date=${singleDate.value}`;
  } else {
    if (!startDate.value || !endDate.value) return;
    url += `?start_date=${startDate.value}&end_date=${endDate.value}`;
  }

  fetch(url)
    .then(res => res.json())
    .then(data => {
      currentData = data.filter(b => b.is_cancelled === false);

      let html = "";
      currentData.forEach(b => {
        html += `
          <tr>
            <td>${b.id}</td>
            <td>${new Date(b.created_at).toLocaleString("en-IN")}</td>
            <td>${b.customer_mobile}</td>
            <td>${b.car}</td>
            <td>${b.problem}</td>
            <td>â‚¹${b.company_profit}</td>
            <td>
              <span class="badge ${b.payment_status === 'partially-paid' ? 'company' : 'mechanic'}">
                ${getPaymentLabel(b)}
              </span>
            </td>
            <td>${b.payment_status === 'partially-paid' ? b.payment_id : "-"}</td>
          </tr>
        `;
      });
      rows.innerHTML = html;
    });
}

function exportCSV() {
  let csv = "ID,Created,Customer,Car,Problem,Company Profit,Payment Status,Payment ID\n";
  currentData.forEach(b => {
    csv += `${b.id},${b.created_at},${b.customer_mobile},"${b.car}","${b.problem}",${b.company_profit},${getPaymentLabel(b)},${b.payment_id || ""}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "bookings.csv";
  link.click();
}

// Load today by default
const today = new Date().toISOString().split("T")[0];
singleDate.value = today;
loadBookings();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densitydpi=device-dpi">
    <title>‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§ü ‡§Æ‡•à‡§ï‡•á‡§®‡§ø‡§ï - ‡§®‡§à ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîß</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* NUCLEAR OPTION: Override everything with CSS zoom and transforms */
        html, body {
            zoom: 1 !important;
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
            font-size: 16px !important;
            transform: scale(1) !important;
            transform-origin: top left !important;
            width: 100vw !important;
            height: 100vh !important;
            overflow: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        body {
            font-family: 'Noto Sans Devanagari', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            position: relative;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Force fixed container that ignores system scaling */
        .app-container {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            transform: scale(1) !important;
            transform-origin: 0 0 !important;
            zoom: 1 !important;
            overflow: hidden !important;
            z-index: 999999 !important;
        }

        /* All text with fixed pixel sizes - no relative units */
        .fixed-text-15 { font-size: 15px !important; line-height: 18px !important; }
        .fixed-text-20 { font-size: 20px !important; line-height: 22px !important; }
        .fixed-text-13 { font-size: 13px !important; line-height: 16px !important; }
        .fixed-text-14 { font-size: 14px !important; line-height: 17px !important; }
        .fixed-text-11 { font-size: 11px !important; line-height: 13px !important; }
        .fixed-text-18 { font-size: 18px !important; line-height: 20px !important; }

        /* Map Background */
        .map-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e8f4f8 0%, #d1e9f0 100%);
            z-index: 1;
        }

        .map-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0,150,136,0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(76,175,80,0.1) 0%, transparent 50%),
                linear-gradient(45deg, transparent 48%, rgba(158,158,158,0.05) 49%, rgba(158,158,158,0.05) 51%, transparent 52%);
        }

        .map-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.3;
        }

        .road-line {
            position: absolute;
            background: #9e9e9e;
            border-radius: 1px;
        }

        .road-line.horizontal { height: 2px; width: 100%; }
        .road-line.vertical { width: 2px; height: 100%; }
        .road-line:nth-child(1) { top: 20%; }
        .road-line:nth-child(2) { top: 45%; }
        .road-line:nth-child(3) { top: 70%; }
        .road-line:nth-child(4) { left: 30%; }
        .road-line:nth-child(5) { left: 65%; }

        /* Booking popup with fixed positioning */
        .booking-popup {
            position: absolute;
            bottom: 8px;
            left: 8px;
            right: 8px;
            top: 8px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 14px;
            z-index: 10;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Header */
        .popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .service-icon {
            width: 34px;
            height: 34px;
            background: #f5f5f5;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .timer {
            background: #fff3cd;
            color: #856404;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            border: 1px solid #ffeaa7;
            min-width: 50px;
            text-align: center;
        }

        .timer.warning {
            background: #ffebcd;
            color: #d2691e;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Service header */
        .service-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
            gap: 12px;
            flex-shrink: 0;
        }

        .service-info {
            flex: 1;
            min-width: 0;
        }

        .service-title {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .vehicle-info {
            color: #6b7280;
            margin-bottom: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .car-image-container {
            flex-shrink: 0;
            width: 85px;
            height: 60px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .car-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            transition: opacity 0.3s ease;
        }

        .car-placeholder {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: #f3f4f6;
            color: #6b7280;
            border-radius: 10px;
        }

        /* Info section */
        .info-section {
            margin-bottom: 12px;
            flex: 1;
            min-height: 0;
        }

        .info-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 10px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-icon {
            width: 18px;
            height: 18px;
            color: #6b7280;
            margin-top: 1px;
            flex-shrink: 0;
            font-size: 16px;
        }

        .info-content {
            flex: 1;
            min-width: 0;
        }

        .info-label {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 1px;
        }

        .info-value {
            color: #6b7280;
        }

        .map-link {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
        }

        .map-link:hover {
            text-decoration: underline;
        }

        .phone-number {
            color: #1f2937;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .phone-masked {
            color: #6b7280;
            font-weight: 400;
        }

        /* Agent info */
        .agent-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .agent-name {
            color: #1f2937;
            font-weight: 600;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .call-agent-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            min-width: 55px;
            justify-content: center;
        }

        .call-agent-btn:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }

        .call-agent-btn:active {
            transform: translateY(0);
        }

        /* Customer contact */
        .customer-contact {
            display: flex;
            gap: 8px;
            margin-top: 6px;
        }

        .contact-btn {
            flex: 1;
            background: #f3f4f6;
            color: #9ca3af;
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
            border-radius: 10px;
            font-weight: 600;
            cursor: not-allowed;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .contact-btn.enabled {
            background: #10b981;
            color: white;
            border-color: #10b981;
            cursor: pointer;
        }

        .contact-btn.enabled:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .contact-btn.whatsapp.enabled {
            background: #25d366;
            border-color: #25d366;
        }

        .contact-btn.whatsapp.enabled:hover {
            background: #128c7e;
        }

        /* Price section */
        .price-section {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
        }

        .price-label {
            color: #1f2937;
            font-weight: 500;
        }

        .price-value {
            color: #1f2937;
            font-weight: 600;
        }

        .payout-highlight {
            background: #fef3c7;
            padding: 2px 0;
            border-radius: 4px;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
        }

        .swipe-container {
            position: relative;
            height: 50px;
            background: #10b981;
            border-radius: 25px;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
            touch-action: none;
            box-shadow: 0 3px 12px rgba(16, 185, 129, 0.3);
        }

        .swipe-track {
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swipe-text {
            color: white;
            font-weight: 600;
            position: absolute;
            transition: opacity 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            letter-spacing: 0.2px;
        }

        .swipe-handle {
            position: absolute;
            left: 3px;
            top: 3px;
            width: 44px;
            height: 44px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: none;
            cursor: grab;
            z-index: 2;
            touch-action: none;
        }

        .swipe-handle:active {
            cursor: grabbing;
        }

        .swipe-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            width: 0%;
            transition: none;
            border-radius: 25px;
        }

        .decline-button {
            height: 40px;
            background: transparent;
            border: 1.5px solid #e5e7eb;
            color: #6b7280;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .decline-button:hover {
            border-color: #ef4444;
            color: #ef4444;
            background: #fef2f2;
        }

        .decline-button:active {
            transform: scale(0.98);
        }

        .swipe-container.accepted {
            background: #059669;
        }

        .swipe-container.accepted .swipe-text {
            opacity: 1 !important;
        }

        /* Icons */
        .icon-location::before { content: "üìç"; }
        .icon-phone::before { content: "üìû"; }
        .icon-tag::before { content: "üè∑Ô∏è"; }
        .icon-tools::before { content: "üîß"; }
        .icon-agent::before { content: "üë§"; }
        .icon-call::before { content: "üìû"; }
        .icon-whatsapp::before { content: "üí¨"; }
        .icon-arrow::before { content: "‚Üí"; }
        .icon-x::before { content: "‚úï"; }

        /* Loading */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 6px;
            height: 14px;
            margin-bottom: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading .service-title,
        .loading .vehicle-info,
        .loading .info-value,
        .loading .price-value {
            display: none;
        }

        .loading .service-title::after,
        .loading .vehicle-info::after,
        .loading .info-value::after,
        .loading .price-value::after {
            content: '';
            display: block;
            width: 100%;
            height: 12px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        .loading .action-buttons {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Custom popup styles */
        .custom-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            text-align: center;
            display: none;
            min-width: 280px;
        }

        .custom-popup.show {
            display: block;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .custom-popup h3 {
            margin-bottom: 10px;
            color: #1f2937;
            font-size: 18px;
        }

        .custom-popup p {
            margin-bottom: 20px;
            color: #6b7280;
            font-size: 14px;
        }

        .popup-buttons {
            display: flex;
            gap: 10px;
        }

        .popup-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .popup-btn.accept {
            background: #10b981;
            color: white;
        }

        .popup-btn.accept:hover {
            background: #059669;
        }

        .popup-btn.cancel {
            background: #f3f4f6;
            color: #6b7280;
        }

        .popup-btn.cancel:hover {
            background: #e5e7eb;
        }

        .popup-btn:active {
            transform: scale(0.95);
        }

        /* Popup overlay */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .popup-overlay.show {
            display: block;
        }

        /* Mobile responsive */
        @media (max-height: 700px) {
            .booking-popup { padding: 12px; }
            .popup-header { margin-bottom: 12px; }
            .service-header { margin-bottom: 12px; }
            .info-section { margin-bottom: 10px; }
            .price-section { margin-bottom: 10px; padding: 8px; }
            .info-row { margin-bottom: 8px; }
        }

        @media (max-width: 375px) {
            .booking-popup { left: 6px; right: 6px; bottom: 6px; top: 6px; padding: 12px; }
            .service-header { gap: 8px; }
            .car-image-container { width: 75px; height: 55px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Map Background -->
        <div class="map-background">
            <div class="map-lines">
                <div class="road-line horizontal"></div>
                <div class="road-line horizontal"></div>
                <div class="road-line horizontal"></div>
                <div class="road-line vertical"></div>
                <div class="road-line vertical"></div>
            </div>
        </div>

        <!-- Booking Popup -->
        <div class="booking-popup loading" id="bookingPopup">
            <!-- Header -->
            <div class="popup-header">
                <div class="header-left">
                    <div class="service-icon">
                        <span class="icon-tools"></span>
                    </div>
                    <h2 class="header-title fixed-text-15"> ‡§®‡§à ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó</h2>
                </div>
                <div class="timer fixed-text-13" id="timer">01:00</div>
            </div>

            <!-- Service Details -->
            <div class="service-header">
                <div class="service-info">
                    <div class="service-title fixed-text-20" id="problemText">
                        <div class="loading-skeleton"></div>
                    </div>
                    <div class="vehicle-info fixed-text-13" id="vehicleInfo">
                        <div class="loading-skeleton"></div>
                    </div>
                </div>
                <div class="car-image-container">
                    <div class="car-placeholder" id="carPlaceholder">üöó</div>
                    <img src="" alt="" class="car-image" id="carImage" style="display: none;">
                </div>
            </div>

            <!-- Info Section -->
            <div class="info-section">
                <div class="info-row">
                    <span class="info-icon icon-location"></span>
                    <div class="info-content">
                        <div class="info-label fixed-text-13">‡§∏‡•ç‡§•‡§æ‡§®:</div>
                        <div class="info-value fixed-text-13" id="locationInfo">
                            <div class="loading-skeleton"></div>
                        </div>
                    </div>
                </div>

                <div class="info-row">
                    <span class="info-icon icon-tag"></span>
                    <div class="info-content">
                        <div class="info-label fixed-text-13">‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø:</div>
                        <div class="info-value fixed-text-13" id="totalPrice">
                            <div class="loading-skeleton"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Price Section -->
            <div class="price-section">
                <div class="price-row payout-highlight">
                    <span class="price-label fixed-text-18">‡§Ü‡§™‡§ï‡•ã ‡§Æ‡§ø‡§≤‡•á‡§ó‡§æ:</span>
                    <span class="price-value fixed-text-18" id="payoutAmount">
                        <div class="loading-skeleton"></div>
                    </span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <div class="swipe-container" id="swipeContainer">
                    <div class="swipe-progress" id="swipeProgress"></div>
                    <div class="swipe-track">
                        <div class="swipe-text fixed-text-15" id="swipeText">
                            ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§≤‡§æ‡§á‡§° ‡§ï‡§∞‡•á‡§Ç
                            <span style="margin-left: 4px;">‚Üí</span>
                        </div>
                        <div class="swipe-handle" id="swipeHandle">
                            <span style="color: #10b981; font-size: 16px; font-weight: bold;">‚Üí</span>
                        </div>
                    </div>
                </div>

                <button class="decline-button fixed-text-14" onclick="declineBooking()">
                    <span class="icon-x"></span>
                    ‡§∞‡§ø‡§ú‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç
                </button>
            </div>
        </div>

        <!-- Custom Popup Overlay -->
        <div class="popup-overlay" id="popupOverlay"></div>

        <!-- Custom Success Popup -->
        <div class="custom-popup" id="successPopup">
            <h3>‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡•Ä ‡§ó‡§à!</h3>
            <p>‡§Ü‡§™‡§ï‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§ ‡§Ü‡§™ ‡§ú‡§≤‡•ç‡§¶ ‡§π‡•Ä booking details page ‡§™‡§∞ redirect ‡§π‡•ã ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á‡•§</p>
        </div>

        <!-- Custom Decline Popup -->
        <div class="custom-popup" id="declinePopup">
            <h3>‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§ú‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç?</h3>
            <p>‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§ï‡•ã ‡§∞‡§ø‡§ú‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?</p>
            <div class="popup-buttons">
                <button class="popup-btn cancel" onclick="closeDeclinePopup()">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                <button class="popup-btn accept" onclick="confirmDecline()">‡§π‡§æ‡§Å, ‡§∞‡§ø‡§ú‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
        </div>
    </div>

    <script>
        // Force fixed scaling on page load and continuously
        function forceFixedScaling() {
            try {
                // Force HTML and body properties
                document.documentElement.style.setProperty('zoom', '1', 'important');
                document.documentElement.style.setProperty('transform', 'scale(1)', 'important');
                document.documentElement.style.setProperty('font-size', '16px', 'important');
                document.documentElement.style.setProperty('-webkit-text-size-adjust', 'none', 'important');
                document.documentElement.style.setProperty('text-size-adjust', 'none', 'important');

                document.body.style.setProperty('zoom', '1', 'important');
                document.body.style.setProperty('transform', 'scale(1)', 'important');
                document.body.style.setProperty('font-size', '16px', 'important');
                document.body.style.setProperty('-webkit-text-size-adjust', 'none', 'important');
                document.body.style.setProperty('text-size-adjust', 'none', 'important');

                // Force app container scaling
                const container = document.querySelector('.app-container');
                if (container) {
                    container.style.setProperty('transform', 'scale(1)', 'important');
                    container.style.setProperty('zoom', '1', 'important');
                }

                // Apply fixed font sizes to all text elements
                const textElements = document.querySelectorAll('.fixed-text-15, .fixed-text-20, .fixed-text-13, .fixed-text-14, .fixed-text-11, .fixed-text-18');
                textElements.forEach(el => {
                    if (el && el.className) {
                        const match = el.className.match(/fixed-text-(\d+)/);
                        if (match) {
                            const size = match[1];
                            el.style.setProperty('font-size', size + 'px', 'important');
                            el.style.setProperty('line-height', (parseInt(size) + 2) + 'px', 'important');
                            el.style.setProperty('-webkit-text-size-adjust', 'none', 'important');
                            el.style.setProperty('text-size-adjust', 'none', 'important');
                        }
                    }
                });
            } catch (error) {
                console.warn('Error in forceFixedScaling:', error);
            }
        }

        // Get booking ID from URL parameters and mechanic from localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get('id') || '8978';
        const mechanicName = localStorage.getItem('mechanic') || 'Default Mechanic';

        let bookingData = null;
        let timeLeft = 60; // Changed to 60 seconds
        let isAccepted = false;
        let isDragging = false;
        let startX = 0;
        let currentX = 0;
        let timerInterval = null;
        let actionTaken = false; // New flag to track if action was taken
        let fullPhoneNumber = '';

        // Check if booking is already accepted
        function checkAcceptedBooking() {
            const acceptedBooking = localStorage.getItem('acceptedBooking');
            if (acceptedBooking) {
                try {
                    const acceptedData = JSON.parse(acceptedBooking);
                    if (acceptedData.bookingId === bookingId) {
                        // This booking is already accepted
                        showAcceptedBookingDialog();
                        return true;
                    }
                } catch (error) {
                    console.warn('Error parsing accepted booking:', error);
                }
            }
            return false;
        }

        // Show dialog for already accepted booking
        function showAcceptedBookingDialog() {
            const overlay = document.getElementById('popupOverlay');
            const popup = document.getElementById('successPopup');
            
            if (popup && overlay) {
                popup.innerHTML = `
                    <h3>‡§Ø‡§π ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§π‡•à!</h3>
                    <p>‡§Ü‡§™‡§®‡•á ‡§á‡§∏ ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§ï‡•ã ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞ ‡§≤‡§ø‡§Ø‡§æ ‡§π‡•à‡•§ ‡§Ü‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?</p>
                    <div class="popup-buttons">
                        <button class="popup-btn cancel" onclick="goToHomePage()">‡§π‡•ã‡§Æ ‡§™‡•á‡§ú ‡§ú‡§æ‡§è‡§Ç</button>
                        <button class="popup-btn accept" onclick="goToBookingDetails()">‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§°‡§ø‡§ü‡•á‡§≤‡•ç‡§∏ ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                    </div>
                `;
                
                overlay.classList.add('show');
                popup.classList.add('show');
            }
        }

        // Navigate to home page
        function goToHomePage() {
            window.location.href = `https://instantmechanic.online/mechanic-view.html?mechanic=${encodeURIComponent(mechanicName)}`;
        }

        // Navigate to booking details
        function goToBookingDetails() {
            window.location.href = `https://instantmechanic.online/mechanic-app-booking-deatil.html?id=${bookingId}`;
        }

        // Store accepted booking in localStorage
        function storeAcceptedBooking() {
            const acceptedBookingData = {
                bookingId: bookingId,
                mechanicName: mechanicName,
                acceptedAt: new Date().toISOString(),
                timestamp: Date.now()
            };
            localStorage.setItem('acceptedBooking', JSON.stringify(acceptedBookingData));
        }

        // Clear accepted booking from localStorage (for testing or when job is complete)
        function clearAcceptedBooking() {
            localStorage.removeItem('acceptedBooking');
        }

        // Check if there's an accepted booking when going back
        window.addEventListener('pageshow', function(event) {
            // This fires when user navigates back to this page
            if (event.persisted) {
                checkAcceptedBooking();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            try {
                forceFixedScaling();
                // Run scaling fix repeatedly to override any system changes
                setInterval(forceFixedScaling, 100);
                
                // Check if booking is already accepted before loading
                if (!checkAcceptedBooking()) {
                    loadBookingData();
                    initTimer();
                    initSwipeToAccept();
                }
            } catch (error) {
                console.error('Error in DOMContentLoaded:', error);
            }
        });

        // Also apply on resize and orientation change
        window.addEventListener('resize', forceFixedScaling);
        window.addEventListener('orientationchange', () => {
            setTimeout(forceFixedScaling, 100);
        });

        // API call function
        async function callMechanicBookingAPI(action) {
            try {
                const response = await fetch('https://ai.instantmechanic.online/bot/api/mechanic-booking-action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mechanic: mechanicName,
                        booking: parseInt(bookingId),
                        action: action
                    })
                });

                const result = await response.json();
                console.log('API Response:', result);
                return result;
            } catch (error) {
                console.error('Error calling API:', error);
                return null;
            }
        }

        // Mask phone number (hide last 4 digits)
        function maskPhoneNumber(phone) {
            try {
                if (!phone || phone.length < 4) return phone;
                return phone.substring(0, phone.length - 4) + '****';
            } catch (error) {
                console.warn('Error in maskPhoneNumber:', error);
                return phone;
            }
        }

        // Load booking data
        function loadBookingData() {
            // Simulate API call - replace with actual API endpoint
            fetch(`https://ai.instantmechanic.online/bot/api/bookings/${bookingId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    bookingData = data;
                    displayBookingData(data);
                })
                .catch(error => {
                    console.error('Error loading booking:', error);
                    // Show demo data for testing
                    const demoData = {
                        "id": 8978,
                        "agent_name": "Piyush",
                        "customer_mobile": "919872195104",
                        "mechanic_name": "Lal Babu Delhi",
                        "car": "Ciaz 2018",
                        "problem": "Battery Jump Start",
                        "price": "599 (Service Charge: ‚Çπ508, GST: ‚Çπ91)",
                        "location": "https://www.google.com/maps?q=28.566780090332,77.121612548828",
                        "pending_payment_amount": "254",
                        "car_image": null, // Set to null to avoid 404 error
                        "is_cancelled": false
                    };
                    displayBookingData(demoData);
                });
        }

        // Display booking data
        function displayBookingData(data) {
            try {
                const bookingPopup = document.getElementById('bookingPopup');
                if (bookingPopup) {
                    bookingPopup.classList.remove('loading');
                }
                forceFixedScaling(); // Apply scaling after DOM changes

                // Service title and vehicle info
                const problemText = document.getElementById('problemText');
                const vehicleInfo = document.getElementById('vehicleInfo');
                
                if (problemText) {
                    problemText.textContent = data.problem || '‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç';
                }
                if (vehicleInfo) {
                    vehicleInfo.textContent = `‡§ï‡§æ‡§∞: ${data.car || '‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç'}`;
                }

                // Store full phone number
                fullPhoneNumber = data.customer_mobile || '';

                // Car image handling
                const carImage = document.getElementById('carImage');
                const carPlaceholder = document.getElementById('carPlaceholder');
                
                if (data.car_image && carImage && carPlaceholder) {
                    carImage.src = data.car_image;
                    carImage.alt = data.car || 'Car';
                    
                    carImage.onload = function() {
                        carImage.style.display = 'block';
                        carPlaceholder.style.display = 'none';
                    };
                    
                    carImage.onerror = function() {
                        carImage.style.display = 'none';
                        carPlaceholder.style.display = 'flex';
                        carPlaceholder.textContent = 'üöó';
                    };
                } else if (carPlaceholder) {
                    carPlaceholder.style.display = 'flex';
                    carPlaceholder.textContent = 'üöó';
                }

                // Location
                const locationInfo = document.getElementById('locationInfo');
                if (locationInfo) {
                    if (data.location) {
                        locationInfo.innerHTML = 
                            `‡§∏‡•ç‡§•‡§æ‡§® ‡§¶‡•á‡§ñ‡•á‡§Ç<br>(<a href="${data.location}" class="map-link" target="_blank">‡§Æ‡•á‡§™ ‡§™‡§∞ ‡§¶‡•á‡§ñ‡•á‡§Ç</a>)`;
                    } else {
                        locationInfo.textContent = '‡§∏‡•ç‡§•‡§æ‡§® ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç';
                    }
                }

                // Total price
                const totalPrice = document.getElementById('totalPrice');
                if (totalPrice) {
                    const priceText = data.price || '‚Çπ0';
                    totalPrice.textContent = `${priceText} (GST ‡§∏‡§π‡§ø‡§§)`;
                }

                // Payout amount
                const payoutAmount = document.getElementById('payoutAmount');
                if (payoutAmount) {
                    const payoutAmountValue = data.pending_payment_amount || '0';
                    payoutAmount.textContent = `‚Çπ${payoutAmountValue}`;
                }

                forceFixedScaling(); // Final scaling enforcement
            } catch (error) {
                console.error('Error in displayBookingData:', error);
            }
        }

        // Timer functionality
        function initTimer() {
            try {
                const timerElement = document.getElementById('timer');
                
                function updateTimer() {
                    try {
                        if (!timerElement) return;
                        
                        const minutes = Math.floor(timeLeft / 60);
                        const seconds = timeLeft % 60;
                        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        if (timeLeft <= 15) {
                            timerElement.classList.add('warning');
                        } else {
                            timerElement.classList.remove('warning');
                        }
                        
                        if (timeLeft > 0) {
                            timeLeft--;
                        } else {
                            clearInterval(timerInterval);
                            // Auto-decline when timer reaches 0 if no action taken
                            if (!actionTaken) {
                                handleNoAction();
                            }
                        }
                    } catch (error) {
                        console.warn('Error in updateTimer:', error);
                    }
                }
                
                timerInterval = setInterval(updateTimer, 1000);
            } catch (error) {
                console.error('Error in initTimer:', error);
            }
        }

        // Handle no action - send "noaction" to API
        async function handleNoAction() {
            try {
                actionTaken = true; // Prevent multiple calls
                await callMechanicBookingAPI('noaction');
                
                // Redirect to mechanic view
                window.location.href = `https://instantmechanic.online/mechanic-view.html?mechanic=${encodeURIComponent(mechanicName)}`;
            } catch (error) {
                console.error('Error in handleNoAction:', error);
            }
        }

        // Enable customer contact after acceptance (not used with commented sections)
        function enableCustomerContact() {
            try {
                // This function is kept for compatibility but won't be used
                // since customer contact sections are commented out
                console.log('Customer contact would be enabled here');
            } catch (error) {
                console.warn('Error in enableCustomerContact:', error);
            }
        }

        // Handle customer contact (not used with commented sections)
        function contactCustomer(type) {
            try {
                if (!isAccepted || !fullPhoneNumber) {
                    showCustomPopup('‡§™‡§π‡§≤‡•á ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç', '');
                    return;
                }

                if (type === 'whatsapp') {
                    const message = encodeURIComponent('‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§Æ‡•à‡§ï‡•á‡§®‡§ø‡§ï ‡§π‡•Ç‡§Ç‡•§ ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§™‡§∞ ‡§Ü ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç‡•§');
                    window.open(`https://wa.me/${fullPhoneNumber}?text=${message}`, '_blank');
                } else if (type === 'call') {
                    window.location.href = `tel:${fullPhoneNumber}`;
                }
            } catch (error) {
                console.warn('Error in contactCustomer:', error);
            }
        }

        // Show custom popup function
        function showCustomPopup(title, message, showButtons = false, onConfirm = null) {
            const overlay = document.getElementById('popupOverlay');
            const popup = document.getElementById('successPopup');
            
            if (popup && overlay) {
                popup.innerHTML = `
                    <h3>${title}</h3>
                    ${message ? `<p>${message}</p>` : ''}
                    ${showButtons ? `
                        <div class="popup-buttons">
                            <button class="popup-btn cancel" onclick="closeCustomPopup()">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                            <button class="popup-btn accept" onclick="if(window.tempOnConfirm) window.tempOnConfirm()">‡§π‡§æ‡§Å</button>
                        </div>
                    ` : ''}
                `;
                
                if (onConfirm) {
                    window.tempOnConfirm = onConfirm;
                }
                
                overlay.classList.add('show');
                popup.classList.add('show');
                
                if (!showButtons) {
                    setTimeout(() => {
                        closeCustomPopup();
                    }, 2000);
                }
            }
        }

        function closeCustomPopup() {
            const overlay = document.getElementById('popupOverlay');
            const popup = document.getElementById('successPopup');
            
            if (overlay && popup) {
                overlay.classList.remove('show');
                popup.classList.remove('show');
            }
            
            window.tempOnConfirm = null;
        }

        // Swipe to Accept functionality
        function initSwipeToAccept() {
            try {
                const swipeContainer = document.getElementById('swipeContainer');
                const swipeHandle = document.getElementById('swipeHandle');
                const swipeProgress = document.getElementById('swipeProgress');
                const swipeText = document.getElementById('swipeText');
                
                if (!swipeContainer || !swipeHandle || !swipeProgress || !swipeText) {
                    console.warn('Swipe elements not found');
                    return;
                }
                
                let maxSwipeDistance;

                function updateMaxSwipeDistance() {
                    try {
                        maxSwipeDistance = swipeContainer.offsetWidth - swipeHandle.offsetWidth - 6;
                    } catch (error) {
                        console.warn('Error updating maxSwipeDistance:', error);
                        maxSwipeDistance = 200; // fallback value
                    }
                }

                updateMaxSwipeDistance();
                window.addEventListener('resize', updateMaxSwipeDistance);
                
                // Touch events
                swipeHandle.addEventListener('touchstart', handleStart, { passive: false });
                document.addEventListener('touchmove', handleMove, { passive: false });
                document.addEventListener('touchend', handleEnd, { passive: false });
                
                // Mouse events
                swipeHandle.addEventListener('mousedown', handleStart);
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('mouseup', handleEnd);
                
                function handleStart(e) {
                    try {
                        if (isAccepted || actionTaken) return;
                        
                        isDragging = true;
                        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                        const handleRect = swipeHandle.getBoundingClientRect();
                        startX = clientX - handleRect.left;
                        swipeHandle.style.transition = 'none';
                        swipeProgress.style.transition = 'none';
                        
                        e.preventDefault();
                    } catch (error) {
                        console.warn('Error in handleStart:', error);
                    }
                }
                
                function handleMove(e) {
                    try {
                        if (!isDragging || isAccepted || actionTaken) return;
                        
                        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                        const containerRect = swipeContainer.getBoundingClientRect();
                        
                        currentX = clientX - containerRect.left - startX;
                        currentX = Math.max(0, Math.min(currentX, maxSwipeDistance));
                        
                        const progress = (currentX / maxSwipeDistance) * 100;
                        
                        swipeHandle.style.transform = `translateX(${currentX}px)`;
                        swipeProgress.style.width = `${progress}%`;
                        swipeText.style.opacity = 1 - (progress / 100);
                        
                        e.preventDefault();
                    } catch (error) {
                        console.warn('Error in handleMove:', error);
                    }
                }
                
                function handleEnd(e) {
                    try {
                        if (!isDragging || isAccepted || actionTaken) return;
                        
                        isDragging = false;
                        const progress = (currentX / maxSwipeDistance) * 100;
                        
                        if (progress >= 75) {
                            acceptBooking();
                        } else {
                            resetSwipe();
                        }
                    } catch (error) {
                        console.warn('Error in handleEnd:', error);
                    }
                }
                
                function resetSwipe() {
                    try {
                        swipeHandle.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                        swipeProgress.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                        swipeHandle.style.transform = 'translateX(0px)';
                        swipeProgress.style.width = '0%';
                        swipeText.style.opacity = '1';
                        currentX = 0;
                    } catch (error) {
                        console.warn('Error in resetSwipe:', error);
                    }
                }
            } catch (error) {
                console.error('Error in initSwipeToAccept:', error);
            }
        }
        
        async function acceptBooking() {
            try {
                if (actionTaken) return; // Prevent duplicate actions
                
                actionTaken = true;
                isAccepted = true;
                clearInterval(timerInterval);
                
                const swipeContainer = document.getElementById('swipeContainer');
                const swipeText = document.getElementById('swipeText');
                
                if (swipeContainer) {
                    swipeContainer.classList.add('accepted');
                }
                if (swipeText) {
                    swipeText.textContent = '‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡•Ä ‡§ó‡§à!';
                    swipeText.style.opacity = '1';
                }
                
                // Store accepted booking in localStorage
                storeAcceptedBooking();
                
                // Call API
                const apiResponse = await callMechanicBookingAPI('accept');
                
                // Show custom success popup instead of browser alert
                showCustomPopup('‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡•Ä ‡§ó‡§à!', '‡§Ü‡§™‡§ï‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§');
                
                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = `https://instantmechanic.online/mechanic-app-booking-deatil.html?id=${bookingId}`;
                }, 2000);
                
            } catch (error) {
                console.error('Error in acceptBooking:', error);
                actionTaken = false; // Reset if error occurred
            }
        }
        
        function declineBooking() {
            try {
                if (actionTaken) return; // Prevent duplicate actions
                
                // Show custom decline confirmation popup
                const overlay = document.getElementById('popupOverlay');
                const declinePopup = document.getElementById('declinePopup');
                
                if (overlay && declinePopup) {
                    overlay.classList.add('show');
                    declinePopup.classList.add('show');
                }
            } catch (error) {
                console.warn('Error in declineBooking:', error);
            }
        }

        function closeDeclinePopup() {
            const overlay = document.getElementById('popupOverlay');
            const declinePopup = document.getElementById('declinePopup');
            
            if (overlay && declinePopup) {
                overlay.classList.remove('show');
                declinePopup.classList.remove('show');
            }
        }

        async function confirmDecline() {
            try {
                if (actionTaken) return; // Prevent duplicate actions
                
                actionTaken = true;
                clearInterval(timerInterval);
                
                // Close popup
                closeDeclinePopup();
                
                // Call API
                const apiResponse = await callMechanicBookingAPI('cancel');
                
                // Show success message and redirect
                showCustomPopup('‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§ú‡•á‡§ï‡•ç‡§ü ‡§ï‡•Ä ‡§ó‡§à', '‡§Ö‡§ó‡§≤‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§ú‡•â‡§¨ ‡§ñ‡•ã‡§ú‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...');
                
                setTimeout(() => {
                    window.location.href = `https://instantmechanic.online/mechanic-view.html?mechanic=${encodeURIComponent(mechanicName)}`;
                }, 2000);
                
            } catch (error) {
                console.error('Error in confirmDecline:', error);
                actionTaken = false; // Reset if error occurred
            }
        }

        function callAgent() {
            try {
                if (bookingData && bookingData.agent_name) {
                    showCustomPopup(
                        `${bookingData.agent_name} ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç?`,
                        '',
                        true,
                        () => {
                            window.location.href = 'tel:+919876543210';
                            closeCustomPopup();
                        }
                    );
                }
            } catch (error) {
                console.warn('Error in callAgent:', error);
            }
        }
        
        // Prevent scrolling when swiping
        const swipeContainer = document.getElementById('swipeContainer');
        if (swipeContainer) {
            swipeContainer.addEventListener('touchmove', function(e) {
                if (isDragging) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // Haptic feedback
        function vibrate(pattern = 50) {
            try {
                if ('vibrate' in navigator) {
                    navigator.vibrate(pattern);
                }
            } catch (error) {
                console.warn('Vibrate not supported:', error);
            }
        }

        const swipeHandle = document.getElementById('swipeHandle');
        if (swipeHandle) {
            swipeHandle.addEventListener('touchstart', () => vibrate(10));
        }

        // Close popup when clicking overlay
        const popupOverlay = document.getElementById('popupOverlay');
        if (popupOverlay) {
            popupOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDeclinePopup();
                    closeCustomPopup();
                }
            });
        }
    </script>
</body>
</html>

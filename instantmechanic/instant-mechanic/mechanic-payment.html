<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechanic Payout Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #60a5fa;
            --secondary: #64748b;
            --success: #10b981;
            --success-dark: #059669;
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --whatsapp: #25d366;
            --whatsapp-dark: #128c7e;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e0;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            min-height: 100vh;
            color: var(--gray-900);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 20px;
        }

        /* Header */
        .header {
            background: var(--white);
            padding: 32px;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 24px;
            border: 1px solid var(--gray-200);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: var(--gray-900);
            font-size: 2.25rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 16px;
            letter-spacing: -0.025em;
        }

        .header h1 i {
            color: var(--primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Enhanced Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            line-height: 1.4;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--gray-700);
            border: 2px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover {
            border-color: var(--gray-300);
            background: var(--gray-50);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, var(--whatsapp) 0%, var(--whatsapp-dark) 100%);
            color: var(--white);
            padding: 8px 16px;
            font-size: 13px;
            box-shadow: var(--shadow-md);
        }

        .btn-whatsapp:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-settle {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: var(--white);
            padding: 8px 16px;
            font-size: 13px;
            box-shadow: var(--shadow-md);
        }

        .btn-settle:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Overview Cards */
        .overview-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .card {
            background: var(--white);
            padding: 32px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--gray-200);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .card-icon {
            width: 64px;
            height: 64px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .card-icon.primary { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
        }
        .card-icon.success { 
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%); 
        }
        .card-icon.warning { 
            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%); 
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .card-subtitle {
            color: var(--gray-500);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .card-amount {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 12px;
            letter-spacing: -0.05em;
        }

        /* Enhanced Filters */
        .filters {
            background: var(--white);
            padding: 32px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            margin-bottom: 32px;
            border: 1px solid var(--gray-200);
        }

        .filters h3 {
            color: var(--gray-900);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .filters h3 i {
            color: var(--primary);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            letter-spacing: 0.025em;
        }

        .form-control {
            padding: 14px 16px;
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--white);
            color: var(--gray-900);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Enhanced Select Styling */
        select.form-control {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23374151' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
            appearance: none;
            cursor: pointer;
        }

        select.form-control:focus {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%233b82f6' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        }

        /* Enhanced Data Section */
        .data-section {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--gray-200);
            margin-bottom: 32px;
        }

        .section-header {
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            padding: 24px 32px;
            border-bottom: 1px solid var(--gray-200);
        }

        .section-header h3 {
            color: var(--gray-900);
            font-size: 1.375rem;
            font-weight: 700;
            margin: 0;
        }

        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
        }

        .table th,
        .table td {
            padding: 20px 24px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
            font-size: 14px;
        }

        .table th {
            background: var(--gray-50);
            font-weight: 700;
            color: var(--gray-700);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 13px;
        }

        .table tr:hover {
            background: var(--gray-50);
        }

        .amount-positive {
            color: var(--danger);
            font-weight: 700;
            font-size: 1rem;
        }

        .amount-negative {
            color: var(--success);
            font-weight: 700;
            font-size: 1rem;
        }

        /* Enhanced History Entries */
        .combined-history-list {
            padding: 0;
        }

        .history-entry {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius-lg);
            margin: 0 24px 16px 24px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .history-entry::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .history-entry.whatsapp-entry::before {
            background: var(--whatsapp);
        }

        .history-entry:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-lg);
        }

        .history-entry-header {
            display: grid;
            grid-template-columns: 200px 1fr 140px 140px auto;
            gap: 24px;
            align-items: center;
            margin-bottom: 12px;
        }

        .history-entry-datetime {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-600);
            line-height: 1.4;
        }

        .history-entry-main-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .payout-date-highlight {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: -0.025em;
        }

        .payout-date-highlight i {
            color: var(--primary);
            font-size: 1rem;
        }

        .entry-meta-info {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .entry-meta-info .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .entry-meta-info .meta-label {
            font-weight: 700;
            color: var(--gray-700);
        }

        .history-entry-type {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 8px 12px;
            border-radius: 20px;
            white-space: nowrap;
        }

        .history-entry-type.whatsapp {
            color: var(--white);
            background: linear-gradient(135deg, var(--whatsapp) 0%, var(--whatsapp-dark) 100%);
        }

        .history-entry-type.live-payout {
            color: var(--white);
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
        }

        .history-entry-type.history-payout {
            color: var(--white);
            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%);
        }

        .history-entry-amount {
            font-size: 1.375rem;
            font-weight: 800;
            text-align: center;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            background: var(--white);
            border: 2px solid;
            letter-spacing: -0.025em;
        }

        .history-entry-amount.positive {
            color: var(--danger);
            border-color: rgba(239, 68, 68, 0.2);
            background: rgba(239, 68, 68, 0.05);
        }

        .history-entry-amount.negative {
            color: var(--success);
            border-color: rgba(16, 185, 129, 0.2);
            background: rgba(16, 185, 129, 0.05);
        }

        .history-entry-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
        }

        /* Enhanced Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
        }

        .confirmation-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
        }

        .modal-content,
        .confirmation-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 0;
            border-radius: var(--border-radius-xl);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        @keyframes modalSlideIn {
            from { 
                transform: translateY(-32px) scale(0.95); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
        }

        .modal-header,
        .confirmation-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .confirmation-header {
            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%);
            justify-content: flex-start;
            gap: 16px;
        }

        .modal-header h4,
        .confirmation-header h4 {
            margin: 0;
            font-size: 1.375rem;
            font-weight: 700;
        }

        .close {
            color: var(--white);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body,
        .confirmation-body {
            padding: 32px;
        }

        .modal-body .form-group {
            margin-bottom: 24px;
        }

        .modal-footer,
        .confirmation-footer {
            padding: 24px 32px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            background: var(--gray-50);
        }

        /* Enhanced Alert Styles */
        .alert {
            padding: 16px 24px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            box-shadow: var(--shadow-md);
            border: 1px solid;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-dark);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-dark);
            border-color: rgba(239, 68, 68, 0.2);
        }

        /* Enhanced Loading & Empty States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px;
            color: var(--gray-500);
            font-weight: 500;
        }

        .loading i {
            margin-right: 12px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 48px;
            color: var(--gray-500);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            color: var(--gray-300);
        }

        /* Enhanced Status Elements */
        .mechanic-name-link {
            cursor: pointer;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }

        .mechanic-name-link:hover {
            color: var(--primary-dark);
        }

        .settled-badge {
            color: var(--success);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }

        .pending-balance {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pending-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
        }

        .no-pending {
            color: var(--success);
            font-weight: 600;
        }

        .has-pending {
            color: var(--danger);
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Enhanced Historical Data */
        .historical-data-container {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(217, 119, 6, 0.05) 100%);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: var(--border-radius);
            margin-top: 20px;
            padding: 20px;
            animation: slideDown 0.3s ease;
        }

        .historical-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            color: var(--warning-dark);
            font-weight: 700;
            font-size: 0.875rem;
        }

        .historical-header i {
            color: var(--warning);
            font-size: 1.1rem;
        }

        .historical-entries {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .historical-entry {
            background: var(--white);
            padding: 16px 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .historical-entry:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-md);
        }

        .history-entry-expand {
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            color: var(--gray-700);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .history-entry-expand:hover {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .history-entry-expand.expanded {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            border-color: var(--primary);
        }

        /* Enhanced Responsive Design */
        @media (max-width: 1024px) {
            .history-entry-header {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .history-entry-actions {
                align-items: flex-start;
                flex-direction: row;
                gap: 12px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 24px 16px;
            }

            .header {
                flex-direction: column;
                text-align: center;
                padding: 24px;
            }

            .header h1 {
                font-size: 1.875rem;
            }

            .header-actions {
                justify-content: center;
            }

            .overview-cards {
                grid-template-columns: 1fr;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }

            .card-amount {
                font-size: 2rem;
            }

            .table th,
            .table td {
                padding: 16px 12px;
                font-size: 13px;
            }

            .modal-content,
            .confirmation-content {
                margin: 10% auto;
                width: 95%;
            }

            .payout-date-highlight {
                font-size: 1.125rem;
            }

            .history-entry-amount {
                font-size: 1.125rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                justify-content: center;
            }
        }

        /* Enhanced WhatsApp Message Details */
        .whatsapp-message-details {
            background: rgba(37, 211, 102, 0.05);
            border: 1px solid rgba(37, 211, 102, 0.15);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            font-size: 0.875rem;
            color: var(--gray-700);
            line-height: 1.5;
            font-style: italic;
            margin-top: 8px;
        }

        .hisab-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--whatsapp);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
                max-height: 0;
            }
            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 500px;
            }
        }

        /* Enhanced confirmation details */
        .confirmation-details {
            background: var(--gray-50);
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            border-left: 4px solid var(--warning);
        }

        .confirmation-details p {
            margin: 8px 0;
            color: var(--gray-700);
            font-weight: 500;
        }

        .confirmation-amount {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--danger);
            letter-spacing: -0.025em;
        }

        /* Section header enhancements */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-container label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--gray-700);
            cursor: pointer;
            font-size: 0.875rem;
        }

        .toggle-container input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: var(--primary);
        }

        /* Live badge enhancement */
        .live-badge {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: var(--white);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }

        .live-badge i {
            font-size: 0.6rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-wallet"></i>
                Mechanic Payout Dashboard
            </h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="syncPayments()" id="syncBtn">
                    <i class="fas fa-sync-alt"></i>
                    Sync Payments
                </button>
                <button class="btn btn-primary" onclick="openCreateModal()">
                    <i class="fas fa-plus"></i>
                    Create Manual Payment
                </button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- Overview Cards -->
        <div class="overview-cards">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon primary">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div>
                        <div class="card-title">Total Pending Payments</div>
                        <div class="card-subtitle">Overall system pending</div>
                    </div>
                </div>
                <div class="card-amount" id="totalPending">₹0</div>
                <div class="card-subtitle" id="lastUpdated">Last updated: --</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon warning">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <div class="card-title">Mechanics with Pending</div>
                        <div class="card-subtitle">Active pending balances</div>
                    </div>
                </div>
                <div class="card-amount" id="mechanicsWithPending">0</div>
                <div class="card-subtitle">mechanics have pending amounts</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon success">
                        <i class="fas fa-history"></i>
                    </div>
                    <div>
                        <div class="card-title">Recent Payouts</div>
                        <div class="card-subtitle">Today's transactions</div>
                    </div>
                </div>
                <div class="card-amount" id="recentPayouts">0</div>
                <div class="card-subtitle">transactions today</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <h3>
                <i class="fas fa-filter"></i>
                Filters
            </h3>
            <div class="filter-row">
                <div class="form-group">
                    <label>Mechanic Name</label>
                    <select class="form-control" id="mechanicNameFilter">
                        <option value="">All Mechanics</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" class="form-control" id="startDateFilter">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" class="form-control" id="endDateFilter">
                </div>
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="applyFilters()">
                        <i class="fas fa-search"></i>
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Mechanic Pending Balances -->
        <div class="data-section">
            <div class="section-header">
                <h3>Mechanic Pending Balances</h3>
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Mechanic Name</th>
                            <th>Pending Balance</th>
                            <th>Last Updated</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mechanicPendingTableBody">
                        <tr>
                            <td colspan="5" class="loading">
                                <i class="fas fa-spinner"></i>
                                Loading data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Daily Payouts History & WhatsApp Messages -->
        <div class="data-section" id="dailyPayoutsSection" style="display: none;">
            <div class="section-header">
                <h3>Daily Payouts History & WhatsApp Messages</h3>
                <div class="toggle-container">
                    <label>
                        <input type="checkbox" id="showWhatsAppToggle" onchange="toggleWhatsAppMessages()">
                        Show WhatsApp Messages
                    </label>
                </div>
            </div>
            <div class="table-container">
                <div id="combinedHistoryList" class="combined-history-list">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        Loading data...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="confirmation-modal">
        <div class="confirmation-content">
            <div class="confirmation-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h4>Confirm Payment Settlement</h4>
            </div>
            <div class="confirmation-body">
                <h4>Are you sure you want to settle this pending amount?</h4>
                <div class="confirmation-details">
                    <p><strong>Mechanic:</strong> <span id="confirmMechanicName"></span></p>
                    <p><strong>Amount to Settle:</strong> <span id="confirmAmount" class="confirmation-amount"></span></p>
                </div>
                <p style="color: #64748b; font-size: 0.9rem;">This action will create a manual payment record and update the pending balance.</p>
            </div>
            <div class="confirmation-footer">
                <button class="btn btn-secondary" onclick="closeConfirmationModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmSettleBtn" onclick="confirmSettle()">
                    <i class="fas fa-check"></i>
                    Yes, Settle Payment
                </button>
            </div>
        </div>
    </div>

    <!-- Create Payment Modal -->
    <div id="createPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Create Manual Payment</h4>
                <button class="close" onclick="closeCreateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Mechanic *</label>
                    <select class="form-control" id="mechanicSelect" required>
                        <option value="">Choose a mechanic...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Payment Amount *</label>
                    <input type="number" class="form-control" id="paymentAmount" placeholder="Enter amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Remarks (Optional)</label>
                    <textarea class="form-control" id="paymentRemarks" placeholder="Enter any additional notes..." rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button class="btn btn-success" id="createPaymentBtn" onclick="createPayment()">
                    <i class="fas fa-plus"></i>
                    Create Payment
                </button>
            </div>
        </div>
    </div>

    <script>
        let mechanics = [];
        let paymentData = {
            overall_payment: {},
            mechanic_pending: [],
            daily_payouts: []
        };
        let mechanicHisabData = [];

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            fetchMechanics();
            fetchPaymentData();
        });

        // Fetch mechanics list
        async function fetchMechanics() {
            try {
                const response = await fetch('https://ai.instantmechanic.online/bot/api/mechanic/', {
                    headers: {
                        'Accept': '*/*',
                        'Origin': 'https://instantmechanic.online',
                        'Referer': 'https://instantmechanic.online/',
                    }
                });
                mechanics = await response.json();
                populateMechanicSelect();
            } catch (error) {
                console.error('Error fetching mechanics:', error);
                showAlert('error', 'Failed to fetch mechanics list');
            }
        }

        // Populate mechanic select dropdown
        function populateMechanicSelect() {
            const select = document.getElementById('mechanicSelect');
            const filterSelect = document.getElementById('mechanicNameFilter');
            
            // Clear existing options
            select.innerHTML = '<option value="">Choose a mechanic...</option>';
            filterSelect.innerHTML = '<option value="">All Mechanics</option>';
            
            mechanics.forEach(mechanic => {
                // For create payment modal
                const option = document.createElement('option');
                option.value = mechanic.id;
                option.textContent = `${mechanic.name} (${mechanic.mobile})`;
                select.appendChild(option);

                // For filter dropdown
                const filterOption = document.createElement('option');
                filterOption.value = mechanic.name;
                filterOption.textContent = `${mechanic.name} (${mechanic.mobile})`;
                filterSelect.appendChild(filterOption);
            });
        }

        // Fetch payment data
        async function fetchPaymentData() {
            try {
                const params = new URLSearchParams();
                const mechanicName = document.getElementById('mechanicNameFilter').value;
                const startDate = document.getElementById('startDateFilter').value;
                const endDate = document.getElementById('endDateFilter').value;

                if (mechanicName) params.append('mechanic_name', mechanicName);
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);

                const response = await fetch(`https://ai.instantmechanic.online/bot/api/mechanic_payment_overview?${params}`);
                paymentData = await response.json();
                
                updateOverviewCards();
                updateMechanicPendingTable();
                updateDailyPayoutsTable();
                
                // If a specific mechanic is selected, load their timeline
                if (mechanicName) {
                    const mechanic = mechanics.find(m => m.name === mechanicName);
                    if (mechanic) {
                        loadMechanicTimeline(mechanic.id, mechanicName);
                    }
                }
            } catch (error) {
                console.error('Error fetching payment data:', error);
                showAlert('error', 'Failed to fetch payment data');
            }
        }

        // Fetch mechanic hisab data
        async function fetchMechanicHisab(mechanicId) {
            try {
                const response = await fetch(`https://ai.instantmechanic.online/bot/mechanics-hisab/${mechanicId}/hisab/`, {
                    headers: {
                        'Accept': '*/*',
                        'Content-Type': 'application/json'
                    }
                });
                return await response.json();
            } catch (error) {
                console.error('Error fetching mechanic hisab:', error);
                return [];
            }
        }

        // Send hisab on WhatsApp
        async function sendHisabWhatsApp(mechanicName, pendingAmount) {
            const mechanic = mechanics.find(m => m.name === mechanicName);
            if (!mechanic) {
                showAlert('error', 'Mechanic not found');
                return;
            }

            // Create proper IST timestamp
            const now = new Date();

            const options = {
            timeZone: 'Asia/Kolkata',
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: 'numeric',
            minute: 'numeric',
            hour12: true
            };

            let istTimeString = now.toLocaleString('hi-IN', options);

            // Replace "अ" and "PM/AM" issues
            istTimeString = istTimeString
            .replace('अ', '')   // some systems show "अ."
            .replace('PM', 'PM')
            .replace('am', 'AM')
            .replace('pm', 'PM');


            const whatsappMessage = `नमस्ते *${mechanicName}* जी 🙏\n\nआपका कुल बकाया *${formatCurrency(pendingAmount)}* है 🚨🚨\n\nये *${istTimeString}* बजे तक का हिसाब।\nअगर हिसाब में कोई गलती लगे या कुछ पूछना हो,तो आप सीधे मुझे कॉल 📞 कर सकते हो।\n\n👉 हिसाब देखे: https://instantmechanic.online/mechanic-view.html?mechanic=${encodeURIComponent(mechanicName)}\nMehak – +91 89682 73229\nTeam Instant Mechanic`;


            // Create WhatsApp URL
            const whatsappUrl = `https://wa.me/91${mechanic.mobile}?text=${encodeURIComponent(whatsappMessage)}`;

            // Open WhatsApp
            window.open(whatsappUrl, '_blank');

            // Record the hisab message
            try {
                const response = await fetch(`https://ai.instantmechanic.online/bot/mechanics-hisab/${mechanic.id}/hisab/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*'
                    },
                    body: JSON.stringify({
                        pending_amount: pendingAmount.toString(),
                        message: `Message send on whatsapp at ${istTimeString}`
                    })
                });

                if (response.ok) {
                    showAlert('success', `Hisab message sent to ${mechanicName} on WhatsApp!`);
                    // Refresh the timeline if the mechanic is currently selected
                    const mechanicFilter = document.getElementById('mechanicNameFilter').value;
                    if (mechanicFilter === mechanicName) {
                        loadMechanicTimeline(mechanic.id, mechanicName);
                    }
                } else {
                    showAlert('error', 'WhatsApp message sent, but failed to record the entry');
                }
            } catch (error) {
                console.error('Error recording hisab:', error);
                showAlert('error', 'WhatsApp message sent, but failed to record the entry');
            }
        }

        let showWhatsAppMessages = false;

        // Toggle WhatsApp messages visibility
        function toggleWhatsAppMessages() {
            showWhatsAppMessages = document.getElementById('showWhatsAppToggle').checked;
            updateCombinedHistoryList();
        }

        // Load mechanic timeline (payouts + hisab messages)
        async function loadMechanicTimeline(mechanicId, mechanicName) {
            const dailyPayoutsSection = document.getElementById('dailyPayoutsSection');
            const combinedHistoryList = document.getElementById('combinedHistoryList');
            
            dailyPayoutsSection.style.display = 'block';
            
            combinedHistoryList.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    Loading data...
                </div>
            `;

            try {
                // Fetch hisab data
                mechanicHisabData = await fetchMechanicHisab(mechanicId);
                updateCombinedHistoryList();
                
            } catch (error) {
                console.error('Error loading timeline:', error);
                combinedHistoryList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>Failed to load data</div>
                    </div>
                `;
            }
        }

        // Update combined history list with enhanced sorting by payout_date
        function updateCombinedHistoryList() {
            const combinedHistoryList = document.getElementById('combinedHistoryList');
            const mechanicFilter = document.getElementById('mechanicNameFilter').value;
            
            if (!mechanicFilter) {
                combinedHistoryList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-check"></i>
                        <div>Please select a mechanic to view history</div>
                    </div>
                `;
                return;
            }

            // Get filtered payouts for this mechanic
            const mechanicPayouts = paymentData.daily_payouts.filter(p => p.mechanic_name === mechanicFilter);
            
            // Group payouts by date to find live vs historical
            const payoutsByDate = {};
            mechanicPayouts.forEach(payout => {
                if (!payoutsByDate[payout.payout_date]) {
                    payoutsByDate[payout.payout_date] = {
                        live: [],
                        historical: []
                    };
                }
                
                if (payout.is_deleted) {
                    payoutsByDate[payout.payout_date].historical.push(payout);
                } else {
                    payoutsByDate[payout.payout_date].live.push(payout);
                }
            });

            // Create combined entries array with only live payouts
            const allEntries = [];
            
            // Add ALL live payout entries (multiple payouts per date if they exist)
            Object.keys(payoutsByDate).forEach(date => {
                const dateGroup = payoutsByDate[date];
                
                // Add ALL live entries for this date (not just the latest one)
                if (dateGroup.live.length > 0) {
                    // Sort live payouts by created_at (latest first)
                    const sortedLivePayouts = dateGroup.live.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    // Add each live payout as a separate entry
                    sortedLivePayouts.forEach((livePayout, index) => {
                        allEntries.push({
                            type: 'payout',
                            date: livePayout.created_at || livePayout.payout_date,
                            payout_date: livePayout.payout_date,
                            data: livePayout,
                            // Use payout_date as primary sort criteria for payouts
                            sortDate: new Date(livePayout.payout_date + 'T00:00:00'),
                            // Only show historical data for the first (latest) live payout of each date
                            hasHistory: index === 0 && dateGroup.historical.length > 0,
                            historicalCount: dateGroup.historical.length,
                            historicalData: dateGroup.historical.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                        });
                    });
                }
            });
            
            // Add hisab entries only if toggle is on
            if (showWhatsAppMessages && mechanicHisabData) {
                mechanicHisabData.forEach(hisab => {
                    allEntries.push({
                        type: 'whatsapp',
                        date: hisab.created_at,
                        data: hisab,
                        sortDate: new Date(hisab.created_at)
                    });
                });
            }
            
            // UPDATED: Enhanced sorting - payout entries by payout_date (latest first), WhatsApp by created_at
            allEntries.sort((a, b) => {
                // If both are payouts, sort by payout_date (latest first)
                if (a.type === 'payout' && b.type === 'payout') {
                    return new Date(b.data.payout_date) - new Date(a.data.payout_date);
                }
                // If both are WhatsApp, sort by created_at (latest first)
                if (a.type === 'whatsapp' && b.type === 'whatsapp') {
                    return new Date(b.data.created_at) - new Date(a.data.created_at);
                }
                // Mixed types: sort by their respective dates
                return b.sortDate - a.sortDate;
            });
            
            if (allEntries.length === 0) {
                combinedHistoryList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <div>No data found for this mechanic</div>
                    </div>
                `;
                return;
            }

            // Render entries
            let listHtml = '';
            
            allEntries.forEach((entry, index) => {
                if (entry.type === 'payout') {
                    const payout = entry.data;
                    
                    listHtml += `
                        <div class="history-entry payout-entry" id="entry-${index}">
                            <div class="history-entry-header">
                                <div class="history-entry-datetime">
                                    ${formatDateTime(entry.date)}
                                </div>
                                <div class="history-entry-main-content">
                                    <div class="payout-date-highlight">
                                        <i class="fas fa-calendar-alt"></i>
                                        ${formatDate(payout.payout_date)}
                                    </div>
                                    <div class="entry-meta-info">
                                        <div class="meta-item">
                                            <span class="meta-label">Calls:</span>
                                            <span>${payout.total_calls || 0}</span>
                                        </div>
                                        ${payout.remarks ? `
                                            <div class="meta-item">
                                                <span class="meta-label">Remarks:</span>
                                                <span>${payout.remarks}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="history-entry-type live-payout">
                                    <i class="fas fa-circle"></i>
                                    Live Payment
                                </div>
                                <div class="history-entry-amount ${payout.pending_amount >= 0 ? 'positive' : 'negative'}">
                                    ${formatCurrency(payout.pending_amount)}
                                </div>
                                <div class="history-entry-actions">
                                    ${entry.hasHistory ? `
                                        <button class="history-entry-expand" onclick="toggleHistoricalData(${index})" id="expand-btn-${index}">
                                            <i class="fas fa-chevron-down"></i> 
                                            History (${entry.historicalCount})
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-primary" onclick="viewDetails('${payout.payout_date}', '${mechanicFilter}')" style="padding: 8px 16px; font-size: 0.8rem;">
                                        <i class="fas fa-eye"></i>
                                        View Details
                                    </button>
                                </div>
                            </div>
                            ${entry.hasHistory ? `
                                <div class="historical-data-container" id="historical-${index}" style="display: none;">
                                    <div class="historical-header">
                                        <i class="fas fa-history"></i>
                                        <span>Historical Records for ${formatDate(payout.payout_date)}</span>
                                    </div>
                                    <div class="historical-entries">
                                        ${entry.historicalData.map(hist => `
                                            <div class="historical-entry">
                                                <div class="historical-entry-header">
                                                    <div class="historical-datetime">${formatDateTime(hist.created_at)}</div>
                                                    <div class="historical-amount ${hist.pending_amount >= 0 ? 'positive' : 'negative'}">
                                                        ${formatCurrency(hist.pending_amount)}
                                                    </div>
                                                </div>
                                                <div class="historical-details">
                                                    <div class="detail-row"><strong>Calls:</strong> ${hist.total_calls || 0}</div>
                                                    ${hist.remarks ? `<div class="detail-row"><strong>Remarks:</strong> ${hist.remarks}</div>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else if (entry.type === 'whatsapp') {
                    const hisab = entry.data;
                    listHtml += `
                        <div class="history-entry whatsapp-entry">
                            <div class="history-entry-header">
                                <div class="history-entry-datetime">
                                    ${formatDateTime(entry.date)}
                                </div>
                                <div class="history-entry-main-content">
                                    <div class="payout-date-highlight" style="color: #25d366;">
                                        <i class="fab fa-whatsapp"></i>
                                        WhatsApp Message Sent
                                    </div>
                                    <div class="entry-meta-info">
                                        <div class="whatsapp-message-details" style="margin: 0; background: none; border: none; padding: 0;">
                                            ${hisab.message}
                                        </div>
                                    </div>
                                </div>
                                <div class="history-entry-type whatsapp">
                                    <i class="fab fa-whatsapp"></i>
                                    WhatsApp
                                </div>
                                <div class="history-entry-amount ${hisab.pending_amount >= 0 ? 'positive' : 'negative'}">
                                    ${formatCurrency(hisab.pending_amount)}
                                </div>
                                <div class="history-entry-actions">
                                    <div class="hisab-status">
                                        <i class="fas fa-check-circle"></i>
                                        Hisab Sent
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            combinedHistoryList.innerHTML = listHtml;
        }

        // Toggle historical data visibility
        function toggleHistoricalData(index) {
            const historicalContainer = document.getElementById(`historical-${index}`);
            const expandBtn = document.getElementById(`expand-btn-${index}`);
            
            if (historicalContainer) {
                const isVisible = historicalContainer.style.display !== 'none';
                
                if (isVisible) {
                    historicalContainer.style.display = 'none';
                    expandBtn.innerHTML = '<i class="fas fa-chevron-down"></i> History (' + expandBtn.textContent.match(/\d+/)[0] + ')';
                    expandBtn.classList.remove('expanded');
                } else {
                    historicalContainer.style.display = 'block';
                    expandBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Hide History (' + expandBtn.textContent.match(/\d+/)[0] + ')';
                    expandBtn.classList.add('expanded');
                }
            }
        }

        // Sync payments
        async function syncPayments() {
            const syncBtn = document.getElementById('syncBtn');
            syncBtn.disabled = true;
            syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';

            try {
                const response = await fetch('https://ai.instantmechanic.online/bot/api/sync_mechanic_payment', {
                    method: 'GET',
                    headers: {
                        'Accept': '*/*',
                        'Origin': 'https://instantmechanic.online',
                        'Referer': 'https://instantmechanic.online/',
                    }
                });

                if (response.ok) {
                    showAlert('success', 'Payments synchronized successfully! Reloading page...');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error('Sync failed');
                }
            } catch (error) {
                console.error('Error syncing payments:', error);
                showAlert('error', 'Failed to sync payments. Please try again.');
                syncBtn.disabled = false;
                syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Sync Payments';
            }
        }

        // Update overview cards
        function updateOverviewCards() {
            const totalPendingEl = document.getElementById('totalPending');
            const lastUpdatedEl = document.getElementById('lastUpdated');
            const mechanicsWithPendingEl = document.getElementById('mechanicsWithPending');
            const recentPayoutsEl = document.getElementById('recentPayouts');

            // Total pending
            const totalPending = paymentData.overall_payment.pending_payments || 0;
            totalPendingEl.textContent = formatCurrency(totalPending);
            
            // Last updated
            if (paymentData.overall_payment.updated_at) {
                lastUpdatedEl.textContent = `Last updated: ${formatDateTime(paymentData.overall_payment.updated_at)}`;
            }

            // Mechanics with pending
            const mechanicsWithPending = paymentData.mechanic_pending.filter(m => Math.abs(m.pending_balance) > 0).length;
            mechanicsWithPendingEl.textContent = mechanicsWithPending;

            // Recent payouts (today)
            const today = new Date().toISOString().split('T')[0];
            const todayPayouts = paymentData.daily_payouts.filter(p => p.payout_date === today && !p.is_deleted).length;
            recentPayoutsEl.textContent = todayPayouts;
        }

        // Update mechanic pending table
        function updateMechanicPendingTable() {
            const tbody = document.getElementById('mechanicPendingTableBody');
            
            if (paymentData.mechanic_pending.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <div>No pending balances found</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort by pending balance from high to low
            const sortedMechanics = [...paymentData.mechanic_pending].sort((a, b) => b.pending_balance - a.pending_balance);

            tbody.innerHTML = sortedMechanics.map(item => `
                <tr>
                    <td>
                        <span class="mechanic-name-link" onclick="selectMechanicForPayouts('${item.mechanic_name}')">
                            ${item.mechanic_name}
                        </span>
                    </td>
                    <td class="${item.pending_balance >= 0 ? 'amount-positive' : 'amount-negative'}">
                        ${formatCurrency(item.pending_balance)}
                    </td>
                    <td>${formatDateTime(item.updated_at)}</td>
                    <td>
                        <div class="pending-balance">
                            ${Math.abs(item.pending_balance) > 0 ? 
                                '<div class="pending-icon"></div><span class="has-pending">Pending</span>' : 
                                '<i class="fas fa-check-circle" style="color: #10b981;"></i><span class="no-pending">Clear</span>'
                            }
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${Math.abs(item.pending_balance) > 0 ? `
                                <button class="btn btn-settle" onclick="settlePending('${item.mechanic_name}', ${item.pending_balance})">
                                    <i class="fas fa-credit-card"></i>
                                    Settle Pending
                                </button>
                                <button class="btn btn-whatsapp" onclick="sendHisabWhatsApp('${item.mechanic_name}', ${item.pending_balance})">
                                    <i class="fab fa-whatsapp"></i>
                                    Send Hisab
                                </button>
                            ` : '<span class="settled-badge"><i class="fas fa-check"></i> Settled</span>'}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update daily payouts table with combined list view
        function updateDailyPayoutsTable() {
            const dailyPayoutsSection = document.getElementById('dailyPayoutsSection');
            const mechanicFilter = document.getElementById('mechanicNameFilter').value;
            
            // Show/hide section based on mechanic filter
            if (!mechanicFilter) {
                dailyPayoutsSection.style.display = 'none';
                return;
            } else {
                dailyPayoutsSection.style.display = 'block';
                // Find mechanic and load timeline
                const mechanic = mechanics.find(m => m.name === mechanicFilter);
                if (mechanic) {
                    loadMechanicTimeline(mechanic.id, mechanicFilter);
                } else {
                    updateCombinedHistoryList();
                }
            }
        }

        // View details function
        function viewDetails(date, mechanicName) {
            const baseUrl = 'https://instantmechanic.online/admin-booking-dashbaord.html';
            const params = new URLSearchParams({
                date: date,
                mechanic: mechanicName,
                cancelled: 'false'
            });
            
            const fullUrl = `${baseUrl}?${params.toString()}`;
            window.open(fullUrl, '_blank');
        }

        // Apply filters
        function applyFilters() {
            fetchPaymentData();
        }

        // Select mechanic for payouts view
        function selectMechanicForPayouts(mechanicName) {
            const mechanicFilter = document.getElementById('mechanicNameFilter');
            mechanicFilter.value = mechanicName;
            fetchPaymentData();
        }

        // Settle pending payment
        function settlePending(mechanicName, pendingAmount) {
            // Find the mechanic ID
            const mechanic = mechanics.find(m => m.name === mechanicName);
            if (!mechanic) {
                showAlert('error', 'Mechanic not found');
                return;
            }

            // Store settlement data for confirmation
            window.settlementData = {
                mechanicId: mechanic.id,
                mechanicName: mechanicName,
                amount: pendingAmount
            };

            // Show confirmation modal
            document.getElementById('confirmMechanicName').textContent = mechanicName;
            document.getElementById('confirmAmount').textContent = formatCurrency(pendingAmount);
            document.getElementById('confirmationModal').style.display = 'block';
        }

        // Close confirmation modal
        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
            window.settlementData = null;
        }

        // Confirm and execute settlement
        async function confirmSettle() {
            if (!window.settlementData) {
                showAlert('error', 'Settlement data not found');
                return;
            }

            const confirmBtn = document.getElementById('confirmSettleBtn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            try {
                const response = await fetch('https://ai.instantmechanic.online/bot/api/create_mechanic_payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*',
                        'Origin': 'https://instantmechanic.online',
                        'Referer': 'https://instantmechanic.online/',
                    },
                    body: JSON.stringify({
                        mechanic_id: window.settlementData.mechanicId,
                        pending_amount: window.settlementData.amount,
                        remarks: `Pending balance settlement of ${formatCurrency(window.settlementData.amount)} for ${window.settlementData.mechanicName}`
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('success', `Payment of ${formatCurrency(window.settlementData.amount)} settled successfully for ${window.settlementData.mechanicName}!`);
                    closeConfirmationModal();
                    fetchPaymentData(); // Refresh data
                } else {
                    showAlert('error', result.error || 'Failed to settle payment');
                }
            } catch (error) {
                console.error('Error settling payment:', error);
                showAlert('error', 'Failed to settle payment');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-check"></i> Yes, Settle Payment';
            }
        }

        // Open create modal
        function openCreateModal() {
            document.getElementById('createPaymentModal').style.display = 'block';
            // Reset form
            document.getElementById('mechanicSelect').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentRemarks').value = '';
        }

        // Close create modal
        function closeCreateModal() {
            document.getElementById('createPaymentModal').style.display = 'none';
        }

        // Create payment
        async function createPayment() {
            const mechanicId = document.getElementById('mechanicSelect').value;
            const amount = document.getElementById('paymentAmount').value;
            const remarks = document.getElementById('paymentRemarks').value;

            if (!mechanicId || !amount) {
                showAlert('error', 'Please fill in all required fields');
                return;
            }

            const createBtn = document.getElementById('createPaymentBtn');
            createBtn.disabled = true;
            createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

            try {
                const requestBody = {
                    mechanic_id: parseInt(mechanicId),
                    pending_amount: parseFloat(amount)
                };

                // Only add remarks if it's not empty
                if (remarks.trim()) {
                    requestBody.remarks = remarks;
                }

                const response = await fetch('https://ai.instantmechanic.online/bot/api/create_mechanic_payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*',
                        'Origin': 'https://instantmechanic.online',
                        'Referer': 'https://instantmechanic.online/',
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('success', 'Payment recorded successfully!');
                    closeCreateModal();
                    fetchPaymentData(); // Refresh data
                } else {
                    showAlert('error', result.error || 'Failed to create payment');
                }
            } catch (error) {
                console.error('Error creating payment:', error);
                showAlert('error', 'Failed to create payment');
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = '<i class="fas fa-plus"></i> Create Payment';
            }
        }

        // Show alert
        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alert = document.createElement('div');
            alert.id = alertId;
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${message}
            `;
            
            container.appendChild(alert);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                const alertEl = document.getElementById(alertId);
                if (alertEl) {
                    alertEl.remove();
                }
            }, 5000);
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0
            }).format(amount || 0);
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Format date and time
        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('createPaymentModal');
            const confirmModal = document.getElementById('confirmationModal');
            if (event.target === modal) {
                closeCreateModal();
            }
            if (event.target === confirmModal) {
                closeConfirmationModal();
            }
        }
    </script>

    <script>
// Fix for stamp overlapping with buttons - update the paid stamp positioning
const originalUpdateCombinedHistoryList = updateCombinedHistoryList;

updateCombinedHistoryList = function() {
    const combinedHistoryList = document.getElementById('combinedHistoryList');
    const mechanicFilter = document.getElementById('mechanicNameFilter').value;
    
    if (!mechanicFilter) {
        combinedHistoryList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-user-check"></i>
                <div>Please select a mechanic to view history</div>
            </div>
        `;
        return;
    }

    // Get filtered payouts for this mechanic
    const mechanicPayouts = paymentData.daily_payouts.filter(p => p.mechanic_name === mechanicFilter);
    
    // Group payouts by date to find live vs historical
    const payoutsByDate = {};
    mechanicPayouts.forEach(payout => {
        if (!payoutsByDate[payout.payout_date]) {
            payoutsByDate[payout.payout_date] = {
                live: [],
                historical: []
            };
        }
        
        if (payout.is_deleted) {
            payoutsByDate[payout.payout_date].historical.push(payout);
        } else {
            payoutsByDate[payout.payout_date].live.push(payout);
        }
    });

    // Create combined entries array with only live payouts
    const allEntries = [];
    
    // Add ALL live payout entries (multiple payouts per date if they exist)
    Object.keys(payoutsByDate).forEach(date => {
        const dateGroup = payoutsByDate[date];
        
        // Add ALL live entries for this date (not just the latest one)
        if (dateGroup.live.length > 0) {
            // Sort live payouts by created_at (latest first)
            const sortedLivePayouts = dateGroup.live.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Add each live payout as a separate entry
            sortedLivePayouts.forEach((livePayout, index) => {
                allEntries.push({
                    type: 'payout',
                    date: livePayout.created_at || livePayout.payout_date,
                    payout_date: livePayout.payout_date,
                    data: livePayout,
                    // Use payout_date as primary sort criteria for payouts
                    sortDate: new Date(livePayout.payout_date + 'T00:00:00'),
                    // Only show historical data for the first (latest) live payout of each date
                    hasHistory: index === 0 && dateGroup.historical.length > 0,
                    historicalCount: dateGroup.historical.length,
                    historicalData: dateGroup.historical.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                });
            });
        }
    });
    
    // Add hisab entries only if toggle is on
    if (showWhatsAppMessages && mechanicHisabData) {
        mechanicHisabData.forEach(hisab => {
            allEntries.push({
                type: 'whatsapp',
                date: hisab.created_at,
                data: hisab,
                sortDate: new Date(hisab.created_at)
            });
        });
    }
    
    // UPDATED: Enhanced sorting - payout entries by payout_date (latest first), WhatsApp by created_at
    allEntries.sort((a, b) => {
        // If both are payouts, sort by payout_date (latest first)
        if (a.type === 'payout' && b.type === 'payout') {
            return new Date(b.data.payout_date) - new Date(a.data.payout_date);
        }
        // If both are WhatsApp, sort by created_at (latest first)
        if (a.type === 'whatsapp' && b.type === 'whatsapp') {
            return new Date(b.data.created_at) - new Date(a.data.created_at);
        }
        // Mixed types: sort by their respective dates
        return b.sortDate - a.sortDate;
    });
    
    if (allEntries.length === 0) {
        combinedHistoryList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <div>No data found for this mechanic</div>
            </div>
        `;
        return;
    }

    // Render entries
    let listHtml = '';
    
    allEntries.forEach((entry, index) => {
        if (entry.type === 'payout') {
            const payout = entry.data;
            const isPaid = payout.payment_transfer === true;
            
            listHtml += `
                <div class="history-entry payout-entry" id="entry-${index}" style="position: relative;">
                    ${isPaid ? `
                        <div class="paid-stamp-overlay" style="
                            position: absolute;
                            top: 15px;
                            left: 90%;
                            transform: translateX(-50%);
                            width: 70px;
                            height: 70px;
                            background-image: url('https://i.ibb.co/zVJswVBy/image-removebg-preview-14.png');
                            background-size: contain;
                            background-repeat: no-repeat;
                            background-position: center;
                            z-index: 10;
                            opacity: 0.85;
                            pointer-events: none;
                        "></div>
                    ` : ''}
                    <div class="history-entry-header" style="${isPaid ? 'padding-top: 35px;' : ''}">
                        <div class="history-entry-datetime">
                            ${formatDateTime(entry.date)}
                        </div>
                        <div class="history-entry-main-content">
                            <div class="payout-date-highlight">
                                <i class="fas fa-calendar-alt"></i>
                                ${formatDate(payout.payout_date)}
                                ${isPaid ? '<span class="live-badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); margin-left: 8px;"><i class="fas fa-check"></i> PAID</span>' : ''}
                            </div>
                            <div class="entry-meta-info">
                                <div class="meta-item">
                                    <span class="meta-label">Calls:</span>
                                    <span>${payout.total_calls || 0}</span>
                                </div>
                                ${payout.remarks ? `
                                    <div class="meta-item">
                                        <span class="meta-label">Remarks:</span>
                                        <span>${payout.remarks}</span>
                                    </div>
                                ` : ''}
                                ${isPaid ? `
                                    <div class="meta-item">
                                        <span class="meta-label">Payment:</span>
                                        <span style="color: #10b981; font-weight: 700;">Transferred</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="history-entry-type live-payout">
                            <i class="fas fa-circle"></i>
                            Live Payment
                        </div>
                        <div class="history-entry-amount ${payout.pending_amount >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(payout.pending_amount)}
                        </div>
                        <div class="history-entry-actions">
                            ${entry.hasHistory ? `
                                <button class="history-entry-expand" onclick="toggleHistoricalData(${index})" id="expand-btn-${index}">
                                    <i class="fas fa-chevron-down"></i> 
                                    History (${entry.historicalCount})
                                </button>
                            ` : ''}
                            <button class="btn btn-primary" onclick="viewDetails('${payout.payout_date}', '${mechanicFilter}')" style="padding: 8px 16px; font-size: 0.8rem;">
                                <i class="fas fa-eye"></i>
                                View Details
                            </button>
                        </div>
                    </div>
                    ${entry.hasHistory ? `
                        <div class="historical-data-container" id="historical-${index}" style="display: none;">
                            <div class="historical-header">
                                <i class="fas fa-history"></i>
                                <span>Historical Records for ${formatDate(payout.payout_date)}</span>
                            </div>
                            <div class="historical-entries">
                                ${entry.historicalData.map(hist => `
                                    <div class="historical-entry">
                                        <div class="historical-entry-header">
                                            <div class="historical-datetime">${formatDateTime(hist.created_at)}</div>
                                            <div class="historical-amount ${hist.pending_amount >= 0 ? 'positive' : 'negative'}">
                                                ${formatCurrency(hist.pending_amount)}
                                            </div>
                                        </div>
                                        <div class="historical-details">
                                            <div class="detail-row"><strong>Calls:</strong> ${hist.total_calls || 0}</div>
                                            ${hist.remarks ? `<div class="detail-row"><strong>Remarks:</strong> ${hist.remarks}</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        } else if (entry.type === 'whatsapp') {
            const hisab = entry.data;
            listHtml += `
                <div class="history-entry whatsapp-entry">
                    <div class="history-entry-header">
                        <div class="history-entry-datetime">
                            ${formatDateTime(entry.date)}
                        </div>
                        <div class="history-entry-main-content">
                            <div class="payout-date-highlight" style="color: #25d366;">
                                <i class="fab fa-whatsapp"></i>
                                WhatsApp Message Sent
                            </div>
                            <div class="entry-meta-info">
                                <div class="whatsapp-message-details" style="margin: 0; background: none; border: none; padding: 0;">
                                    ${hisab.message}
                                </div>
                            </div>
                        </div>
                        <div class="history-entry-type whatsapp">
                            <i class="fab fa-whatsapp"></i>
                            WhatsApp
                        </div>
                        <div class="history-entry-amount ${hisab.pending_amount >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(hisab.pending_amount)}
                        </div>
                        <div class="history-entry-actions">
                            <div class="hisab-status">
                                <i class="fas fa-check-circle"></i>
                                Hisab Sent
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    combinedHistoryList.innerHTML = listHtml;
};

// Updated CSS styles for better positioning
const paidStampStyles = `
<style>
@media (max-width: 1024px) {
    .paid-stamp-overlay {
        width: 60px !important;
        height: 60px !important;
        top: 12px !important;
    }
    
    .history-entry-header[style*="padding-top"] {
        padding-top: 25px !important;
    }
}

@media (max-width: 768px) {
    .paid-stamp-overlay {
        width: 50px !important;
        height: 50px !important;
        top: 10px !important;
    }
    
    .history-entry-header[style*="padding-top"] {
        padding-top: 20px !important;
    }
}

.history-entry.payout-entry {
    overflow: visible;
}

.paid-stamp-overlay {
    animation: fadeInStamp 0.5s ease-in-out;
}

@keyframes fadeInStamp {
    from {
        opacity: 0;
        transform: translateX(-50%) scale(0.8) rotate(-5deg);
    }
    to {
        opacity: 0.85;
        transform: translateX(-50%) scale(1) rotate(0deg);
    }
}
</style>
`;

// Inject the styles
document.head.insertAdjacentHTML('beforeend', paidStampStyles);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Mechanic Service - Instant Mechanic</title>
    
    <!-- Mixpanel -->
    <script type="text/javascript">
        (function(c,a){if(!a.__SV){var b=window;try{var d,m,j,k=b.location,f=k.hash;d=function(a,b){return(m=a.match(RegExp(b+"=([^&]*)")))?m[1]:null};f&&d(f,"state")&&(j=JSON.parse(decodeURIComponent(d(f,"state"))),"mpeditor"===j.action&&(b.sessionStorage.setItem("_mpcehash",f),history.replaceState(j.desiredHash||"",c.title,k.pathname+k.search)))}catch(n){}var l,h;window.mixpanel=a;a._i=[];a.init=function(b,d,g){function c(b,i){var a=i.split(".");2==a.length&&(b=b[a[0]],i=a[1]);b[i]=function(){b.push([i].concat(Array.prototype.slice.call(arguments,0)))}}var e=a;"undefined"!==
        typeof g?e=a[g]=[]:g="mixpanel";e.people=e.people||[];e.toString=function(b){var a="mixpanel";"mixpanel"!==g&&(a+="."+g);b||(a+=" (stub)");return a};e.people.toString=function(){return e.toString(1)+".people (stub)"};l="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");
        for(h=0;h<l.length;h++)c(e,l[h]);var f="set_config people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");for(h=0;h<f.length;h++)c(e,f[h]);a._i.push([b,d,g])};a.__SV=1.2;b=c.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===c.location.protocol&&"//cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js";
        d=c.getElementsByTagName("script")[0];d.parentNode.insertBefore(b,d)}})(document,window.mixpanel||[]);
        
        // Initialize Mixpanel
        mixpanel.init("afeb927e0d7ee7ddfa033985ab2fe603", {debug: true});
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #ffe803 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .form-container {
            padding: 40px 30px;
        }

        .form-group {
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .form-group.hidden {
            display: none;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .input-wrapper {
            position: relative;
        }

        .phone-input-wrapper {
            display: flex;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .phone-input-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .country-code {
            background: #f3f4f6;
            padding: 14px 16px;
            font-weight: 600;
            color: #374151;
            border-right: 1px solid #e5e7eb;
            font-size: 16px;
        }

        input[type="text"], input[type="tel"], textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .phone-input-wrapper input[type="tel"] {
            border: none;
            border-radius: 0;
            flex: 1;
        }

        input[type="text"]:focus, input[type="tel"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .dropdown-container {
            position: relative;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .dropdown-list.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #f3f4f6;
            font-size: 15px;
            color: #374151;
        }

        .dropdown-item:hover {
            background: #f8fafc;
            color: #667eea;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item.highlighted {
            background: #667eea;
            color: white;
        }

        .no-results {
            padding: 16px;
            text-align: center;
            color: #6b7280;
            font-style: italic;
            background: #f9fafb;
        }

        .dropdown-container input:focus {
            border-radius: 12px 12px 0 0;
        }

        .dropdown-container input:focus + .dropdown-list {
            border-color: #667eea;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .toggle-group:hover {
            background: #f1f5f9;
        }

        .toggle-label {
            font-weight: 500;
            color: #374151;
            font-size: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: #cbd5e0;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .book-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .book-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .book-btn:active {
            transform: translateY(0);
        }

        .book-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid #10b981;
            display: none;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid #ef4444;
            display: none;
        }

        /* Agent Selection Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .popup-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .popup-overlay.show .popup-content {
            transform: scale(1);
        }

        .popup-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .popup-header h2 {
            color: #374151;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .popup-header p {
            color: #6b7280;
            font-size: 16px;
        }

        .agent-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .agent-option {
            padding: 14px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #374151;
            background: white;
            position: relative;
        }

        .agent-option:hover {
            border-color: #667eea;
            background: #f8fafc;
            color: #667eea;
            transform: translateY(-2px);
        }

        .agent-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .agent-option.live::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            box-shadow: 0 0 0 2px white;
        }

        .popup-footer {
            text-align: center;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .confirm-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading state for agent grid */
        .agent-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #6b7280;
            font-style: italic;
        }

        .agent-loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        .error-state {
            padding: 20px;
            text-align: center;
            color: #991b1b;
        }

        .retry-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 12px;
        }

        /* Existing Booking Popup Styles */
        .existing-booking-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .existing-booking-popup.show {
            opacity: 1;
            visibility: visible;
        }

        .existing-booking-content {
            background: white;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.25);
            max-width: 480px;
            width: 90%;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .existing-booking-popup.show .existing-booking-content {
            transform: scale(1) translateY(0);
        }

        .existing-booking-header {
            text-align: center;
            margin-bottom: 28px;
            position: relative;
        }

        .warning-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 28px;
            color: white;
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.3);
        }

        .existing-booking-header h2 {
            color: #1f2937;
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .existing-booking-header p {
            color: #6b7280;
            font-size: 16px;
            line-height: 1.5;
        }

        .booking-details {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 28px;
            border-left: 4px solid #3b82f6;
            position: relative;
            overflow: hidden;
        }

        .booking-details::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1), transparent);
            transform: translateX(30px) translateY(-30px);
        }

        .booking-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            position: relative;
        }

        .booking-detail-item:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
            margin-right: 16px;
        }

        .detail-value {
            color: #1f2937;
            font-size: 16px;
            font-weight: 500;
            text-align: right;
            flex: 1;
            word-break: break-word;
        }

        .price-value {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .time-ago {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #fcd34d;
        }

        .button-group {
            display: flex;
            gap: 14px;
            margin-top: 30px;
        }

        .popup-button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .popup-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .popup-button:hover::before {
            left: 100%;
        }

        .cancel-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .continue-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        @media (max-width: 640px) {
            .container {
                margin: 10px;
                border-radius: 12px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .form-container {
                padding: 30px 20px;
            }

            .agent-grid {
                grid-template-columns: 1fr;
            }

            .popup-content {
                padding: 25px 20px;
            }

            .existing-booking-content {
                padding: 25px 20px;
                margin: 10px;
            }

            .existing-booking-header h2 {
                font-size: 22px;
            }

            .warning-icon {
                width: 56px;
                height: 56px;
                font-size: 24px;
            }

            .button-group {
                flex-direction: column;
                gap: 12px;
            }

            .booking-details {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Agent Selection Popup -->
    <div class="popup-overlay" id="agentPopup">
        <div class="popup-content">
            <div class="popup-header">
                <h2>Select Your Name</h2>
                <p>Please choose your agent name to continue</p>
            </div>
            <div class="agent-grid" id="agentGrid">
                <div class="agent-loading">
                    <div class="agent-loading-spinner"></div>
                    Loading agents...
                </div>
            </div>
            <div class="popup-footer">
                <button class="confirm-btn" id="confirmAgent" disabled>Confirm</button>
            </div>
        </div>
    </div>

    <!-- Existing Booking Popup -->
    <div class="existing-booking-popup" id="existingBookingPopup">
        <div class="existing-booking-content">
            <div class="existing-booking-header">
                <div class="warning-icon">⚠️</div>
                <h2>Existing Booking Found</h2>
                <p>User has an active booking from the last hour</p>
            </div>
            <div class="booking-details" id="existingBookingDetails">
                <!-- Booking details will be populated dynamically -->
            </div>
            <div class="button-group">
                <button class="popup-button cancel-btn" id="cancelExistingBooking">Cancel</button>
                <button class="popup-button continue-btn" id="continueWithBooking">Continue</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Book Mechanic Service</h1>
            <p>Get instant help for your vehicle</p>
        </div>
        
        <div class="form-container">
            <form id="bookingForm">
                <div class="form-group">
                    <div class="toggle-group">
                        <span class="toggle-label">Is GoMechanic Call?</span>
                        <div class="toggle-switch" id="goMechanicToggle">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="mobile">Mobile Number *</label>
                    <div class="phone-input-wrapper">
                        <div class="country-code">+91</div>
                        <input type="tel" id="mobile" name="mobile" placeholder="Enter your mobile number" required maxlength="10" pattern="[0-9]{10}">
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Problem Description *</label>
                    <div class="dropdown-container">
                        <input type="text" id="description" name="description" placeholder="Type to search problems or describe your issue..." required autocomplete="off">
                        <div class="dropdown-list" id="dropdownList">
                            <!-- Dropdown items will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="form-group" id="priceGroup">
                    <label for="price">Price (₹)</label>
                    <input type="text" id="price" name="price" placeholder="Enter service price" value="742">
                </div>

                <div class="form-group">
                    <label for="carModel">Car Model *</label>
                    <div class="dropdown-container">
                        <input type="text" id="carModel" name="carModel" placeholder="Type to search car models or enter manually..." required autocomplete="off">
                        <div class="dropdown-list" id="carModelDropdownList">
                            <!-- Dropdown items will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="location">Location *</label>
                    <input type="text" id="location" name="location" placeholder="Enter your location" required>
                </div>

                <div class="form-group" id="securityAmountGroup">
                    <label for="securityAmount">Mechanic Amount (₹)</label>
                    <input type="text" id="securityAmount" name="securityAmount" placeholder="Enter security amount" value="428">
                </div>

                <button type="submit" class="book-btn" id="bookBtn">
                    <span class="btn-text">Book Now</span>
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Booking...</span>
                    </div>
                </button>

                <div class="success-message" id="successMessage">
                    ✅ Booking successful! We'll contact you shortly.
                </div>

                <div class="error-message" id="errorMessage">
                    ❌ Something went wrong. Please try again.
                </div>
            </form>
        </div>
    </div>

    <script>
        // Problem list for dropdown
        const problemList = [
            'Battery Jump Start',
            'Car Not Starting',
            'Tyre Puncture',
            'Stepney Change',
            'Key Lockout',
            'Clutch Issue',
            'Brake Issue',
            'Towing',
            'Steering Lock',
            'Minor Auto Repair',
            'Fuel Delivery',
            'Car Self-Start Issue',
            'Fuse Issue',
            'Mirror Temporary Fix',
            'Gear Issue',
            'Coolant Leak',
            'Heating Issue',
            'Acceleration Issue',
            'Bumper Fix',
            'Petrol-Diesel Mix',
            'Roadside Assistance',
            'Major Issue'
        ];

        const carModelsList = [
            'Swift - Maruti Suzuki',
            'WagonR - Maruti Suzuki',
            'Swift Dzire - Maruti Suzuki',
            'Baleno - Maruti Suzuki',
            'Alto - Maruti Suzuki',
            'Ritz - Maruti Suzuki',
            'Celerio - Maruti Suzuki',
            'Estilo - Maruti Suzuki',
            'SX4 - Maruti Suzuki',
            '800 - Maruti Suzuki',
            'Zen - Maruti Suzuki',
            'A-Star - Maruti Suzuki',
            'Ignis - Maruti Suzuki',
            'S-Cross - Maruti Suzuki',
            'Eeco - Maruti Suzuki',
            'Esteem - Maruti Suzuki',
            'Omni - Maruti Suzuki',
            'S-Presso - Maruti Suzuki',
            'Grand Vitara - Maruti Suzuki',
            'Gypsy - Maruti Suzuki',
            'Kizashi - Maruti Suzuki',
            'Versa - Maruti Suzuki',
            'XL6 - Maruti Suzuki',
            'New Grand Vitara - Maruti Suzuki',
            'Invicto - Maruti Suzuki',
            'Jimny - Maruti Suzuki',
            'Fronx - Maruti Suzuki',
            'i10 - Hyundai',
            'i20 - Hyundai',
            'Grand i10 - Hyundai',
            'Santro Xing - Hyundai',
            'Eon - Hyundai',
            'Xcent - Hyundai',
            'Elite i20 - Hyundai',
            'Creta - Hyundai',
            'Alcazar - Hyundai',
            'Verna Fluidic - Hyundai',
            'Verna - Hyundai',
            'Accent - Hyundai',
            'Santro - Hyundai',
            'i20 Active - Hyundai',
            'Elantra - Hyundai',
            'Getz - Hyundai',
            'Venue - Hyundai',
            'Grand i10 Nios - Hyundai',
            'Verna Transform - Hyundai',
            'Getz Prime - Hyundai',
            'Kona - Hyundai',
            'Accent Viva - Hyundai',
            'SantaFE - Hyundai',
            'Tucson - Hyundai',
            'Sonata - Hyundai',
            'Sonata Embera - Hyundai',
            'Aura - Hyundai',
            'Sonata Transform - Hyundai',
            'Venue N Line - Hyundai',
            'i20 N Line - Hyundai',
            'Exter - Hyundai',
            'City IVTEC - Honda',
            'Amaze - Honda',
            'City - Honda',
            'Brio - Honda',
            'Jazz - Honda',
            'Civic - Honda',
            'Accord - Honda',
            'City ZX - Honda',
            'WRV - Honda',
            'Mobilio - Honda',
            'City IDTEC - Honda',
            'CRV - Honda',
            'BRV - Honda',
            'Accord Hybrid - Honda',
            'Elevate - Honda',
            'Tiago - Tata',
            'Tiago NRG - Tata',
            'Nano - Tata',
            'Zest - Tata',
            'Nexon - Tata',
            'Indica Vista - Tata',
            'Tigor - Tata',
            'Manza - Tata',
            'Indica - Tata',
            'Indigo - Tata',
            'Safari - Tata',
            'Indigo eCS - Tata',
            'Indica V2 - Tata',
            'Bolt - Tata',
            'Indigo CS - Tata',
            'Safari Storme - Tata',
            'Nano Genx - Tata',
            'Indica eV2 - Tata',
            'Altroz - Tata',
            'Aria - Tata',
            'Harrier - Tata',
            'Hexa - Tata',
            'Sumo Grande - Tata',
            'Indigo Marina - Tata',
            'Sumo Gold - Tata',
            'Sumo Grande MK II - Tata',
            'Venture - Tata',
            'Indigo XL - Tata',
            'Sumo Spacio - Tata',
            'Winger - Tata',
            'Xenon - Tata',
            'Sumo Victa - Tata',
            'Curvv - Tata',
            'Punch - Tata',
            'Figo - Ford',
            'Eco Sport - Ford',
            'Figo Aspire - Ford',
            'Fiesta - Ford',
            'Fiesta Classic - Ford',
            'Ikon - Ford',
            'Endeavour - Ford',
            'Freestyle - Ford',
            'Fusion - Ford',
            'Escort - Ford',
            'Mondeo - Ford',
            'Mustang - Ford',
            'Polo - Volkswagen',
            'Vento - Volkswagen',
            'Ameo - Volkswagen',
            'Cross Polo - Volkswagen',
            'Jetta - Volkswagen',
            'Passat - Volkswagen',
            'Taigun - Volkswagen',
            'T-Roc - Volkswagen',
            'Beetle - Volkswagen',
            'XUV 500 - Mahindra',
            'Scorpio - Mahindra',
            'KUV 100 - Mahindra',
            'Xylo - Mahindra',
            'TUV 300 - Mahindra',
            'Bolero Neo - Mahindra',
            'Quanto - Mahindra',
            'Bolero - Mahindra',
            'Imperio  - Mahindra',
            'Logan - Mahindra',
            'Verito - Mahindra',
            'XUV 300 - Mahindra',
            'Thar - Mahindra',
            'Bolero Camper - Mahindra',
            'NuvoSport - Mahindra',
            'Marazzo - Mahindra',
            'XUV 700 - Mahindra',
            'Verito Vibe CS - Mahindra',
            'Bolero Pickup - Mahindra',
            'Scorpio Getaway - Mahindra',
            'Alturas G4 - Mahindra',
            'E20 Plus - Mahindra',
            'TUV 300 Plus - Mahindra',
            'Scorpio N - Mahindra',
            'Reva - Mahindra',
            'Thar Roxx - Mahindra',
            'XEV 9e - Mahindra',
            'BE 6  - Mahindra',
            'XUV 3XO - Mahindra',
            'Kwid - Renault',
            'Duster - Renault',
            'Scala - Renault',
            'Pulse - Renault',
            'Fluence - Renault',
            'Triber - Renault',
            'Lodgy - Renault',
            'Captur - Renault',
            'Koleos - Renault',
            'Kiger - Renault',
            'Beat - Chevrolet',
            'Spark - Chevrolet',
            'Cruze - Chevrolet',
            'Aveo - Chevrolet',
            'Sail - Chevrolet',
            'Enjoy - Chevrolet',
            'UVA - Chevrolet',
            'Optra - Chevrolet',
            'Sail Hatchback - Chevrolet',
            'Optra Magnum - Chevrolet',
            'Tavera - Chevrolet',
            'Optra SRV - Chevrolet',
            'Captiva - Chevrolet',
            'Forester - Chevrolet',
            'Trailblazer - Chevrolet',
            'Sera - Toyota',
            'Etios - Toyota',
            'Innova - Toyota',
            'Corolla Altis - Toyota',
            'Etios Liva - Toyota',
            'Fortuner - Toyota',
            'Hilux - Toyota',
            'Innova Crysta - Toyota',
            'Corolla - Toyota',
            'Qualis - Toyota',
            'Etios Cross - Toyota',
            'Yaris - Toyota',
            'Camry - Toyota',
            'Glanza - Toyota',
            'Land Cruiser - Toyota',
            'Land Cruiser Prado - Toyota',
            'Urban Cruiser - Toyota',
            'Alphard - Toyota',
            'Vellfire - Toyota',
            'Urban Cruiser Hyryder - Toyota',
            'Innova Hycross - Toyota',
            'Rapid - Skoda',
            'Fabia - Skoda',
            'Superb - Skoda',
            'Laura - Skoda',
            'Octavia - Skoda',
            'Yeti - Skoda',
            'Fabia Scout - Skoda',
            'Kodiaq - Skoda',
            'Kushaq - Skoda',
            'Slavia - Skoda',
            'Kylaq - Skoda',
            'Micra - Nissan',
            'Sunny - Nissan',
            'Terrano - Nissan',
            'Micra Active - Nissan',
            'Teana - Nissan',
            'Kicks - Nissan',
            'Evalia - Nissan',
            'X-Trail - Nissan',
            'GTR - Nissan',
            'Magnite - Nissan',
            'Punto - Fiat',
            'Linea - Fiat',
            'Punto Evo - Fiat',
            'Palio D - Fiat',
            'Avventura - Fiat',
            'Palio Stile - Fiat',
            'Linea Classic - Fiat',
            'Adventure - Fiat',
            'Palio NV - Fiat',
            'Abarth Punto - Fiat',
            'Urban Cross - Fiat',
            'Uno - Fiat',
            'Petra - Fiat',
            'Redi Go - Datsun',
            'GO - Datsun',
            'GO Plus - Datsun',
            'X1 - BMW',
            '3 Series - BMW',
            '2 Series - BMW',
            '5 Series - BMW',
            '3 Series GT - BMW',
            'X3 - BMW',
            '7 Series - BMW',
            '1 Series - BMW',
            'Z4 - BMW',
            '5 Series GT - BMW',
            'X5 - BMW',
            'X6 - BMW',
            '6 Series - BMW',
            'M5 - BMW',
            'M3 - BMW',
            'X4 - BMW',
            '6 Series GT - BMW',
            'X7 - BMW',
            'i4 - BMW',
            'iX - BMW',
            'Carnival - Kia',
            'Seltos - Kia',
            'Carens - Kia',
            'Sonet - Kia',
            'EV6 - Kia',
            'Syros - Kia',
            'A4 - Audi',
            'A6 - Audi',
            'Q3 - Audi',
            'Q2 - Audi',
            'Q7 - Audi',
            'A3 - Audi',
            'Q5 - Audi',
            'A8 L - Audi',
            'S4 - Audi',
            'A5 - Audi',
            'A7 - Audi',
            'A8 - Audi',
            'TT - Audi',
            'R8 - Audi',
            'RS5 - Audi',
            'RS3 - Audi',
            'Q8 - Audi',
            'e-tron - Audi',
            'C-Class - Mercedes',
            'E-Class - Mercedes',
            'GLC - Mercedes',
            'CLA Class - Mercedes',
            'A-Class - Mercedes',
            'S-Class - Mercedes',
            'V-Class - Mercedes',
            'ML Class - Mercedes',
            'B-Class - Mercedes',
            'GLA Class - Mercedes',
            'GLE Class - Mercedes',
            'SL 500 AMG - Mercedes',
            'AMG GT - Mercedes',
            'G63 AMGr - Mercedes',
            'GL Class - Mercedes',
            'SLK Class - Mercedes',
            'CLS Class - Mercedes',
            'GLS - Mercedes',
            'R Class - Mercedes',
            'GLE43 AMG - Mercedes',
            'EQC - Mercedes',
            'EQS - Mercedes',
            'Compass - Jeep',
            'Wrangler - Jeep',
            'Pajero Sport - Mitsubishi',
            'Outlander - Mitsubishi',
            'Pajero - Mitsubishi',
            'Lancer - Mitsubishi',
            'Cedia - Mitsubishi',
            'Montero - Mitsubishi',
            'Gloster - MG',
            'ZS EV - MG',
            'Hector - MG',
            'Astor - MG',
            'Hector Plus - MG',
            'Windsor - MG',
            'Comet - MG',
            'Discovery Sport - Land Rover',
            'Range Rover Evoque - Land Rover',
            'Freelander 2 - Land Rover',
            'Range Rover Sport - Land Rover',
            'Discovery 4 - Land Rover',
            'Defender - Land Rover',
            'Range Rover - Land Rover',
            'Range Rover Vogue - Land Rover',
            'Range Rover Velar - Land Rover',
            'S60 - Volvo',
            'V40 - Volvo',
            'S80 - Volvo',
            'XC60 - Volvo',
            'XC90 - Volvo',
            'S60 Cross Country - Volvo',
            'V40 Cross Country - Volvo',
            'S40 - Volvo',
            'XC 40 - Volvo',
            'V60 - Volvo',
            'V90 - Volvo',
            'S90 - Volvo',
            'XF - Jaguar',
            'XE - Jaguar',
            'XJ - Jaguar',
            'F Type - Jaguar',
            'F Pace - Jaguar',
            'XJR - Jaguar',
            'XK R - Jaguar',
            'I-Pace - Jaguar',
            'Rexton - Ssangyong',
            'MU7 - Isuzu',
            'Dmax V Cross - Isuzu',
            'MU-X - Isuzu',
            'Cooper - Mini',
            'Countryman - Mini',
            'Clubman - Mini',
            'Cooper SE - Mini',
            'One - Force',
            'Traveller 3350 - Force',
            'Trax - Force',
            'Gurkha - Force',
            'Corsa - Opel',
            'Astra - Opel',
            '911 - Porsche',
            'Cayenne - Porsche',
            'Macan - Porsche',
            'Cayman - Porsche',
            'Panamera - Porsche',
            'Boxter - Porsche',
            'Taycan - Porsche',
            'Taycan Turismo - Porsche',
            'Matiz - Daewoo',
            'Nexia - Daewoo',
            'Cielo - Daewoo',
            'Ambassador - Hindustan Motors',
            'Vantage - Aston Martin',
            'Rapide - Aston Martin',
            'Vanquish - Aston Martin',
            'DB9 - Aston Martin',
            'C5 Aircross - Citroen',
            'C3 - Citroen',
            'ES - Lexus',
            'NX - Lexus',
            'LS - Lexus',
            'RX - Lexus',
            'LC - Lexus',
            'LX - Lexus',
            'Mulsanne - Bentley',
            'Continental - Bentley',
            'Flying Spur - Bentley',
            'Avanti - DC',
            '458 Speciale - Ferrari',
            '458 Italia - Ferrari',
            '488 - Ferrari',
            'California - Ferrari',
            'F12 Berlinetta - Ferrari',
            'FF - Ferrari',
            'Ghibli - Maserati',
            'Quattroporte - Maserati',
            'GranCabrio - Maserati',
            'GranTurismo - Maserati',
            'Huracan - Lamborghini',
            'Aventador - Lamborghini',
            'Gallardo - Lamborghini',
            'Urus - Lamborghini',
            'Phantom - Rolls Royce',
            'Ghost - Rolls Royce',
            'Wraith - Rolls Royce',
            'VIW CS2 - Photon',
            'Neo - Jayem',
            'Rio - Premier',
            'H2 - Hummer',
            'H3 - Hummer',
            'e6 - BYD'
        ];

        // Mixpanel tracking function
        function trackMixpanelEvent(eventName, properties = {}) {
            try {
                const mobile = document.getElementById('mobile').value;
                const userId = mobile ? `91${mobile}` : null;
                const agentName = localStorage.getItem('agent_name_im') || 'Unknown';

                // Set user identity
                if (userId) {
                    mixpanel.identify(userId);
                }

                // Add agent_name to all events
                const eventProperties = {
                    ...properties,
                    agent_name: agentName
                };

                mixpanel.track(eventName, eventProperties);
                console.log(`Mixpanel event tracked: ${eventName}`, eventProperties);
            } catch (error) {
                console.error('Mixpanel tracking error:', error);
            }
        }

        // Function to check for existing bookings
        async function checkExistingBooking(mobile) {
            try {
                const response = await fetch(`https://ai.instantmechanic.online/bot/api/booking-details?mobile=91${mobile}`, {
                    method: 'GET',
                    headers: {
                        'Accept': '*/*',
                        'Accept-Language': 'en-US,en;q=0.9',
                        'Connection': 'keep-alive',
                        'Origin': 'https://instantmechanic.online',
                        'Referer': 'https://instantmechanic.online/',
                        'Sec-Fetch-Dest': 'empty',
                        'Sec-Fetch-Mode': 'cors',
                        'Sec-Fetch-Site': 'same-site',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36'
                    }
                });

                if (response.ok) {
                    const bookingData = await response.json();
                    console.log('Booking data:', bookingData);
                    
                    // Check if booking was created in the last hour
                    const bookingTime = new Date(bookingData.created_at);
                    const currentTime = new Date();
                    const timeDifference = currentTime - bookingTime;
                    const oneHourInMs = 60 * 60 * 1000; // 1 hour in milliseconds

                    if (timeDifference <= oneHourInMs) {
                        // Show existing booking popup
                        showExistingBookingPopup(bookingData, timeDifference);
                        return true; // Found recent booking
                    }
                }
                
                return false; // No recent booking found
            } catch (error) {
                console.error('Error checking existing booking:', error);
                return false; // Continue with booking if API fails
            }
        }

        // Function to show existing booking popup
        function showExistingBookingPopup(bookingData, timeDifference) {
            const popup = document.getElementById('existingBookingPopup');
            const detailsContainer = document.getElementById('existingBookingDetails');
            
            // Calculate time ago
            const minutesAgo = Math.floor(timeDifference / (1000 * 60));
            const timeAgoText = minutesAgo < 60 ? `${minutesAgo} minutes ago` : `${Math.floor(minutesAgo / 60)} hour(s) ago`;
            
            // Populate booking details
            detailsContainer.innerHTML = `
                <div class="booking-detail-item">
                    <span class="detail-label">Problem</span>
                    <span class="detail-value">${bookingData.problem || 'Not specified'}</span>
                </div>
                <div class="booking-detail-item">
                    <span class="detail-label">Price</span>
                    <span class="detail-value price-value">₹${bookingData.price || 'N/A'}</span>
                </div>
                <div class="booking-detail-item">
                    <span class="detail-label">Car</span>
                    <span class="detail-value">${bookingData.car || 'Not specified'}</span>
                </div>
                <div class="booking-detail-item">
                    <span class="detail-label">Status</span>
                    <span class="detail-value">${bookingData.is_cancelled ? 'Cancelled' : 'Active'}</span>
                </div>
                <div class="booking-detail-item">
                    <span class="detail-label">Booked</span>
                    <span class="detail-value time-ago">${timeAgoText}</span>
                </div>
            `;
            
            popup.classList.add('show');
        }

        // Function to hide existing booking popup
        function hideExistingBookingPopup() {
            const popup = document.getElementById('existingBookingPopup');
            popup.classList.remove('show');
        }

        // Agent Selection Popup Functions
        function showAgentPopup() {
            const popup = document.getElementById('agentPopup');
            popup.classList.add('show');
        }

        function hideAgentPopup() {
            const popup = document.getElementById('agentPopup');
            popup.classList.remove('show');
        }

        // Fetch agents from API
        async function fetchAgents() {
            const agentGrid = document.getElementById('agentGrid');
            
            try {
                const response = await fetch('https://ai.instantmechanic.online/bot/api/agent/');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const agents = await response.json();
                
                // Filter out deleted agents and sort by name
                const activeAgents = agents
                    .filter(agent => !agent.is_deleted)
                    .sort((a, b) => a.name.localeCompare(b.name));
                
                if (activeAgents.length === 0) {
                    agentGrid.innerHTML = '<div class="error-state">No active agents found</div>';
                    return;
                }
                
                // Create agent options
                agentGrid.innerHTML = activeAgents.map(agent => `
                    <div class="agent-option ${agent.is_live ? 'live' : ''}" data-agent="${agent.name}" data-id="${agent.id}">
                        ${agent.name}
                    </div>
                `).join('');
                
                // Initialize agent selection for the loaded agents
                initializeAgentSelection();
                
            } catch (error) {
                console.error('Error fetching agents:', error);
                agentGrid.innerHTML = `
                    <div class="error-state">
                        Failed to load agents
                        <br>
                        <button class="retry-btn" onclick="fetchAgents()">Retry</button>
                    </div>
                `;
            }
        }

        function initializeAgentSelection() {
            const agentOptions = document.querySelectorAll('.agent-option');
            const confirmBtn = document.getElementById('confirmAgent');
            let selectedAgent = null;

            agentOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    agentOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    selectedAgent = this.dataset.agent;
                    
                    // Enable confirm button
                    confirmBtn.disabled = false;
                });
            });

            confirmBtn.addEventListener('click', function() {
                if (selectedAgent) {
                    // Save agent name to localStorage
                    localStorage.setItem('agent_name_im', selectedAgent);
                    
                    // Hide popup
                    hideAgentPopup();
                }
            });

            // Prevent closing popup by clicking outside
            document.getElementById('agentPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    // Don't allow closing by clicking outside - agent selection is required
                    return;
                }
            });
        }

        // Check if agent name exists in localStorage on page load
        function checkAgentName() {
            const agentName = localStorage.getItem('agent_name_im');
            if (!agentName) {
                showAgentPopup();
                fetchAgents(); // Load agents when showing popup
            }
        }

        // Initialize dropdown functionality for problems
        function initializeProblemDropdown() {
            const descriptionInput = document.getElementById('description');
            const dropdownList = document.getElementById('dropdownList');
            let selectedIndex = -1;

            function filterProblems(searchText) {
                if (!searchText.trim()) {
                    dropdownList.classList.remove('show');
                    return;
                }

                const filtered = problemList.filter(problem => 
                    problem.toLowerCase().includes(searchText.toLowerCase())
                ).slice(0, 3);

                if (filtered.length > 0) {
                    dropdownList.innerHTML = filtered.map((problem, index) => 
                        `<div class="dropdown-item" data-value="${problem}" data-index="${index}">${problem}</div>`
                    ).join('');
                    dropdownList.classList.add('show');
                } else {
                    dropdownList.classList.remove('show');
                }
                selectedIndex = -1;
            }

            descriptionInput.addEventListener('input', function() {
                filterProblems(this.value);
            });

            descriptionInput.addEventListener('focus', function() {
                if (!this.value.trim()) {
                    dropdownList.innerHTML = problemList.slice(0, 3).map((problem, index) => 
                        `<div class="dropdown-item" data-value="${problem}" data-index="${index}">${problem}</div>`
                    ).join('');
                    dropdownList.classList.add('show');
                }
            });

            descriptionInput.addEventListener('keydown', function(e) {
                const items = dropdownList.querySelectorAll('.dropdown-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateHighlight(items);
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    selectItem(items[selectedIndex]);
                } else if (e.key === 'Escape') {
                    dropdownList.classList.remove('show');
                    selectedIndex = -1;
                }
            });

            function updateHighlight(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('highlighted', index === selectedIndex);
                });
            }

            function selectItem(item) {
                descriptionInput.value = item.dataset.value;
                dropdownList.classList.remove('show');
                selectedIndex = -1;
            }

            dropdownList.addEventListener('click', function(e) {
                if (e.target.classList.contains('dropdown-item')) {
                    selectItem(e.target);
                }
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown-container') || 
                    !e.target.closest('.dropdown-container').contains(dropdownList)) {
                    dropdownList.classList.remove('show');
                    selectedIndex = -1;
                }
            });
        }

        // Initialize dropdown functionality for car models
        function initializeCarModelDropdown() {
            const carModelInput = document.getElementById('carModel');
            const carModelDropdownList = document.getElementById('carModelDropdownList');
            let selectedIndex = -1;

            function filterCarModels(searchText) {
                if (!searchText.trim()) {
                    carModelDropdownList.classList.remove('show');
                    return;
                }

                const filtered = carModelsList.filter(carModel => 
                    carModel.toLowerCase().includes(searchText.toLowerCase())
                ).slice(0, 3);

                if (filtered.length > 0) {
                    carModelDropdownList.innerHTML = filtered.map((carModel, index) => 
                        `<div class="dropdown-item" data-value="${carModel}" data-index="${index}">${carModel}</div>`
                    ).join('');
                    carModelDropdownList.classList.add('show');
                } else {
                    carModelDropdownList.classList.remove('show');
                }
                selectedIndex = -1;
            }

            carModelInput.addEventListener('input', function() {
                filterCarModels(this.value);
            });

            carModelInput.addEventListener('focus', function() {
                if (!this.value.trim()) {
                    carModelDropdownList.innerHTML = carModelsList.slice(0, 3).map((carModel, index) => 
                        `<div class="dropdown-item" data-value="${carModel}" data-index="${index}">${carModel}</div>`
                    ).join('');
                    carModelDropdownList.classList.add('show');
                }
            });

            carModelInput.addEventListener('keydown', function(e) {
                const items = carModelDropdownList.querySelectorAll('.dropdown-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateHighlight(items);
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    selectItem(items[selectedIndex]);
                } else if (e.key === 'Escape') {
                    carModelDropdownList.classList.remove('show');
                    selectedIndex = -1;
                }
            });

            function updateHighlight(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('highlighted', index === selectedIndex);
                });
            }

            function selectItem(item) {
                carModelInput.value = item.dataset.value;
                carModelDropdownList.classList.remove('show');
                selectedIndex = -1;
            }

            carModelDropdownList.addEventListener('click', function(e) {
                if (e.target.classList.contains('dropdown-item')) {
                    selectItem(e.target);
                }
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown-container') || 
                    !e.target.closest('.dropdown-container').contains(carModelDropdownList)) {
                    carModelDropdownList.classList.remove('show');
                    selectedIndex = -1;
                }
            });
        }

        // Function to toggle price and security amount visibility
        function togglePriceAndSecurityVisibility(isGoMechanic) {
            const priceGroup = document.getElementById('priceGroup');
            const securityAmountGroup = document.getElementById('securityAmountGroup');
            
            if (isGoMechanic) {
                priceGroup.classList.add('hidden');
                securityAmountGroup.classList.add('hidden');
            } else {
                priceGroup.classList.remove('hidden');
                securityAmountGroup.classList.remove('hidden');
            }
        }

        // Get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Process booking function
        async function processBooking(formData) {
            try {
                // Replace with your actual API endpoint
                const response = await fetch('https://ai.instantmechanic.online/bot/api/mannual-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    return { success: true };
                } else {
                    throw new Error('Booking failed');
                }
            } catch (error) {
                console.error('Booking error:', error);
                throw error;
            }
        }

        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            // Check agent name and show popup if needed
            checkAgentName();
            
            // Initialize dropdown functionality
            initializeProblemDropdown();
            initializeCarModelDropdown();

            // Initialize existing booking popup event handlers
            document.getElementById('cancelExistingBooking').addEventListener('click', function() {
                hideExistingBookingPopup();
                // Reset form loading state
                const bookBtn = document.getElementById('bookBtn');
                const btnText = bookBtn.querySelector('.btn-text');
                const loading = bookBtn.querySelector('.loading');
                bookBtn.disabled = false;
                btnText.style.display = 'inline';
                loading.style.display = 'none';
            });

            document.getElementById('continueWithBooking').addEventListener('click', async function() {
                hideExistingBookingPopup();
                
                // Proceed with booking
                await submitBookingForm();
            });

            // Function to fetch customer location from API
            async function fetchCustomerLocation(mobile) {
                try {
                    const response = await fetch(`https://ai.instantmechanic.online/bot/api/customer_info?mobile=91${mobile}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.location_url) {
                            // Extract location coordinates from Google Maps URL
                            document.getElementById('location').value = data.location_url;
                        }
                    }
                } catch (error) {
                    console.error('Error fetching customer location:', error);
                }
            }

            // Pre-fill mobile number from URL parameter if present and fetch location
            const mobileParam = getUrlParameter('mobile');
            if (mobileParam) {
                document.getElementById('mobile').value = mobileParam;
                // Fetch customer location from API
                fetchCustomerLocation(mobileParam);
            }

            // Initialize default values and calculate initial security amount
            const initialPrice = document.getElementById('price').value;
            if (initialPrice) {
                const calculatedSecurity = calculateSecurityAmount(initialPrice);
                document.getElementById('securityAmount').value = calculatedSecurity || '428';
            }

            // Toggle functionality with visibility control
            const goMechanicToggle = document.getElementById('goMechanicToggle');
            goMechanicToggle.addEventListener('click', function() {
                this.classList.toggle('active');
                const isGoMechanic = this.classList.contains('active');
                togglePriceAndSecurityVisibility(isGoMechanic);
            });

            // Form validation for mobile number
            const mobileInput = document.getElementById('mobile');
            mobileInput.addEventListener('input', function() {
                this.value = this.value.replace(/\D/g, '');
                if (this.value.length > 10) {
                    this.value = this.value.slice(0, 10);
                }
            });

            // Track if security amount was manually overridden
            let securityAmountManuallySet = false;

            // Function to calculate security amount based on price
            function calculateSecurityAmount(price) {
                if (!price || isNaN(price) || price <= 0) return '';
                const xyz = parseFloat(price);
                const securityAmount = xyz / 2.36;
                const roundedAmount = Math.round(securityAmount);
                return Math.max(roundedAmount, 250);
            }

            // Form validation for price with auto-calculation of security amount
            const priceInput = document.getElementById('price');
            priceInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^\d.]/g, '');
                const parts = this.value.split('.');
                if (parts.length > 2) {
                    this.value = parts[0] + '.' + parts.slice(1).join('');
                }
                if (parts[1] && parts[1].length > 2) {
                    this.value = parts[0] + '.' + parts[1].substring(0, 2);
                }

                // Auto-calculate security amount only if not manually overridden
                if (!securityAmountManuallySet) {
                    const calculatedSecurity = calculateSecurityAmount(this.value);
                    document.getElementById('securityAmount').value = calculatedSecurity || '';
                }
            });

            // Form validation for security amount with manual override detection
            const securityAmountInput = document.getElementById('securityAmount');
            securityAmountInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^\d.]/g, '');
                const parts = this.value.split('.');
                if (parts.length > 2) {
                    this.value = parts[0] + '.' + parts.slice(1).join('');
                }
                if (parts[1] && parts[1].length > 2) {
                    this.value = parts[0] + '.' + parts[1].substring(0, 2);
                }
            });

            // Detect manual override of security amount
            securityAmountInput.addEventListener('focus', function() {
                securityAmountManuallySet = true;
            });

            // Reset manual override flag when price changes significantly
            priceInput.addEventListener('focus', function() {
                // Only reset if user clicks on price field, allowing auto-calculation again
                const currentPrice = parseFloat(this.value) || 0;
                const currentSecurity = parseFloat(document.getElementById('securityAmount').value) || 0;
                const expectedSecurity = calculateSecurityAmount(currentPrice);
                
                // If security amount matches calculated value (within small tolerance), allow auto-calculation
                if (Math.abs(currentSecurity - expectedSecurity) < 0.01) {
                    securityAmountManuallySet = false;
                }
            });

            // Function to handle booking submission
            async function submitBookingForm() {
                const bookBtn = document.getElementById('bookBtn');
                const btnText = bookBtn.querySelector('.btn-text');
                const loading = bookBtn.querySelector('.loading');
                const successMessage = document.getElementById('successMessage');
                const errorMessage = document.getElementById('errorMessage');

                // Hide previous messages
                successMessage.style.display = 'none';
                errorMessage.style.display = 'none';

                // Check if GoMechanic toggle is active
                const isGoMechanic = document.getElementById('goMechanicToggle').classList.contains('active');

                // Get form values
                const mobile = document.getElementById('mobile').value;
                const price = parseFloat(document.getElementById('price').value) || 0;
                const mechanicPayout = parseFloat(document.getElementById('securityAmount').value) || 0;
                const carModel = document.getElementById('carModel').value;
                const problem = document.getElementById('description').value;
                const location = document.getElementById('location').value;

                // Collect form data
                const formData = {
                    mobile: '91' + mobile,
                    description: problem,
                    price: price || null,
                    carModel: carModel,
                    location: location,
                    securityAmount: mechanicPayout || null,
                    isGoMechanicCall: isGoMechanic,
                    timestamp: new Date().toISOString(),
                    agent: localStorage.getItem("agent_name_im") || "Harshit"
                };

                try {
                    await processBooking(formData);

                    // Track Mixpanel event for successful booking
                    trackMixpanelEvent("Booking Confirmed", {
                        "booking_type": "Manual Booking",
                        "car": carModel,
                        "price": price,
                        "problem": problem,
                        "location": location,
                        "remarks": null,
                        "company_profit": price - mechanicPayout,
                        "security_asked": 199, // Fixed as per your requirement
                        "mechanic_payout": mechanicPayout,
                        "total_price": price
                    });

                    successMessage.style.display = 'block';
                    document.getElementById('bookingForm').reset();
                    // Reset toggles to default state and restore default values
                    document.getElementById('goMechanicToggle').classList.remove('active');
                    togglePriceAndSecurityVisibility(false); // Show price and security fields
                    document.getElementById('price').value = '742';
                    const calculatedSecurity = calculateSecurityAmount('742');
                    document.getElementById('securityAmount').value = calculatedSecurity;
                    securityAmountManuallySet = false;
                } catch (error) {
                    console.error('Booking error:', error);
                    errorMessage.style.display = 'block';
                    
                    // For demo purposes, show success after 2 seconds
                    setTimeout(() => {
                        errorMessage.style.display = 'none';
                        successMessage.style.display = 'block';
                        
                        // Track Mixpanel event even for demo success
                        trackMixpanelEvent("Booking Confirmed", {
                            "booking_type": "Manual Booking",
                            "car": carModel,
                            "price": price,
                            "problem": problem,
                            "location": location,
                            "remarks": null,
                            "company_profit": price - mechanicPayout,
                            "security_asked": 199,
                            "mechanic_payout": mechanicPayout,
                            "total_price": price
                        });
                        
                        document.getElementById('bookingForm').reset();
                        document.getElementById('goMechanicToggle').classList.remove('active');
                        togglePriceAndSecurityVisibility(false); // Show price and security fields
                        document.getElementById('price').value = '742';
                        const calculatedSecurity = calculateSecurityAmount('742');
                        document.getElementById('securityAmount').value = calculatedSecurity;
                        securityAmountManuallySet = false;
                    }, 2000);
                } finally {
                    // Hide loading state
                    setTimeout(() => {
                        bookBtn.disabled = false;
                        btnText.style.display = 'inline';
                        loading.style.display = 'none';
                    }, 1500);
                }
            }

            // Form submission with existing booking check
            const form = document.getElementById('bookingForm');
            const bookBtn = document.getElementById('bookBtn');
            const btnText = bookBtn.querySelector('.btn-text');
            const loading = bookBtn.querySelector('.loading');

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Validate mobile number
                const mobile = document.getElementById('mobile').value;
                if (mobile.length !== 10) {
                    alert('Please enter a valid 10-digit mobile number');
                    return;
                }

                // Show loading state
                bookBtn.disabled = true;
                btnText.style.display = 'none';
                loading.style.display = 'flex';

                // Check for existing booking first
                const hasExistingBooking = await checkExistingBooking(mobile);
                
                if (!hasExistingBooking) {
                    // No existing booking, proceed directly
                    await submitBookingForm();
                }
                // If existing booking found, popup will be shown and user can choose to continue or cancel
            });
        });
    </script>

    <script>
// Unified Location Handler - Improved Version
class LocationUnifier {
    constructor(apiKey) {
        this.apiKey = apiKey;
        this.geocoder = null;
        this.initGoogleMaps();
    }

    initGoogleMaps() {
        // Check if Google Maps is already loaded
        if (window.google && window.google.maps) {
            this.geocoder = new google.maps.Geocoder();
            return;
        }

        // Load Google Maps API
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${this.apiKey}&libraries=geometry`;
        script.onload = () => {
            this.geocoder = new google.maps.Geocoder();
        };
        script.onerror = () => {
            console.warn('Google Maps API failed to load, using fallback location handling');
        };
        document.head.appendChild(script);
    }

    // Extract coordinates from Google Maps share URL
    extractFromShareUrl(url) {
        try {
            const patterns = [
                // Pattern for: https://www.google.com/maps?q=28.63542175293,77.252059936523
                /[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/,
                // Pattern for: https://www.google.com/maps/@28.4105614,77.0473984,14z
                /@(-?\d+\.?\d*),(-?\d+\.?\d*)/,
                // Pattern for place coordinates in URLs
                /!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/,
                // Pattern for center parameter
                /center=(-?\d+\.?\d*),(-?\d+\.?\d*)/,
                // Pattern for ll parameter
                /ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/,
                // Pattern for coordinates in various formats
                /(-?\d{1,3}\.\d{6,}),?\s*(-?\d{1,3}\.\d{6,})/
            ];

            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match && match.length >= 3) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    
                    // Validate coordinates are reasonable for Earth
                    if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                        return { lat, lng };
                    }
                }
            }
            return null;
        } catch (error) {
            console.error('Error extracting coordinates from URL:', error);
            return null;
        }
    }

    // Extract coordinates from direct coordinate input
    extractFromCoordinates(input) {
        try {
            // Pattern for: "28.411127648348124, 77.05486566966145"
            const coordPattern = /^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/;
            const match = input.trim().match(coordPattern);
            
            if (match) {
                const lat = parseFloat(match[1]);
                const lng = parseFloat(match[2]);
                
                // Validate coordinates
                if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                    return { lat, lng };
                }
            }
            return null;
        } catch (error) {
            console.error('Error extracting coordinates:', error);
            return null;
        }
    }

    // Geocode address to coordinates using Google Maps API
    async geocodeAddress(address) {
        return new Promise((resolve, reject) => {
            if (!this.geocoder) {
                reject(new Error('Google Maps not available'));
                return;
            }

            this.geocoder.geocode({ 'address': address }, (results, status) => {
                if (status === 'OK' && results && results.length > 0) {
                    const location = results[0].geometry.location;
                    resolve({
                        lat: location.lat(),
                        lng: location.lng()
                    });
                } else {
                    reject(new Error('Geocoding failed: ' + status));
                }
            });
        });
    }

    // Resolve shortened URLs using multiple methods
    async resolveShortUrl(url) {
        const methods = [
            () => this.resolveViaHttp(url),
            () => this.resolveViaProxy(url),
            () => this.resolveViaGoogleAPI(url)
        ];

        for (const method of methods) {
            try {
                const result = await method();
                if (result) {
                    return result;
                }
            } catch (error) {
                console.warn('Resolution method failed:', error.message);
                continue;
            }
        }

        return null;
    }

    // Method 1: Direct HTTP request (may fail due to CORS)
    async resolveViaHttp(url) {
        try {
            const response = await fetch(url, {
                method: 'GET',
                redirect: 'follow',
                mode: 'cors'
            });

            if (response.ok) {
                const finalUrl = response.url;
                return this.extractFromShareUrl(finalUrl);
            }
        } catch (error) {
            throw new Error('Direct HTTP resolution failed');
        }
        return null;
    }

    // Method 2: Using CORS proxy
    async resolveViaProxy(url) {
        const proxyUrls = [
            `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            `https://cors-anywhere.herokuapp.com/${url}`,
            `https://thingproxy.freeboard.io/fetch/${url}`
        ];

        for (const proxyUrl of proxyUrls) {
            try {
                const response = await fetch(proxyUrl);
                if (response.ok) {
                    const text = await response.text();
                    const coords = this.extractFromShareUrl(text);
                    if (coords) {
                        return coords;
                    }
                }
            } catch (error) {
                continue;
            }
        }
        
        throw new Error('Proxy resolution failed');
    }

    // Method 3: Try using Google Places API to find place from shortened URL
    async resolveViaGoogleAPI(url) {
        if (!this.geocoder) {
            throw new Error('Google API not available');
        }

        try {
            // Extract potential place ID from URL if present
            const placeIdMatch = url.match(/place\/([A-Za-z0-9_-]+)/);
            if (placeIdMatch) {
                // This would require Places API - simplified approach
                return null;
            }

            // Try geocoding the URL directly (Google sometimes handles URLs)
            return await this.geocodeAddress(url);
        } catch (error) {
            throw new Error('Google API resolution failed');
        }
    }

    // Main function to unify location input
    async unifyLocation(input) {
        if (!input || typeof input !== 'string') {
            throw new Error('Invalid input');
        }

        const trimmedInput = input.trim();
        
        try {
            // Check if input is already in the desired format
            if (trimmedInput.startsWith('https://www.google.com/maps?q=') && 
                /[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/.test(trimmedInput)) {
                return trimmedInput;
            }

            // Try to extract coordinates from direct coordinate input
            const coordsFromInput = this.extractFromCoordinates(trimmedInput);
            if (coordsFromInput) {
                return `https://www.google.com/maps?q=${coordsFromInput.lat},${coordsFromInput.lng}`;
            }

            // Try to extract coordinates from Google Maps URL
            const coordsFromUrl = this.extractFromShareUrl(trimmedInput);
            if (coordsFromUrl) {
                return `https://www.google.com/maps?q=${coordsFromUrl.lat},${coordsFromUrl.lng}`;
            }

            // If it's a shortened URL, try to resolve it
            if (this.isShortUrl(trimmedInput)) {
                console.log('Attempting to resolve shortened URL:', trimmedInput);
                
                try {
                    const resolvedCoords = await this.resolveShortUrl(trimmedInput);
                    if (resolvedCoords) {
                        return `https://www.google.com/maps?q=${resolvedCoords.lat},${resolvedCoords.lng}`;
                    }
                } catch (error) {
                    console.warn('Failed to resolve short URL, trying geocoding as fallback:', error);
                }
            }

            // Try to geocode as an address using Google Maps API
            if (this.geocoder) {
                try {
                    console.log('Attempting to geocode as address:', trimmedInput);
                    const geocodedCoords = await this.geocodeAddress(trimmedInput);
                    return `https://www.google.com/maps?q=${geocodedCoords.lat},${geocodedCoords.lng}`;
                } catch (error) {
                    console.warn('Geocoding failed:', error);
                }
            }

            // If all methods fail, return original input (fallback)
            console.warn('Could not unify location, returning original input');
            return trimmedInput;

        } catch (error) {
            console.error('Error in unifyLocation:', error);
            return trimmedInput; // Fallback to original input
        }
    }

    // Helper method to identify shortened URLs
    isShortUrl(url) {
        const shortUrlPatterns = [
            /goo\.gl/,
            /maps\.app\.goo\.gl/,
            /t\.co/,
            /bit\.ly/,
            /tinyurl\.com/,
            /short/i
        ];

        return shortUrlPatterns.some(pattern => pattern.test(url));
    }
}

// Initialize the location unifier with your Google Maps API key
// ⚠️ IMPORTANT: Replace 'YOUR_GOOGLE_MAPS_API_KEY' with your actual API key
const locationUnifier = new LocationUnifier('AIzaSyAUvC9Xsv8EO1al8H4rMix8FnkiOOMo1D4');

// Function to handle location input processing
async function processLocationInput(input) {
    try {
        console.log('Processing location input:', input);
        const unifiedLocation = await locationUnifier.unifyLocation(input);
        console.log('Unified location result:', unifiedLocation);
        return unifiedLocation;
    } catch (error) {
        console.error('Location processing error:', error);
        return input; // Return original input as fallback
    }
}

// Integrate with your existing form
document.addEventListener('DOMContentLoaded', function() {
    const locationInput = document.getElementById('location');
    let processingLocation = false;

    if (locationInput) {
        // Add visual indicator for location processing
        const locationWrapper = locationInput.parentElement;
        if (!locationWrapper.querySelector('.processing-indicator')) {
            const processingIndicator = document.createElement('div');
            processingIndicator.className = 'processing-indicator';
            processingIndicator.style.cssText = `
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                width: 16px;
                height: 16px;
                border: 2px solid #e5e7eb;
                border-top: 2px solid #667eea;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                display: none;
                z-index: 10;
            `;
            
            // Add CSS animation if not already present
            if (!document.querySelector('#location-processing-styles')) {
                const style = document.createElement('style');
                style.id = 'location-processing-styles';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            if (locationWrapper.style.position !== 'relative') {
                locationWrapper.style.position = 'relative';
            }
            locationWrapper.appendChild(processingIndicator);
        }

        const processingIndicator = locationWrapper.querySelector('.processing-indicator');

        // Process location when user finishes typing (debounced)
        let locationTimeout;
        locationInput.addEventListener('input', function() {
            clearTimeout(locationTimeout);
            
            locationTimeout = setTimeout(async () => {
                await processLocationField(this, processingIndicator);
            }, 1500); // 1.5 second delay after user stops typing
        });

        // Also process on blur (when user leaves the field)
        locationInput.addEventListener('blur', async function() {
            clearTimeout(locationTimeout); // Cancel any pending timeout
            await processLocationField(this, processingIndicator);
        });

        // Process location field function
        async function processLocationField(inputElement, indicator) {
            const inputValue = inputElement.value.trim();
            
            // Skip processing if input is empty, already processing, or already in correct format
            if (!inputValue || 
                processingLocation || 
                (inputValue.startsWith('https://www.google.com/maps?q=') && 
                 /[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/.test(inputValue))) {
                return;
            }

            processingLocation = true;
            indicator.style.display = 'block';
            
            // Add visual feedback that processing started
            inputElement.style.borderColor = '#fbbf24'; // Yellow border while processing

            try {
                const unifiedLocation = await processLocationInput(inputValue);
                
                // Only update if the result is different and is in the correct format
                if (unifiedLocation !== inputValue && 
                    unifiedLocation.startsWith('https://www.google.com/maps?q=')) {
                    inputElement.value = unifiedLocation;
                    
                    // Success feedback - green border
                    inputElement.style.borderColor = '#10b981';
                    console.log('Location successfully unified from:', inputValue, 'to:', unifiedLocation);
                } else {
                    // No change or fallback - return to normal
                    inputElement.style.borderColor = '#6b7280';
                    if (unifiedLocation === inputValue) {
                        console.log('Location unchanged (could not unify):', inputValue);
                    }
                }
            } catch (error) {
                console.error('Location processing failed:', error);
                // Error feedback - red border briefly
                inputElement.style.borderColor = '#ef4444';
            } finally {
                processingLocation = false;
                indicator.style.display = 'none';
                
                // Reset border color after delay
                setTimeout(() => {
                    inputElement.style.borderColor = '';
                }, 2000);
            }
        }
    }
});

// Make functions available globally for debugging/testing
window.locationUnifier = locationUnifier;
window.processLocationInput = processLocationInput;

// Test function for debugging
window.testLocationUnifier = async function(testUrl) {
    console.log('Testing URL:', testUrl);
    try {
        const result = await processLocationInput(testUrl);
        console.log('Result:', result);
        return result;
    } catch (error) {
        console.error('Test failed:', error);
        return null;
    }
};
</script>
</body>
</html>

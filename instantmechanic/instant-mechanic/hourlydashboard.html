<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Instant Mechanic â€“ Hourly Business Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Data labels plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
    }
    .page {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin: 4px 0;
      font-size: 26px;
      font-weight: 600;
    }
    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #555;
      margin-bottom: 12px;
    }

    /* ðŸ”¹ Summary cards row */
    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 14px;
      justify-content: space-between;
    }
    .summary-card {
      flex: 1 1 230px;
      min-width: 230px;
      background: linear-gradient(135deg, #ffffff, #f9fafb);
      border-radius: 14px;
      padding: 8px 12px 10px;
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.04);
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .summary-title {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }
    .summary-subtitle {
      font-size: 11px;
      color: #6b7280;
    }
    .summary-values {
      font-size: 11px;
      line-height: 1.35;
      color: #111827;
      margin-top: 3px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      font-size: 13px;
    }
    .controls input[type="date"] {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      background: #ffffff;
    }
    #dateInfo {
      color: #666;
    }
    .section-title {
      margin: 18px 0 8px;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
    }

    /* Section 1 â€“ 2Ã—2 grid (Graphs 1â€“4) */
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    /* Section 2 â€“ 1 graph per row (Graphs 5â€“8) */
    .grid-1 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 10px 14px 12px;
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 340px;
    }
    .card h2 {
      font-size: 15px;
      margin: 0 0 4px;
      color: #111827;
      font-weight: 600;
    }
    .card canvas {
      flex: 1;
      margin-top: 6px;
    }
    .meta {
      font-size: 11px;
      color: #6b7280;
      text-align: right;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Instant Mechanic â€“ Hourly Business Dashboard</h1>
    <div class="subtitle">
      Bars = Hour-wise numbers &nbsp; | &nbsp; Lines = Cumulative / Efficiency metrics
    </div>

    <!-- ðŸ”¹ Summary cards -->
    <div class="summary-row">
      <div class="summary-card">
        <div class="summary-title">Total Spend (â‚¹)</div>
        <div class="summary-subtitle">Cumulative up to 2nd, 5th, 10th, 17th, 23rd hr</div>
        <div class="summary-values" id="summarySpend"></div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Total Revenue (â‚¹)</div>
        <div class="summary-subtitle">Cumulative up to 2nd, 5th, 10th, 17th, 23rd hr</div>
        <div class="summary-values" id="summaryRevenue"></div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Customers & Avg CPC (â‚¹)</div>
        <div class="summary-subtitle">Cumulative up to 2nd, 5th, 10th, 17th, 23rd hr</div>
        <div class="summary-values" id="summaryCPCust"></div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Bookings, CPB & Conv%</div>
        <div class="summary-subtitle">Cumulative up to 2nd, 5th, 10th, 17th, 23rd hr</div>
        <div class="summary-values" id="summaryCPBook"></div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Cancellations & ROAS</div>
        <div class="summary-subtitle">Cancelled, Cancel %, ROAS (cum up to 2,5,10,17,23 hr)</div>
        <div class="summary-values" id="summaryROAS"></div>
      </div>
    </div>

    <!-- Date picker -->
    <div class="controls">
      <label for="datePicker">Select date:</label>
      <input type="date" id="datePicker" />
      <span id="dateInfo"></span>
    </div>

    <!-- SECTION 1: Core metrics (Graphs 1â€“4) -->
    <div class="section-title">Section 1 â€“ Core Metrics (Graphs 1â€“4)</div>
    <div class="grid-2">
      <div class="card">
        <h2>Customers</h2>
        <canvas id="customersChart"></canvas>
      </div>
      <div class="card">
        <h2>Revenue</h2>
        <canvas id="revenueChart"></canvas>
      </div>
      <div class="card">
        <h2>Bookings</h2>
        <canvas id="bookingsChart"></canvas>
      </div>
      <div class="card">
        <h2>Cancelled Bookings</h2>
        <canvas id="cancelledChart"></canvas>
      </div>
    </div>

    <!-- SECTION 2: Advanced graphs (5â€“8) -->
    <div class="section-title">Section 2 â€“ Performance vs Ad Spend (Graphs 5â€“8)</div>
    <div class="grid-1">
      <div class="card">
        <h2>Graph 5 â€“ Customers, Bookings & Conversion Rate</h2>
        <canvas id="graph5"></canvas>
      </div>
      <div class="card">
        <h2>Graph 6 â€“ Ad Spend, Customers & Cost per Customer</h2>
        <canvas id="graph6"></canvas>
      </div>
      <div class="card">
        <h2>Graph 7 â€“ Ad Spend, Bookings & Cost per Booking</h2>
        <canvas id="graph7"></canvas>
      </div>
      <div class="card">
        <h2>Graph 8 â€“ Revenue, Spend & ROAS</h2>
        <canvas id="graph8"></canvas>
      </div>
    </div>

    <div class="meta" id="lastUpdated"></div>
  </div>

  <script>
    Chart.register(ChartDataLabels);

    // ðŸ‘‰ Your Sheet CSV link
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGlnFKI4M5RKKbU-DVD2ZMvXmcWXrCbn66l5j-0xnsJrMlAgQrUUNleVkZylxUaXLuEVeA6jeBSs_0/pub?gid=1312322610&single=true&output=csv";

    let allRows = [];
    let availableDates = [];
    let latestDateKey = null;
    let selectedDateKey = null;
    const charts = {};

    const summarySpendEl   = document.getElementById("summarySpend");
    const summaryRevenueEl = document.getElementById("summaryRevenue");
    const summaryCPCustEl  = document.getElementById("summaryCPCust");
    const summaryCPBookEl  = document.getElementById("summaryCPBook");
    const summaryROASEl    = document.getElementById("summaryROAS");

    // ðŸ”¹ Helper: get today's dateKey in yyyy-mm-dd (matches your dateKey format)
    function getTodayKey() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm   = String(today.getMonth() + 1).padStart(2, "0");
      const dd   = String(today.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function parseIndianDateAndKey(str) {
      const [d, m, y] = str.split("-").map(Number);
      const dateObj = new Date(y, m - 1, d);
      const dateKey = `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      return { dateObj, dateKey };
    }

    function parseCsv(text) {
      const rows = text.trim().split("\n").map(r => r.split(","));
      const header = rows[0].map(h => h.trim());

      const idxDate   = header.indexOf("date");
      const idxTime   = header.indexOf("Time");
      const idxCust   = header.indexOf("total_customers");
      const idxRev    = header.indexOf("total_revenue");
      const idxBook   = header.indexOf("total_booking");
      const idxCancel = header.indexOf("total_cancelled_booking");
      const idxSpend  = header.indexOf("total_spend"); // cumulative spend column

      if (idxDate === -1 || idxTime === -1 || idxCust === -1 ||
          idxRev === -1 || idxBook === -1 || idxCancel === -1 || idxSpend === -1) {
        alert("Missing columns. Required: date, Time, total_customers, total_revenue, total_booking, total_cancelled_booking, total_spend");
        return null;
      }

      const data = rows.slice(1).map(r => {
        const { dateObj, dateKey } = parseIndianDateAndKey(r[idxDate]);
        const timeRaw = r[idxTime] || "00:00:00";
        const hourStr = timeRaw.split(":")[0];
        const hour = Number(hourStr);

        return {
          dateObj,
          dateKey,
          hour,
          total_customers: Number(r[idxCust] || 0),
          total_revenue: Number(r[idxRev] || 0),
          total_booking: Number(r[idxBook] || 0),
          total_cancelled: Number(r[idxCancel] || 0),
          total_spend: Number(r[idxSpend] || 0)
        };
      });

      if (!data.length) return null;

      const dateSet = new Set(data.map(r => r.dateKey));
      const dateList = Array.from(dateSet).sort();
      const lastDateKey = dateList[dateList.length - 1];

      return { rows: data, dateKeys: dateList, latestDateKey: lastDateKey };
    }

    function computeSeries(rows, key) {
      const cumulative = [];
      const hourly = [];
      rows.forEach((row, i) => {
        const value = row[key];
        cumulative.push(value);
        hourly.push(i === 0 ? value : value - rows[i-1][key]);
      });
      return { cumulative, hourly };
    }

    function createOrUpdateChart(id, config) {
      const ctx = document.getElementById(id).getContext("2d");
      if (charts[id]) {
        charts[id].data = config.data;
        charts[id].options = config.options;
        charts[id].update();
      } else {
        charts[id] = new Chart(ctx, config);
      }
    }

    function baseBarLineOptions(xLabel, yLabelLeft) {
      return {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { position: "bottom", labels: { boxWidth: 14, font: { size: 11 } } },
          datalabels: {
            color: "#374151",
            font: { size: 10, weight: "500" },
            clamp: true,
            clip: false
          },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                const v = ctx.parsed.y ?? 0;
                return ctx.dataset.label + ": " + v.toLocaleString("en-IN");
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: xLabel, font: { size: 11 } },
            ticks: { autoSkip: false, font: { size: 10 } }
          },
          y: {
            beginAtZero: true,
            title: { display: !!yLabelLeft, text: yLabelLeft }
          }
        }
      };
    }

    // ðŸ”¹ Update summary cards based on cumulative series
    function updateSummaryCards(hours, customers, revenue, bookings, spend, cancelled) {
      const checkpoints = [2, 5, 10, 17, 23]; // hours of day
      const fmtMoney = v => "â‚¹" + Math.round(v).toLocaleString("en-IN");
      const fmtMoney0 = v => "â‚¹" + (v || 0).toFixed(0);
      const fmtRoas = v => (v && v > 0 ? v.toFixed(1) + "x" : "â€”");

      if (!hours.length) {
        summarySpendEl.textContent   = "No data";
        summaryRevenueEl.textContent = "No data";
        summaryCPCustEl.textContent  = "No data";
        summaryCPBookEl.textContent  = "No data";
        summaryROASEl.textContent    = "No data";
        return;
      }

      const linesSpend   = [];
      const linesRevenue = [];
      const linesCPCust  = [];
      const linesCPBook  = [];
      const linesROAS    = [];

      checkpoints.forEach(h => {
        const label = h + "h";
        const idx = hours.indexOf(h);

        if (idx === -1) {
          linesSpend.push(`${label} â†’ â€”`);
          linesRevenue.push(`${label} â†’ â€”`);
          linesCPCust.push(`${label} â†’ â€”`);
          linesCPBook.push(`${label} â†’ â€”`);
          linesROAS.push(`${label} â†’ â€”`);
          return;
        }

        const cumSpend    = spend.cumulative[idx];
        const cumRevenue  = revenue.cumulative[idx];
        const cumCust     = customers.cumulative[idx];
        const cumBook     = bookings.cumulative[idx];
        const cumCancel   = cancelled.cumulative[idx];

        const avgCPCust   = cumCust > 0 ? cumSpend / cumCust : 0;
        const avgCPBook   = cumBook > 0 ? cumSpend / cumBook : 0;
        const roas        = cumSpend > 0 ? cumRevenue / cumSpend : 0;
        const conv        = (cumCust > 0) ? (cumBook / cumCust) * 100 : null;
        const cancelRate  = (cumBook > 0) ? (cumCancel / cumBook) * 100 : null;
        const convStr     = conv !== null ? conv.toFixed(1) + "%" : "â€”";
        const cancelStr   = cancelRate !== null ? cancelRate.toFixed(1) + "%" : "â€”";

        // Card 1 & 2: just cumulative money
        linesSpend.push(`${label} â†’ ${fmtMoney(cumSpend)}`);
        linesRevenue.push(`${label} â†’ ${fmtMoney(cumRevenue)}`);

        // Card 3: customers + avg CPC
        linesCPCust.push(
          `${label} â†’ ${cumCust.toLocaleString("en-IN")} cust, ${fmtMoney0(avgCPCust)} CPC`
        );

        // Card 4: bookings + avg CPB + conversion %
        linesCPBook.push(
          `${label} â†’ ${cumBook.toLocaleString("en-IN")} book, ${fmtMoney0(avgCPBook)} CPB, ${convStr} Conv`
        );

        // Card 5: cancellations + cancel % + ROAS
        linesROAS.push(
          `${label} â†’ ${cumCancel.toLocaleString("en-IN")} canc, ${cancelStr} Canc, ${fmtRoas(roas)} ROAS`
        );
      });

      summarySpendEl.innerHTML   = linesSpend.join("<br>");
      summaryRevenueEl.innerHTML = linesRevenue.join("<br>");
      summaryCPCustEl.innerHTML  = linesCPCust.join("<br>");
      summaryCPBookEl.innerHTML  = linesCPBook.join("<br>");
      summaryROASEl.innerHTML    = linesROAS.join("<br>");
    }

    function renderDashboardForDate(dateKey) {
      if (!allRows.length) return;

      const rows = allRows
        .filter(r => r.dateKey === dateKey)
        .sort((a, b) => a.hour - b.hour);

      const dateInfo = document.getElementById("dateInfo");
      if (!rows.length) {
        dateInfo.textContent = "No data for this date.";
        Object.values(charts).forEach(ch => {
          ch.data.labels = [];
          ch.data.datasets.forEach(d => d.data = []);
          ch.update();
        });
        // Clear summary cards
        summarySpendEl.textContent   = "No data";
        summaryRevenueEl.textContent = "No data";
        summaryCPCustEl.textContent  = "No data";
        summaryCPBookEl.textContent  = "No data";
        summaryROASEl.textContent    = "No data";
        return;
      }

      const hours = rows.map(r => r.hour);

      // core metrics
      const customers = computeSeries(rows, "total_customers");
      const revenue   = computeSeries(rows, "total_revenue");
      const bookings  = computeSeries(rows, "total_booking");
      const cancelled = computeSeries(rows, "total_cancelled");
      const spend     = computeSeries(rows, "total_spend");

      const hourlyCustomers = customers.hourly;
      const hourlyRevenue   = revenue.hourly;
      const hourlyBookings  = bookings.hourly;
      const hourlyCancelled = cancelled.hourly;
      const hourlySpend     = spend.hourly;

      // ðŸ”¹ Update summary cards (cumulative up to key hours)
      updateSummaryCards(hours, customers, revenue, bookings, spend, cancelled);

      // derived metrics
      const conversionRate = hourlyCustomers.map((c, i) =>
        c > 0 ? (hourlyBookings[i] / c) * 100 : 0
      );
      const costPerCustomer = hourlyCustomers.map((c, i) =>
        c > 0 ? hourlySpend[i] / c : 0
      );
      const costPerBooking = hourlyBookings.map((b, i) =>
        b > 0 ? hourlySpend[i] / b : 0
      );
      const roas = hourlySpend.map((s, i) =>
        s > 0 ? (hourlyRevenue[i] / s) : 0
      );

      // ---------- Graphs 1â€“4 ----------
      const baseOptions = baseBarLineOptions("Hour of Day", "");

      createOrUpdateChart("customersChart", {
        type: "bar",
        data: {
          labels: hours,
          datasets: [
            {
              type: "bar",
              label: "Hourly Customers",
              data: hourlyCustomers,
              backgroundColor: "rgba(251, 146, 60, 0.55)",
              borderColor: "rgba(251, 146, 60, 1)",
              borderWidth: 1,
              datalabels: {
                anchor: "end",
                align: "start",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "line",
              label: "Cumulative Customers",
              data: customers.cumulative,
              borderColor: "rgba(239, 68, 68, 1)",
              borderWidth: 2,
              tension: 0.25,
              pointRadius: 3,
              fill: false,
              datalabels: {
                anchor: "end",
                align: "end",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            }
          ]
        },
        options: JSON.parse(JSON.stringify(baseOptions))
      });

      createOrUpdateChart("revenueChart", {
        type: "bar",
        data: {
          labels: hours,
          datasets: [
            {
              type: "bar",
              label: "Hourly Revenue",
              data: hourlyRevenue,
              backgroundColor: "rgba(251, 146, 60, 0.55)",
              borderColor: "rgba(251, 146, 60, 1)",
              borderWidth: 1,
              datalabels: {
                anchor: "end",
                align: "start",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "line",
              label: "Cumulative Revenue",
              data: revenue.cumulative,
              borderColor: "rgba(239, 68, 68, 1)",
              borderWidth: 2,
              tension: 0.25,
              pointRadius: 3,
              fill: false,
              datalabels: {
                anchor: "end",
                align: "end",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            }
          ]
        },
        options: JSON.parse(JSON.stringify(baseOptions))
      });

      createOrUpdateChart("bookingsChart", {
        type: "bar",
        data: {
          labels: hours,
          datasets: [
            {
              type: "bar",
              label: "Hourly Bookings",
              data: hourlyBookings,
              backgroundColor: "rgba(251, 146, 60, 0.55)",
              borderColor: "rgba(251, 146, 60, 1)",
              borderWidth: 1,
              datalabels: {
                anchor: "end",
                align: "start",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "line",
              label: "Cumulative Bookings",
              data: bookings.cumulative,
              borderColor: "rgba(239, 68, 68, 1)",
              borderWidth: 2,
              tension: 0.25,
              pointRadius: 3,
              fill: false,
              datalabels: {
                anchor: "end",
                align: "end",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            }
          ]
        },
        options: JSON.parse(JSON.stringify(baseOptions))
      });

      createOrUpdateChart("cancelledChart", {
        type: "bar",
        data: {
          labels: hours,
          datasets: [
            {
              type: "bar",
              label: "Hourly Cancelled Bookings",
              data: hourlyCancelled,
              backgroundColor: "rgba(251, 146, 60, 0.55)",
              borderColor: "rgba(251, 146, 60, 1)",
              borderWidth: 1,
              datalabels: {
                anchor: "end",
                align: "start",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "line",
              label: "Cumulative Cancelled Bookings",
              data: cancelled.cumulative,
              borderColor: "rgba(239, 68, 68, 1)",
              borderWidth: 2,
              tension: 0.25,
              pointRadius: 3,
              fill: false,
              datalabels: {
                anchor: "end",
                align: "end",
                formatter: v => v ? v.toLocaleString("en-IN") : ""
              }
            }
          ]
        },
        options: JSON.parse(JSON.stringify(baseOptions))
      });

      // ---------- Graph 5 ----------
      createOrUpdateChart("graph5", {
        type: "bar",
        data: {
          labels: hours,
          datasets: [
            {
              type: "bar",
              label: "Hourly Customers",
              data: hourlyCustomers,
              backgroundColor: "#4e79a7",
              datalabels: {
                anchor: "end", align: "start",
                formatter: v => v ? v : ""
              }
            },
            {
              type: "bar",
              label: "Hourly Bookings",
              data: hourlyBookings,
              backgroundColor: "#f28e2b",
              datalabels: {
                anchor: "end", align: "start",
                formatter: v => v ? v : ""
              }
            },
            {
              type: "line",
              label: "Conversion Rate (%)",
              data: conversionRate,
              borderColor: "red",
              borderWidth: 2,
              yAxisID: "y1",
              tension: 0.2,
              pointRadius: 3,
              datalabels: {
                anchor: "end",
                align: "end",
                formatter: v => v ? v.toFixed(1) + "%" : ""
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { position: "bottom" },
            datalabels: {
              color: "#374151",
              font: { size: 10, weight: "500" }
            }
          },
          scales: {
            x: { title: { display: true, text: "Hour of Day" } },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Customers / Bookings" }
            },
            y1: {
              position: "right",
              beginAtZero: true,
              title: { display: true, text: "Conversion Rate (%)" },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      // ---------- Graph 6 ----------
      createOrUpdateChart("graph6", {
        type: "bar",
        data: {
          labels: hours,
          datasets: [
            {
              type: "bar",
              label: "Hourly Ad Spend (â‚¹)",
              data: hourlySpend,
              backgroundColor: "#e15759",
              datalabels: {
                anchor: "end", align: "start",
                formatter: v => v ? "â‚¹" + v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "bar",
              label: "Hourly Customers",
              data: hourlyCustomers,
              backgroundColor: "#4e79a7",
              datalabels: {
                anchor: "end", align: "start",
                formatter: v => v ? v : ""
              }
            },
            {
              type: "line",
              label: "Cost per Customer (â‚¹)",
              data: costPerCustomer,
              borderColor: "green",
              borderWidth: 2,
              yAxisID: "y1",
              tension: 0.2,
              pointRadius: 3,
              datalabels: {
                anchor: "end",
                align: "end",
                formatter: v => v ? "â‚¹" + v.toFixed(0) : ""
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { position: "bottom" },
            datalabels: {
              color: "#374151",
              font: { size: 10, weight: "500" }
            }
          },
          scales: {
            x: { title: { display: true, text: "Hour of Day" } },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Spend (â‚¹) / Customers" }
            },
            y1: {
              position: "right",
              beginAtZero: true,
              title: { display: true, text: "Cost per Customer (â‚¹)" },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      // ---------- Graph 7 ----------
      createOrUpdateChart("graph7", {
        type: "bar",
        data: {
          labels: hours,
          datasets: [
            {
              type: "bar",
              label: "Hourly Bookings",
              data: hourlyBookings,
              backgroundColor: "#4e79a7",
              datalabels: {
                anchor: "end", align: "start",
                formatter: v => v ? v : ""
              }
            },
            {
              type: "bar",
              label: "Hourly Ad Spend (â‚¹)",
              data: hourlySpend,
              backgroundColor: "#e15759",
              datalabels: {
                anchor: "end", align: "start",
                formatter: v => v ? "â‚¹" + v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "line",
              label: "Cost per Booking (â‚¹)",
              data: costPerBooking,
              borderColor: "green",
              borderWidth: 2,
              yAxisID: "y1",
              tension: 0.2,
              pointRadius: 3,
              datalabels: {
                anchor: "end",
                align: "end",
                formatter: v => v ? "â‚¹" + v.toFixed(0) : ""
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { position: "bottom" },
            datalabels: {
              color: "#374151",
              font: { size: 10, weight: "500" }
            }
          },
          scales: {
            x: { title: { display: true, text: "Hour of Day" } },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Bookings / Spend (â‚¹)" }
            },
            y1: {
              position: "right",
              beginAtZero: true,
              title: { display: true, text: "Cost per Booking (â‚¹)" },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      // ---------- Graph 8: Revenue + Spend (bars) + ROAS (line) ----------
      createOrUpdateChart("graph8", {
        type: "bar",
        data: {
          labels: hours,
          datasets: [
            {
              type: "bar",
              label: "Hourly Revenue (â‚¹)",
              data: hourlyRevenue,
              backgroundColor: "#4e79a7",
              datalabels: {
                anchor: "end",
                align: "start",
                formatter: v => v ? "â‚¹" + v.toLocaleString("en-IN") : ""
              }
            },
            {
              type: "bar",
              label: "Hourly Ad Spend (â‚¹)",
              data: hourlySpend,
              backgroundColor: "#e15759",
              datalabels: {
                display: false   // hide to reduce clutter
              }
            },
            {
              type: "line",
              label: "ROAS (x)",
              data: roas,
              borderColor: "green",
              borderWidth: 2,
              yAxisID: "y1",
              tension: 0.2,
              pointRadius: 3,
              datalabels: {
                anchor: "end",
                align: "end",
                formatter: v => (v && v > 0.2) ? v.toFixed(1) + "x" : ""
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { position: "bottom" },
            datalabels: {
              color: "#374151",
              font: { size: 10, weight: "500" }
            }
          },
          scales: {
            x: { title: { display: true, text: "Hour of Day" } },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Revenue / Spend (â‚¹)" }
            },
            y1: {
              position: "right",
              beginAtZero: true,
              title: { display: true, text: "ROAS (x)" },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      const [y,m,d] = dateKey.split("-");
      dateInfo.textContent = `Showing data for: ${d}-${m}-${y}`;
    }

    async function refreshDashboard() {
      try {
        const cacheBust = (SHEET_CSV_URL.includes("?") ? "&" : "?") + "cb=" + Date.now();
        const res = await fetch(SHEET_CSV_URL + cacheBust);
        const text = await res.text();
        const parsed = parseCsv(text);
        if (!parsed) return;

        allRows = parsed.rows;
        availableDates = parsed.dateKeys;
        latestDateKey = parsed.latestDateKey;

        const datePicker = document.getElementById("datePicker");
        const todayKey = getTodayKey();

        // Decide which date to show:
        // 1) If nothing selected yet â†’ try today's date, else latest date
        // 2) If previously selected date no longer exists â†’ same fallback
        if (!selectedDateKey) {
          selectedDateKey = availableDates.includes(todayKey)
            ? todayKey
            : latestDateKey;
        } else if (!availableDates.includes(selectedDateKey)) {
          selectedDateKey = availableDates.includes(todayKey)
            ? todayKey
            : latestDateKey;
        }

        datePicker.min = availableDates[0];
        datePicker.max = latestDateKey;
        datePicker.value = selectedDateKey;

        renderDashboardForDate(selectedDateKey);

        document.getElementById("lastUpdated").textContent =
          "Last updated: " + new Date().toLocaleString("en-IN") +
          " | Available dates: " + availableDates.join(", ");
      } catch (e) {
        console.error("Error loading sheet:", e);
        document.getElementById("lastUpdated").textContent =
          "Error loading data. Check console.";
      }
    }

    document.getElementById("datePicker").addEventListener("change", e => {
      selectedDateKey = e.target.value;
      renderDashboardForDate(selectedDateKey);
    });

    refreshDashboard();
    setInterval(refreshDashboard, 5 * 60 * 1000);
  </script>
</body>
</html>

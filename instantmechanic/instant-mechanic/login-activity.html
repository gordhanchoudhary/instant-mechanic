<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Activity Dashboard - Instant Mechanic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }

        .container {
            min-height: 100vh;
            padding: 24px;
        }

        /* Header */
        .header {
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: bold;
            color: #111827;
            margin-bottom: 4px;
        }

        .header p {
            color: #6b7280;
        }

        .timezone-badge {
            background-color: #2563eb;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 24px;
        }

        .stat-card-content {
            display: flex;
            align-items: center;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
        }

        .stat-icon.blue { background-color: #dbeafe; }
        .stat-icon.green { background-color: #dcfce7; }
        .stat-icon.purple { background-color: #f3e8ff; }

        .stat-info h3 {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .stat-info p {
            font-size: 24px;
            font-weight: bold;
            color: #111827;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 32px;
        }

        .card-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .card-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .card-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .card-content {
            padding: 24px;
        }

        /* Filters */
        .filter-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .filter-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead tr {
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        th, td {
            text-align: left;
            padding: 12px 16px;
        }

        th {
            font-weight: 500;
            color: #6b7280;
        }

        tbody tr {
            border-bottom: 1px solid #f3f4f6;
        }

        tbody tr:hover {
            background-color: #f9fafb;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge.blue { background-color: #dbeafe; color: #1d4ed8; }
        .badge.green { background-color: #dcfce7; color: #166534; }
        .badge.yellow { background-color: #fef3c7; color: #d97706; }
        .badge.red { background-color: #fee2e2; color: #dc2626; }
        .badge.gray { background-color: #f3f4f6; color: #374151; }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            margin-top: 16px;
            color: #6b7280;
        }

        /* Empty state */
        .empty-state {
            padding: 32px;
            text-align: center;
            color: #6b7280;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            color: #d1d5db;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header h1 {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Agent Activity Dashboard</h1>
                <p>Instant Mechanic - Track agent working hours and productivity</p>
            </div>
            <div class="timezone-badge">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12,6 12,12 16,14"/>
                </svg>
                IST Timezone
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading agent activities...</p>
        </div>

        <!-- Main Content -->
        <div id="main-content" style="display: none;">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-content">
                        <div class="stat-icon blue">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12,6 12,12 16,14"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3>Today's Total Hours</h3>
                            <p id="today-total-hours">0h 0m</p>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-content">
                        <div class="stat-icon green">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3>Active Agents Today</h3>
                            <p id="active-agents-today">0</p>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-content">
                        <div class="stat-icon purple">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#9333ea" stroke-width="2">
                                <path d="M3 3v18h18"/>
                                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3>Total Sessions Today</h3>
                            <p id="total-sessions-today">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card">
                <div class="card-content">
                    <div class="filter-header">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2">
                            <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"/>
                        </svg>
                        <h2 style="margin-left: 8px; margin-bottom: 0;">Filters</h2>
                    </div>

                    <div class="filters-grid">
                        <div class="filter-group">
                            <label for="agent-filter">Agent</label>
                            <select id="agent-filter">
                                <option value="">All Agents</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="date-filter">Date</label>
                            <input type="date" id="date-filter">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Day-wise Summary -->
            <div class="card">
                <div class="card-header">
                    <h2>Day-wise Agent Summary</h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Agent</th>
                                <th>Total Working Hours</th>
                            </tr>
                        </thead>
                        <tbody id="daywise-summary-body">
                        </tbody>
                    </table>
                </div>
                <div id="daywise-empty" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <p>No summary data available for selected filters</p>
                </div>
            </div>

            <!-- Activity Details -->
            <div class="card">
                <div class="card-header">
                    <h2>Activity Details</h2>
                    <p>Detailed view of all agent activities</p>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th>Start Time (IST)</th>
                                <th>End Time (IST)</th>
                                <th>Duration</th>
                                <th>Activity Type</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="activity-details-body">
                        </tbody>
                    </table>
                </div>
                <div id="activity-empty" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <p>No activities found for the selected filters</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let activities = [];
        let filteredActivities = [];
        let agents = [];

        // DOM elements
        const loading = document.getElementById('loading');
        const mainContent = document.getElementById('main-content');
        const agentFilter = document.getElementById('agent-filter');
        const dateFilter = document.getElementById('date-filter');
        const daywiseSummaryBody = document.getElementById('daywise-summary-body');
        const activityDetailsBody = document.getElementById('activity-details-body');
        const daywiseEmpty = document.getElementById('daywise-empty');
        const activityEmpty = document.getElementById('activity-empty');

        // Fetch data from API
        async function fetchData() {
            try {
                const response = await fetch('https://ai.instantmechanic.online/bot/api/agent-activity/');
                const data = await response.json();
                activities = data;
                
                // Extract unique agents
                agents = [...new Set(data.map(item => item.agent_name))];
                populateAgentFilter();
                
                // Initial filter
                applyFilters();
                
                // Hide loading and show content
                loading.style.display = 'none';
                mainContent.style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching data:', error);
                loading.innerHTML = '<p style="color: #ef4444;">Error loading data. Please try again later.</p>';
            }
        }

        // Populate agent filter dropdown
        function populateAgentFilter() {
            agentFilter.innerHTML = '<option value="">All Agents</option>';
            agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent;
                option.textContent = agent;
                agentFilter.appendChild(option);
            });
        }

        // Convert UTC to IST
        function formatToIST(utcTime) {
            if (!utcTime) return 'Ongoing';
            const date = new Date(utcTime);
            return date.toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Calculate duration
        function calculateDuration(startTime, endTime) {
            if (!endTime) return 'Ongoing';
            
            const start = new Date(startTime);
            const end = new Date(endTime);
            const diffMs = end - start;
            
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
            
            return `${hours}h ${minutes}m ${seconds}s`;
        }

        // Apply filters
        function applyFilters() {
            const selectedAgent = agentFilter.value;
            const selectedDate = dateFilter.value;

            filteredActivities = activities.filter(activity => {
                // Agent filter
                if (selectedAgent && activity.agent_name !== selectedAgent) {
                    return false;
                }

                // Date filter
                if (selectedDate) {
                    const activityDate = new Date(activity.start_time).toDateString();
                    const filterDate = new Date(selectedDate).toDateString();
                    if (activityDate !== filterDate) {
                        return false;
                    }
                }

                return true;
            });

            updateStats();
            updateDaywiseSummary();
            updateActivityDetails();
        }

        // Update stats cards
        function updateStats() {
            const today = new Date().toDateString();
            const todayActivities = filteredActivities.filter(activity => 
                new Date(activity.start_time).toDateString() === today && 
                activity.activity_type === 'Regular' && 
                activity.end_time
            );

            const totalMs = todayActivities.reduce((acc, activity) => {
                const start = new Date(activity.start_time);
                const end = new Date(activity.end_time);
                return acc + (end - start);
            }, 0);

            const hours = Math.floor(totalMs / (1000 * 60 * 60));
            const minutes = Math.floor((totalMs % (1000 * 60 * 60)) / (1000 * 60));

            document.getElementById('today-total-hours').textContent = `${hours}h ${minutes}m`;
            document.getElementById('active-agents-today').textContent = 
                new Set(todayActivities.map(a => a.agent_name)).size;
            document.getElementById('total-sessions-today').textContent = todayActivities.length;
        }

        // Update day-wise summary
        function updateDaywiseSummary() {
            const summary = {};
            
            filteredActivities.forEach(activity => {
                if (!activity.end_time || activity.activity_type !== 'Regular') return;
                
                const date = new Date(activity.start_time).toDateString();
                const agent = activity.agent_name;
                const start = new Date(activity.start_time);
                const end = new Date(activity.end_time);
                const durationMs = end - start;
                
                if (!summary[date]) summary[date] = {};
                if (!summary[date][agent]) summary[date][agent] = 0;
                
                summary[date][agent] += durationMs;
            });

            // Convert to array and sort
            const summaryArray = [];
            Object.keys(summary).forEach(date => {
                Object.keys(summary[date]).forEach(agent => {
                    const totalMs = summary[date][agent];
                    const hours = Math.floor(totalMs / (1000 * 60 * 60));
                    const minutes = Math.floor((totalMs % (1000 * 60 * 60)) / (1000 * 60));
                    summaryArray.push({
                        date,
                        agent,
                        totalDuration: `${hours}h ${minutes}m`,
                        dateObj: new Date(date)
                    });
                });
            });

            summaryArray.sort((a, b) => b.dateObj - a.dateObj);

            // Update table
            daywiseSummaryBody.innerHTML = '';
            if (summaryArray.length === 0) {
                daywiseEmpty.style.display = 'block';
            } else {
                daywiseEmpty.style.display = 'none';
                summaryArray.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.dateObj.toLocaleDateString('en-IN')}</td>
                        <td style="font-weight: 500;">${item.agent}</td>
                        <td><span class="badge green">${item.totalDuration}</span></td>
                    `;
                    daywiseSummaryBody.appendChild(row);
                });
            }
        }

        // Update activity details
        function updateActivityDetails() {
            activityDetailsBody.innerHTML = '';
            
            if (filteredActivities.length === 0) {
                activityEmpty.style.display = 'block';
                return;
            }

            activityEmpty.style.display = 'none';
            
            filteredActivities.forEach(activity => {
                const row = document.createElement('tr');
                
                // Activity type badge class
                let activityBadgeClass = 'gray';
                if (activity.activity_type === 'Regular') activityBadgeClass = 'green';
                else if (activity.activity_type === 'Inactive Team') activityBadgeClass = 'red';

                // Status badge class
                const statusBadgeClass = activity.end_time ? 'gray' : 'green';
                const statusText = activity.end_time ? 'Completed' : 'Active';

                // Duration badge class
                const durationBadgeClass = activity.end_time ? 'blue' : 'yellow';

                row.innerHTML = `
                    <td style="font-weight: 500; color: #111827;">${activity.agent_name}</td>
                    <td>${formatToIST(activity.start_time)}</td>
                    <td>${formatToIST(activity.end_time)}</td>
                    <td><span class="badge ${durationBadgeClass}">${calculateDuration(activity.start_time, activity.end_time)}</span></td>
                    <td><span class="badge ${activityBadgeClass}">${activity.activity_type || 'Unknown'}</span></td>
                    <td><span class="badge ${statusBadgeClass}">${statusText}</span></td>
                `;
                activityDetailsBody.appendChild(row);
            });
        }

        // Event listeners
        agentFilter.addEventListener('change', applyFilters);
        dateFilter.addEventListener('change', applyFilters);

        // Initialize
        fetchData();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Performance Dashboard - Instant Mechanic</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #059669;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --gradient-danger: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-900);
            line-height: 1.6;
        }

        .main-container {
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.98);
            border-bottom: 1px solid var(--gray-200);
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(20px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 1.875rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-subtitle {
            color: var(--gray-600);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Filters */
        .filters-container {
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin: 1.5rem 2rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .filters-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filters-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .view-modes {
            display: flex;
            background: var(--gray-100);
            border-radius: 0.75rem;
            padding: 0.25rem;
            gap: 0.25rem;
        }

        .view-mode-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--gray-600);
        }

        .view-mode-btn.active {
            background: white;
            color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .filter-input {
            padding: 0.75rem 1rem;
            border: 1.5px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: white;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .date-range-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .date-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .date-btn:hover {
            background: var(--gray-50);
        }

        .date-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Main Content */
        .dashboard-content {
            padding: 0 2rem 2rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .kpi-card.success::before { background: var(--gradient-success); }
        .kpi-card.warning::before { background: var(--gradient-warning); }
        .kpi-card.danger::before { background: var(--gradient-danger); }

        .kpi-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .kpi-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .kpi-icon.primary { background: rgba(59, 130, 246, 0.1); color: var(--primary-color); }
        .kpi-icon.success { background: rgba(16, 185, 129, 0.1); color: var(--success-color); }
        .kpi-icon.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning-color); }
        .kpi-icon.danger { background: rgba(239, 68, 68, 0.1); color: var(--danger-color); }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .kpi-trend.positive { color: var(--success-color); }
        .kpi-trend.negative { color: var(--danger-color); }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .kpi-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        .kpi-subtitle {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
            font-style: italic;
        }

        /* Single agent analysis indicator */
        .analysis-mode-indicator {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 600;
            box-shadow: var(--shadow);
        }

        .analysis-mode-indicator i {
            margin-right: 0.5rem;
        }

        /* Charts */
        .charts-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .chart-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .chart-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .chart-subtitle {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            background: var(--gray-50);
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .table-subtitle {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-100);
        }

        .data-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        .agent-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .agent-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .agent-type-badge.primary {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .agent-type-badge.secondary {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.live {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-badge.offline {
            background: rgba(107, 114, 128, 0.1);
            color: var(--gray-600);
        }

        /* Performance indicators */
        .metric-value {
            font-weight: 600;
        }

        .metric-positive {
            color: var(--success-color);
        }

        .metric-negative {
            color: var(--danger-color);
        }

        .metric-warning {
            color: var(--warning-color);
        }

        .metric-neutral {
            color: var(--gray-700);
        }

        .metric-primary {
            color: var(--primary-color);
        }

        /* Highlight for low working hours */
        .low-hours {
            background: rgba(239, 68, 68, 0.05) !important;
            border-left: 3px solid var(--danger-color);
        }

        /* Problem indicators */
        .conversion-problem {
            color: var(--danger-color);
            font-weight: 600;
        }

        .cancellation-problem {
            color: var(--danger-color);
            font-weight: 600;
            background: rgba(239, 68, 68, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Action buttons */
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-700);
        }

        .action-btn:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .action-btn.primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .action-btn.primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .filters-container {
                margin: 1rem;
                padding: 1rem;
            }

            .dashboard-content {
                padding: 0 1rem 2rem 1rem;
            }

            .table-container {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-chart-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                    <div>
                        <h1>Agent Performance Dashboard</h1>
                        <div class="header-subtitle">Real-time insights and performance tracking - Instant Mechanic</div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="action-btn" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="action-btn" id="exportBtn">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
        </header>

        <!-- Filters -->
        <div class="filters-container">
            <div class="filters-header">
                <h3>
                    <i class="fas fa-filter"></i>
                    Filters & Settings
                </h3>
                <div class="view-modes">
                    <button class="view-mode-btn" data-agent-type="all">All Agents</button>
                    <button class="view-mode-btn active" data-agent-type="primary">Primary Agents</button>
                    <button class="view-mode-btn" data-agent-type="secondary">Secondary Agents</button>
                </div>
            </div>
            
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="dateRange">Quick Date Range</label>
                    <div class="date-range-buttons">
                        <button class="date-btn active" data-range="today">Today</button>
                        <button class="date-btn" data-range="yesterday">Yesterday</button>
                        <button class="date-btn" data-range="last7days">7 Days</button>
                        <button class="date-btn" data-range="last15days">15 Days</button>
                        <button class="date-btn" data-range="last30days">30 Days</button>
                        <button class="date-btn" data-range="custom">Custom</button>
                    </div>
                </div>
                
                <div class="filter-group" id="customDateGroup" style="display: none;">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate" class="filter-input">
                </div>
                
                <div class="filter-group" id="customDateGroupEnd" style="display: none;">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate" class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label for="agentSelect">Select Agent</label>
                    <select id="agentSelect" class="filter-input">
                        <option value="">All Agents</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Content -->
        <div class="dashboard-content">
            <!-- Loading State -->
            <div id="loadingState" class="loading">
                <div class="loading-spinner"></div>
                <p>Loading performance data...</p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent" style="display: none;">
                
                <!-- Single Agent Analysis Indicator -->
                <div id="singleAgentIndicator" class="analysis-mode-indicator" style="display: none;">
                    <i class="fas fa-user-chart"></i>
                    <span id="singleAgentIndicatorText">Single Agent Day-wise Analysis</span>
                </div>
                
                <!-- KPI Cards -->
                <div class="kpi-grid">
                    <div class="kpi-card primary">
                        <div class="kpi-header">
                            <div class="kpi-icon primary">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="kpi-trend positive" id="chatsTrend">
                                <i class="fas fa-arrow-up"></i>
                                <span>+0%</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="totalChats">0</div>
                        <div class="kpi-label">Total Chats Attended</div>
                        <div class="kpi-subtitle" id="chatsAvg"></div>
                    </div>

                    <div class="kpi-card success">
                        <div class="kpi-header">
                            <div class="kpi-icon success">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="kpi-trend" id="conversionTrend">
                                <i class="fas fa-arrow-up"></i>
                                <span>0%</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="conversionRate">0%</div>
                        <div class="kpi-label">Conversion Rate</div>
                        <div class="kpi-subtitle" id="conversionAvg"></div>
                    </div>

                    <div class="kpi-card danger">
                        <div class="kpi-header">
                            <div class="kpi-icon danger">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="kpi-trend" id="cancellationTrend">
                                <i class="fas fa-arrow-up"></i>
                                <span>0%</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="cancellationRate">0%</div>
                        <div class="kpi-label">Cancellation Rate</div>
                        <div class="kpi-subtitle" id="cancellationAvg"></div>
                    </div>

                    <div class="kpi-card success">
                        <div class="kpi-header">
                            <div class="kpi-icon success">
                                <i class="fas fa-rupee-sign"></i>
                            </div>
                            <div class="kpi-trend positive" id="revenueTrend">
                                <i class="fas fa-arrow-up"></i>
                                <span>+0%</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="totalRevenue">₹0</div>
                        <div class="kpi-label">Total Revenue</div>
                        <div class="kpi-subtitle" id="revenueAvg"></div>
                    </div>

                    <div class="kpi-card warning">
                        <div class="kpi-header">
                            <div class="kpi-icon warning">
                                <i class="fas fa-chart-line-down"></i>
                            </div>
                            <div class="kpi-trend negative" id="revenueLossTrend">
                                <i class="fas fa-arrow-up"></i>
                                <span>₹0</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="revenueLoss">₹0</div>
                        <div class="kpi-label">Revenue Lost</div>
                        <div class="kpi-subtitle" id="revenueLossAvg"></div>
                    </div>
                </div>

                <!-- Performance Charts -->
                <div class="charts-section">
                    <h2 class="section-title" id="analyticsTitle">
                        <i class="fas fa-chart-bar"></i>
                        Performance Analytics
                    </h2>
                    
                    <div class="charts-grid">
                        <!-- Main Performance Chart -->
                        <div class="chart-card" style="grid-column: span 2;">
                            <div class="chart-header">
                                <div class="chart-title">Chats, Conversions & Cancellations</div>
                                <div class="chart-subtitle">Daily performance trends</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="mainPerformanceChart"></canvas>
                            </div>
                        </div>

                        <!-- Conversion Rate by Agent -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Conversion Rate by Agent</div>
                                <div class="chart-subtitle">Shows total bookings for each agent</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="conversionChart"></canvas>
                            </div>
                        </div>

                        <!-- Cancellation Rate by Agent -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Cancellation Rate by Agent</div>
                                <div class="chart-subtitle">Shows cancelled bookings for each agent</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="cancellationChart"></canvas>
                            </div>
                        </div>

                        <!-- Agent Productivity -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Agent Productivity</div>
                                <div class="chart-subtitle">Revenue vs working hours</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="productivityChart"></canvas>
                            </div>
                        </div>

                        <!-- Daily Revenue Trends -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">Revenue vs Revenue Loss</div>
                                <div class="chart-subtitle">Daily revenue earned vs lost</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Revenue Loss Table -->
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Revenue Loss Analysis</div>
                        <div class="table-subtitle">Potential revenue lost due to cancellations</div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Agent</th>
                                    <th>Type</th>
                                    <th>Total Bookings</th>
                                    <th>Cancelled Bookings</th>
                                    <th>Cancellation Rate</th>
                                    <th>Revenue Earned</th>
                                    <th>Estimated Revenue Lost</th>
                                    <th>Recovery Potential</th>
                                </tr>
                            </thead>
                            <tbody id="revenueLossTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Date-wise Agent Duration -->
                <div class="table-container" id="agentDurationContainer">
                    <div class="table-header">
                        <div class="table-title">Date-wise Agent Duration</div>
                        <div class="table-subtitle">Daily working hours - agents with less than 6 hours are highlighted</div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Agent</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Sessions</th>
                                    <th>Performance</th>
                                </tr>
                            </thead>
                            <tbody id="agentDurationTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Single Agent Day-wise Breakdown (shown only when single agent + multiple dates) -->
                <div class="table-container" id="singleAgentBreakdownContainer" style="display: none;">
                    <div class="table-header">
                        <div class="table-title" id="singleAgentBreakdownTitle">Agent Day-wise Performance Breakdown</div>
                        <div class="table-subtitle">Daily performance analysis for detailed insights</div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Working Hours</th>
                                    <th>Chats</th>
                                    <th>Bookings</th>
                                    <th>Cancelled</th>
                                    <th>Conversion Rate</th>
                                    <th>Cancellation Rate</th>
                                    <th>Revenue</th>
                                    <th>Efficiency</th>
                                    <th>Performance</th>
                                </tr>
                            </thead>
                            <tbody id="singleAgentBreakdownTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Detailed Agent Performance -->
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Detailed Agent Performance & Cancellation Analysis</div>
                        <div class="table-subtitle">Comprehensive performance metrics with advanced analytics</div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Agent</th>
                                    <th>Type</th>
                                    <th>Working Hours</th>
                                    <th>Chats</th>
                                    <th>Bookings</th>
                                    <th>Cancelled</th>
                                    <th>Conversion Rate</th>
                                    <th>Cancellation Rate</th>
                                    <th>Revenue</th>
                                    <th>Efficiency</th>
                                </tr>
                            </thead>
                            <tbody id="performanceTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let performanceData = [];
        let activityData = [];
        let allAgents = [];
        let charts = {};
        
        // Current filter state
        let currentFilters = {
            dateRange: 'today',
            startDate: '',
            endDate: '',
            agent: '',
            agentType: 'primary'
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            setDefaultDates();
            loadDashboardData();
        });

        // Event listeners
        function initializeEventListeners() {
            // Date range buttons
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const range = this.getAttribute('data-range');
                    currentFilters.dateRange = range;
                    
                    if (range === 'custom') {
                        document.getElementById('customDateGroup').style.display = 'block';
                        document.getElementById('customDateGroupEnd').style.display = 'block';
                    } else {
                        document.getElementById('customDateGroup').style.display = 'none';
                        document.getElementById('customDateGroupEnd').style.display = 'none';
                        setDateRange(range);
                        loadDashboardData();
                    }
                });
            });

            // Agent type buttons
            document.querySelectorAll('[data-agent-type]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-agent-type]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilters.agentType = this.getAttribute('data-agent-type');
                    loadDashboardData();
                });
            });

            // Custom date inputs
            document.getElementById('startDate').addEventListener('change', function() {
                currentFilters.startDate = this.value;
                if (currentFilters.dateRange === 'custom' && currentFilters.endDate) {
                    loadDashboardData();
                }
            });

            document.getElementById('endDate').addEventListener('change', function() {
                currentFilters.endDate = this.value;
                if (currentFilters.dateRange === 'custom' && currentFilters.startDate) {
                    loadDashboardData();
                }
            });

            // Agent select
            document.getElementById('agentSelect').addEventListener('change', function() {
                currentFilters.agent = this.value;
                loadDashboardData();
            });

            // Action buttons
            document.getElementById('refreshBtn').addEventListener('click', loadDashboardData);
            document.getElementById('exportBtn').addEventListener('click', exportData);
        }

        // Set default dates (today)
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            currentFilters.startDate = today;
            currentFilters.endDate = today;
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
        }

        // Set date range based on selection
        function setDateRange(range) {
            const today = new Date();
            let startDate, endDate;

            switch (range) {
                case 'today':
                    startDate = endDate = today.toISOString().split('T')[0];
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    startDate = endDate = yesterday.toISOString().split('T')[0];
                    break;
                case 'last7days':
                    endDate = today.toISOString().split('T')[0];
                    const sevenDaysAgo = new Date(today);
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    startDate = sevenDaysAgo.toISOString().split('T')[0];
                    break;
                case 'last15days':
                    endDate = today.toISOString().split('T')[0];
                    const fifteenDaysAgo = new Date(today);
                    fifteenDaysAgo.setDate(fifteenDaysAgo.getDate() - 15);
                    startDate = fifteenDaysAgo.toISOString().split('T')[0];
                    break;
                case 'last30days':
                    endDate = today.toISOString().split('T')[0];
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    startDate = thirtyDaysAgo.toISOString().split('T')[0];
                    break;
            }

            currentFilters.startDate = startDate;
            currentFilters.endDate = endDate;
            document.getElementById('startDate').value = startDate;
            document.getElementById('endDate').value = endDate;
        }

        // Load dashboard data
        async function loadDashboardData() {
            showLoading();

            try {
                // Build date parameter
                let dates = [];
                if (currentFilters.dateRange === 'today' || currentFilters.dateRange === 'yesterday') {
                    dates = [currentFilters.startDate];
                } else {
                    const start = new Date(currentFilters.startDate);
                    const end = new Date(currentFilters.endDate);
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        dates.push(d.toISOString().split('T')[0]);
                    }
                }

                const dateParam = dates.join(',');
                const agentParam = currentFilters.agent ? `&agent=${currentFilters.agent}` : '';

                // Fetch performance data
                const performanceResponse = await fetch(`https://ai.instantmechanic.online/bot/api/agent-performance?date=${dateParam}${agentParam}`);
                const rawPerformanceData = await performanceResponse.json();

                // Fetch activity data
                const activityResponse = await fetch(`https://ai.instantmechanic.online/bot/api/agent-activity/?date=${dateParam}${agentParam}`);
                activityData = await activityResponse.json();

                // Store all agents before filtering
                allAgents = [...new Set(rawPerformanceData.map(item => item.agent))];

                // Filter by agent type
                if (currentFilters.agentType !== 'all') {
                    const agentTypeFilter = currentFilters.agentType === 'primary' ? 'primary' : 'secondary';
                    performanceData = rawPerformanceData.filter(agent => {
                        if (agentTypeFilter === 'primary') {
                            return agent.agent_type === 'primary' || agent.agent_type === 'both';
                        } else {
                            return agent.agent_type === 'secondary';
                        }
                    });
                } else {
                    performanceData = rawPerformanceData;
                }

                // Update dropdown
                updateAgentSelect();

                // Update dashboard
                updateKPIs();
                updateCharts();
                updateTables();

                hideLoading();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                hideLoading();
            }
        }

        // Update agent select dropdown
        function updateAgentSelect() {
            const agentSelect = document.getElementById('agentSelect');
            const currentValue = agentSelect.value;
            
            agentSelect.innerHTML = '<option value="">All Agents</option>';
            
            allAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent;
                option.textContent = agent;
                agentSelect.appendChild(option);
            });
            
            if (currentValue && allAgents.includes(currentValue)) {
                agentSelect.value = currentValue;
            }
        }

        // Update KPIs
        function updateKPIs() {
            const totals = performanceData.reduce((acc, agent) => {
                acc.chats += agent.chats_handled || 0;
                acc.bookings += agent.total_bookings || 0;
                acc.cancellations += agent.cancelled_bookings || 0;
                acc.revenue += agent.total_revenue || 0;
                return acc;
            }, { chats: 0, bookings: 0, cancellations: 0, revenue: 0 });

            // Calculate rates
            const conversionRate = totals.chats > 0 ? 
                ((totals.bookings / totals.chats) * 100) : 0;
            const cancellationRate = totals.bookings > 0 ? 
                ((totals.cancellations / totals.bookings) * 100) : 0;

            // Calculate revenue loss
            const avgBookingValue = (totals.bookings - totals.cancellations) > 0 ? 
                totals.revenue / (totals.bookings - totals.cancellations) : 0;
            const revenueLoss = totals.cancellations * avgBookingValue;

            // Calculate total days in selected range
            let totalDays = 1;
            if (currentFilters.dateRange !== 'today' && currentFilters.dateRange !== 'yesterday') {
                const startDate = new Date(currentFilters.startDate);
                const endDate = new Date(currentFilters.endDate);
                totalDays = Math.max(1, Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1);
            }

            // Update KPI values
            document.getElementById('totalChats').textContent = totals.chats.toLocaleString();
            document.getElementById('conversionRate').textContent = conversionRate.toFixed(1) + '%';
            document.getElementById('cancellationRate').textContent = cancellationRate.toFixed(1) + '%';
            document.getElementById('totalRevenue').textContent = `₹${totals.revenue.toLocaleString()}`;
            document.getElementById('revenueLoss').textContent = `₹${Math.round(revenueLoss).toLocaleString()}`;

            // Update daily averages (show only if multiple days)
            if (totalDays > 1) {
                document.getElementById('chatsAvg').textContent = `Avg ${Math.round(totals.chats / totalDays)} chats/day`;
                document.getElementById('conversionAvg').textContent = `${Math.round(totals.bookings / totalDays)} bookings/day avg`;
                document.getElementById('cancellationAvg').textContent = `${Math.round(totals.cancellations / totalDays)} cancelled/day avg`;
                document.getElementById('revenueAvg').textContent = `Avg ₹${Math.round(totals.revenue / totalDays).toLocaleString()}/day`;
                document.getElementById('revenueLossAvg').textContent = `Avg ₹${Math.round(revenueLoss / totalDays).toLocaleString()}/day`;
            } else {
                document.getElementById('chatsAvg').textContent = '';
                document.getElementById('conversionAvg').textContent = '';
                document.getElementById('cancellationAvg').textContent = '';
                document.getElementById('revenueAvg').textContent = '';
                document.getElementById('revenueLossAvg').textContent = '';
            }

            // Update KPI card styling based on business rules
            const conversionCard = document.querySelector('#conversionRate').closest('.kpi-card');
            const cancellationCard = document.querySelector('#cancellationRate').closest('.kpi-card');
            
            // Conversion rate: problem if < 45%
            if (conversionRate < 45) {
                conversionCard.classList.remove('success');
                conversionCard.classList.add('danger');
            } else {
                conversionCard.classList.remove('danger');
                conversionCard.classList.add('success');
            }

            // Cancellation rate: major problem if > 30%
            if (cancellationRate > 30) {
                cancellationCard.classList.remove('warning');
                cancellationCard.classList.add('danger');
            } else if (cancellationRate > 20) {
                cancellationCard.classList.remove('danger', 'success');
                cancellationCard.classList.add('warning');
            } else {
                cancellationCard.classList.remove('danger', 'warning');
                cancellationCard.classList.add('success');
            }
        }

        // Update all charts
        function updateCharts() {
            // Check if we're analyzing a single agent with multiple dates
            const isSingleAgentAnalysis = currentFilters.agent && getCurrentDateCount() > 1;
            
            // Update analytics title
            const analyticsTitle = document.getElementById('analyticsTitle');
            if (isSingleAgentAnalysis) {
                analyticsTitle.innerHTML = `<i class="fas fa-chart-bar"></i> ${currentFilters.agent} - Day-wise Performance Analytics`;
            } else {
                analyticsTitle.innerHTML = `<i class="fas fa-chart-bar"></i> Performance Analytics`;
            }

            updateMainPerformanceChart();
            updateConversionChart();
            updateCancellationChart();
            updateProductivityChart();
            updateRevenueChart();
        }

        // Get current date count
        function getCurrentDateCount() {
            if (currentFilters.dateRange === 'today' || currentFilters.dateRange === 'yesterday') {
                return 1;
            } else {
                const startDate = new Date(currentFilters.startDate);
                const endDate = new Date(currentFilters.endDate);
                return Math.max(1, Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1);
            }
        }

        // Update main performance chart
        function updateMainPerformanceChart() {
            const ctx = document.getElementById('mainPerformanceChart').getContext('2d');
            
            if (charts.mainPerformance) charts.mainPerformance.destroy();

            const isSingleAgentAnalysis = currentFilters.agent && getCurrentDateCount() > 1;

            // Group data by date
            const dateGroups = {};
            performanceData.forEach(agent => {
                // For single agent analysis, only include selected agent
                if (isSingleAgentAnalysis && agent.agent !== currentFilters.agent) return;
                
                if (!dateGroups[agent.date]) {
                    dateGroups[agent.date] = {
                        chats: 0,
                        bookings: 0,
                        cancelled: 0
                    };
                }
                dateGroups[agent.date].chats += agent.chats_handled || 0;
                dateGroups[agent.date].bookings += agent.total_bookings || 0;
                dateGroups[agent.date].cancelled += agent.cancelled_bookings || 0;
            });

            const labels = Object.keys(dateGroups).sort();
            const chatsData = labels.map(date => dateGroups[date].chats);
            const bookingsData = labels.map(date => dateGroups[date].bookings);
            const cancelledData = labels.map(date => dateGroups[date].cancelled);

            const chartTitle = isSingleAgentAnalysis ? 
                `${currentFilters.agent} - Daily Performance` : 
                'Team Daily Performance';

            charts.mainPerformance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(date => new Date(date).toLocaleDateString()),
                    datasets: [{
                        label: 'Chats Attended',
                        data: chatsData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Conversions',
                        data: bookingsData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Cancellations',
                        data: cancelledData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        title: {
                            display: isSingleAgentAnalysis,
                            text: chartTitle
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        }
                    }
                }
            });
        }

        // Update single agent breakdown table (day-wise analysis)
        function updateSingleAgentBreakdownTable() {
            const tbody = document.getElementById('singleAgentBreakdownTableBody');
            const titleElement = document.getElementById('singleAgentBreakdownTitle');
            
            tbody.innerHTML = '';
            titleElement.textContent = `${currentFilters.agent} - Day-wise Performance Breakdown`;

            // Get agent working hours by date
            const agentHoursByDate = {};
            activityData.forEach(activity => {
                if (activity.activity_type !== 'Regular' || activity.agent_name !== currentFilters.agent) return;
                
                const date = activity.start_time.split('T')[0];
                
                if (!agentHoursByDate[date]) {
                    agentHoursByDate[date] = 0;
                }
                
                let hours;
                if (activity.end_time) {
                    const start = new Date(activity.start_time);
                    const end = new Date(activity.end_time);
                    hours = (end - start) / (1000 * 60 * 60);
                } else {
                    const start = new Date(activity.start_time);
                    const now = new Date();
                    hours = (now - start) / (1000 * 60 * 60);
                }
                
                agentHoursByDate[date] += hours;
            });

            // Filter performance data for selected agent and sort by date
            const agentPerformanceByDate = performanceData
                .filter(data => data.agent === currentFilters.agent)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            agentPerformanceByDate.forEach(dayData => {
                const workingHours = agentHoursByDate[dayData.date] || 0;
                
                const conversionRate = dayData.chats_handled > 0 ? 
                    ((dayData.total_bookings / dayData.chats_handled) * 100) : 0;
                const cancellationRate = dayData.total_bookings > 0 ? 
                    (((dayData.cancelled_bookings || 0) / dayData.total_bookings) * 100) : 0;
                
                // Calculate efficiency (revenue per hour)
                const efficiency = workingHours > 0 ? 
                    Math.round(dayData.total_revenue / workingHours) : 0;
                
                // Determine performance status
                let performanceStatus = 'Good';
                let performanceClass = 'metric-positive';
                
                if (conversionRate < 45 || cancellationRate > 30 || workingHours < 6) {
                    performanceStatus = 'Poor';
                    performanceClass = 'metric-negative';
                } else if (cancellationRate > 20 || conversionRate < 60 || workingHours < 8) {
                    performanceStatus = 'Average';
                    performanceClass = 'metric-warning';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-medium">${new Date(dayData.date).toLocaleDateString()}</td>
                    <td class="metric-value ${workingHours < 6 ? 'metric-negative' : 'metric-neutral'}">
                        ${workingHours.toFixed(1)}h
                    </td>
                    <td class="metric-value">${(dayData.chats_handled || 0).toLocaleString()}</td>
                    <td class="metric-value">${(dayData.total_bookings || 0).toLocaleString()}</td>
                    <td class="metric-value metric-negative">${(dayData.cancelled_bookings || 0).toLocaleString()}</td>
                    <td class="metric-value ${conversionRate < 45 ? 'conversion-problem' : conversionRate >= 60 ? 'metric-positive' : 'metric-neutral'}">
                        ${conversionRate.toFixed(1)}%
                    </td>
                    <td class="metric-value ${cancellationRate > 30 ? 'cancellation-problem' : cancellationRate > 20 ? 'metric-warning' : 'metric-positive'}">
                        ${cancellationRate.toFixed(1)}%
                    </td>
                    <td class="metric-value metric-positive">₹${(dayData.total_revenue || 0).toLocaleString()}</td>
                    <td class="metric-value metric-primary">₹${efficiency}/hr</td>
                    <td class="metric-value ${performanceClass}">${performanceStatus}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update conversion chart
        function updateConversionChart() {
            const ctx = document.getElementById('conversionChart').getContext('2d');
            
            if (charts.conversion) charts.conversion.destroy();

            const isSingleAgentAnalysis = currentFilters.agent && getCurrentDateCount() > 1;

            let labels, conversionRates, bookingsCount, chartTitle, yAxisTitle;

            if (isSingleAgentAnalysis) {
                // Show day-wise conversion rates for single agent
                const agentDayData = performanceData
                    .filter(data => data.agent === currentFilters.agent)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                
                labels = agentDayData.map(data => new Date(data.date).toLocaleDateString());
                conversionRates = agentDayData.map(data => {
                    return data.chats_handled > 0 ? 
                        ((data.total_bookings / data.chats_handled) * 100).toFixed(1) : 0;
                });
                bookingsCount = agentDayData.map(data => data.total_bookings || 0);
                chartTitle = `${currentFilters.agent} - Daily Conversion Rate`;
                yAxisTitle = 'Daily Conversion Rate (%)';
            } else {
                // Show agent comparison
                const agentTotals = {};
                performanceData.forEach(agent => {
                    if (!agentTotals[agent.agent]) {
                        agentTotals[agent.agent] = { chats: 0, bookings: 0 };
                    }
                    agentTotals[agent.agent].chats += agent.chats_handled || 0;
                    agentTotals[agent.agent].bookings += agent.total_bookings || 0;
                });

                labels = Object.keys(agentTotals);
                conversionRates = labels.map(agent => {
                    return agentTotals[agent].chats > 0 ? 
                        ((agentTotals[agent].bookings / agentTotals[agent].chats) * 100).toFixed(1) : 0;
                });
                bookingsCount = labels.map(agent => agentTotals[agent].bookings);
                chartTitle = 'Conversion Rate by Agent';
                yAxisTitle = 'Conversion Rate (%)';
            }

            // Color code based on conversion rate (problem if < 45%)
            const backgroundColors = conversionRates.map(rate => {
                return parseFloat(rate) < 45 ? '#ef4444' : '#10b981';
            });

            charts.conversion = new Chart(ctx, {
                type: isSingleAgentAnalysis ? 'line' : 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conversion Rate (%)',
                        data: conversionRates,
                        backgroundColor: isSingleAgentAnalysis ? 'rgba(16, 185, 129, 0.1)' : backgroundColors,
                        borderColor: isSingleAgentAnalysis ? '#10b981' : backgroundColors,
                        borderWidth: 1,
                        tension: isSingleAgentAnalysis ? 0.4 : 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: isSingleAgentAnalysis,
                            text: chartTitle
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const bookings = bookingsCount[context.dataIndex];
                                    return `Total Bookings: ${bookings}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: yAxisTitle
                            }
                        }
                    }
                }
            });
        }

        // Update cancellation chart
        function updateCancellationChart() {
            const ctx = document.getElementById('cancellationChart').getContext('2d');
            
            if (charts.cancellation) charts.cancellation.destroy();

            const isSingleAgentAnalysis = currentFilters.agent && getCurrentDateCount() > 1;

            let labels, cancellationRates, cancelledCount, chartTitle, yAxisTitle;

            if (isSingleAgentAnalysis) {
                // Show day-wise cancellation rates for single agent
                const agentDayData = performanceData
                    .filter(data => data.agent === currentFilters.agent)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                
                labels = agentDayData.map(data => new Date(data.date).toLocaleDateString());
                cancellationRates = agentDayData.map(data => {
                    return data.total_bookings > 0 ? 
                        (((data.cancelled_bookings || 0) / data.total_bookings) * 100).toFixed(1) : 0;
                });
                cancelledCount = agentDayData.map(data => data.cancelled_bookings || 0);
                chartTitle = `${currentFilters.agent} - Daily Cancellation Rate`;
                yAxisTitle = 'Daily Cancellation Rate (%)';
            } else {
                // Show agent comparison
                const agentTotals = {};
                performanceData.forEach(agent => {
                    if (!agentTotals[agent.agent]) {
                        agentTotals[agent.agent] = { bookings: 0, cancelled: 0 };
                    }
                    agentTotals[agent.agent].bookings += agent.total_bookings || 0;
                    agentTotals[agent.agent].cancelled += agent.cancelled_bookings || 0;
                });

                labels = Object.keys(agentTotals);
                cancellationRates = labels.map(agent => {
                    return agentTotals[agent].bookings > 0 ? 
                        ((agentTotals[agent].cancelled / agentTotals[agent].bookings) * 100).toFixed(1) : 0;
                });
                cancelledCount = labels.map(agent => agentTotals[agent].cancelled);
                chartTitle = 'Cancellation Rate by Agent';
                yAxisTitle = 'Cancellation Rate (%)';
            }

            // Color code based on cancellation rate (major problem if > 30%)
            const backgroundColors = cancellationRates.map(rate => {
                if (parseFloat(rate) > 30) return '#ef4444'; // Red - Major problem
                if (parseFloat(rate) > 20) return '#f59e0b'; // Yellow - Warning
                return '#10b981'; // Green - Good
            });

            charts.cancellation = new Chart(ctx, {
                type: isSingleAgentAnalysis ? 'line' : 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cancellation Rate (%)',
                        data: cancellationRates,
                        backgroundColor: isSingleAgentAnalysis ? 'rgba(239, 68, 68, 0.1)' : backgroundColors,
                        borderColor: isSingleAgentAnalysis ? '#ef4444' : backgroundColors,
                        borderWidth: 1,
                        tension: isSingleAgentAnalysis ? 0.4 : 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: isSingleAgentAnalysis,
                            text: chartTitle
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const cancelled = cancelledCount[context.dataIndex];
                                    return `Cancelled Bookings: ${cancelled}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: yAxisTitle
                            }
                        }
                    }
                }
            });
        }

        // Update productivity chart
        function updateProductivityChart() {
            const ctx = document.getElementById('productivityChart').getContext('2d');
            
            if (charts.productivity) charts.productivity.destroy();

            // Calculate productivity metrics
            const agentProductivity = {};
            
            // Get performance data
            performanceData.forEach(agent => {
                if (!agentProductivity[agent.agent]) {
                    agentProductivity[agent.agent] = { 
                        revenue: 0, 
                        workingHours: 0,
                        bookings: 0
                    };
                }
                agentProductivity[agent.agent].revenue += agent.total_revenue || 0;
                agentProductivity[agent.agent].bookings += agent.total_bookings || 0;
            });

            // Get working hours from activity data
            activityData.forEach(activity => {
                if (activity.activity_type === 'Regular' && agentProductivity[activity.agent_name]) {
                    let hours;
                    if (activity.end_time) {
                        const start = new Date(activity.start_time);
                        const end = new Date(activity.end_time);
                        hours = (end - start) / (1000 * 60 * 60);
                    } else {
                        // Agent is live, calculate from start_time to current time
                        const start = new Date(activity.start_time);
                        const now = new Date();
                        hours = (now - start) / (1000 * 60 * 60);
                    }
                    agentProductivity[activity.agent_name].workingHours += hours;
                }
            });

            const agents = Object.keys(agentProductivity);
            const revenuePerHour = agents.map(agent => {
                const data = agentProductivity[agent];
                return data.workingHours > 0 ? (data.revenue / data.workingHours) : 0;
            });

            charts.productivity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: agents,
                    datasets: [{
                        label: 'Revenue per Hour (₹)',
                        data: revenuePerHour,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: '#3b82f6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Revenue per Hour (₹)'
                            }
                        }
                    }
                }
            });
        }

        // Update revenue chart
        function updateRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (charts.revenue) charts.revenue.destroy();

            // Group data by date
            const dateGroups = {};
            performanceData.forEach(agent => {
                if (!dateGroups[agent.date]) {
                    dateGroups[agent.date] = {
                        revenue: 0,
                        bookings: 0,
                        cancelled: 0
                    };
                }
                dateGroups[agent.date].revenue += agent.total_revenue || 0;
                dateGroups[agent.date].bookings += agent.total_bookings || 0;
                dateGroups[agent.date].cancelled += agent.cancelled_bookings || 0;
            });

            const labels = Object.keys(dateGroups).sort();
            const revenueData = labels.map(date => dateGroups[date].revenue);
            const revenueLossData = labels.map(date => {
                const successful = dateGroups[date].bookings - dateGroups[date].cancelled;
                const avgBookingValue = successful > 0 ? dateGroups[date].revenue / successful : 0;
                return dateGroups[date].cancelled * avgBookingValue;
            });

            charts.revenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(date => new Date(date).toLocaleDateString()),
                    datasets: [{
                        label: 'Revenue Earned (₹)',
                        data: revenueData,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: '#10b981',
                        borderWidth: 1
                    }, {
                        label: 'Revenue Lost (₹)',
                        data: revenueLossData,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: '#ef4444',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        }
                    }
                }
            });
        }

        // Update all tables
        function updateTables() {
            const isSingleAgentAnalysis = currentFilters.agent && getCurrentDateCount() > 1;
            
            // Show/hide single agent analysis indicator
            const indicator = document.getElementById('singleAgentIndicator');
            const indicatorText = document.getElementById('singleAgentIndicatorText');
            
            if (isSingleAgentAnalysis) {
                indicator.style.display = 'block';
                indicatorText.textContent = `${currentFilters.agent} - Day-wise Performance Analysis (${getCurrentDateCount()} days)`;
            } else {
                indicator.style.display = 'none';
            }
            
            updateRevenueLossTable();
            updateAgentDurationTable();
            updatePerformanceTable();
            
            // Show/hide single agent breakdown table
            const singleAgentContainer = document.getElementById('singleAgentBreakdownContainer');
            const agentDurationContainer = document.getElementById('agentDurationContainer');
            
            if (isSingleAgentAnalysis) {
                singleAgentContainer.style.display = 'block';
                agentDurationContainer.style.display = 'none'; // Hide general duration table
                updateSingleAgentBreakdownTable();
            } else {
                singleAgentContainer.style.display = 'none';
                agentDurationContainer.style.display = 'block';
            }
        }

        // Update revenue loss table
        function updateRevenueLossTable() {
            const tbody = document.getElementById('revenueLossTableBody');
            tbody.innerHTML = '';

            const agentTotals = {};
            performanceData.forEach(agent => {
                if (!agentTotals[agent.agent]) {
                    agentTotals[agent.agent] = {
                        type: agent.agent_type,
                        bookings: 0,
                        cancelled: 0,
                        revenue: 0
                    };
                }
                agentTotals[agent.agent].bookings += agent.total_bookings || 0;
                agentTotals[agent.agent].cancelled += agent.cancelled_bookings || 0;
                agentTotals[agent.agent].revenue += agent.total_revenue || 0;
            });

            // Sort by revenue loss descending
            const sortedAgents = Object.keys(agentTotals).sort((a, b) => {
                const lossA = agentTotals[a].cancelled * (agentTotals[a].revenue / (agentTotals[a].bookings - agentTotals[a].cancelled || 1));
                const lossB = agentTotals[b].cancelled * (agentTotals[b].revenue / (agentTotals[b].bookings - agentTotals[b].cancelled || 1));
                return lossB - lossA;
            });

            sortedAgents.forEach(agentName => {
                const agent = agentTotals[agentName];
                const cancellationRate = agent.bookings > 0 ? 
                    ((agent.cancelled / agent.bookings) * 100).toFixed(1) : 0;
                
                const avgBookingValue = (agent.bookings - agent.cancelled) > 0 ? 
                    agent.revenue / (agent.bookings - agent.cancelled) : 0;
                const revenueLoss = agent.cancelled * avgBookingValue;
                
                // Recovery Potential Logic:
                // If cancellation rate < 25% → Recovery Potential = 0 (acceptable level)
                // If cancellation rate ≥ 25% → Recovery Potential = Revenue loss from excess above 25%
                let recoveryPotential = 0;
                if (parseFloat(cancellationRate) >= 25) {
                    const excessRate = parseFloat(cancellationRate) - 25; // e.g., 37% - 25% = 12%
                    const excessCancellations = (agent.cancelled * excessRate) / parseFloat(cancellationRate); // Excess bookings above 25%
                    recoveryPotential = Math.round(excessCancellations * avgBookingValue);
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="agent-name">${agentName}</td>
                    <td>
                        <span class="agent-type-badge ${agent.type === 'primary' || agent.type === 'both' ? 'primary' : 'secondary'}">
                            ${agent.type === 'both' ? 'Primary' : agent.type}
                        </span>
                    </td>
                    <td class="metric-value">${agent.bookings.toLocaleString()}</td>
                    <td class="metric-value metric-negative">${agent.cancelled.toLocaleString()}</td>
                    <td class="metric-value ${parseFloat(cancellationRate) > 30 ? 'cancellation-problem' : parseFloat(cancellationRate) > 20 ? 'metric-warning' : 'metric-positive'}">
                        ${cancellationRate}%
                    </td>
                    <td class="metric-value metric-positive">₹${agent.revenue.toLocaleString()}</td>
                    <td class="metric-value metric-negative">₹${Math.round(revenueLoss).toLocaleString()}</td>
                    <td class="metric-value metric-warning">₹${recoveryPotential.toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update agent duration table
        function updateAgentDurationTable() {
            const tbody = document.getElementById('agentDurationTableBody');
            tbody.innerHTML = '';

            // Group activity data by date and agent
            const datewiseData = {};
            activityData.forEach(activity => {
                if (activity.activity_type !== 'Regular') return;
                
                const date = activity.start_time.split('T')[0];
                const agent = activity.agent_name;
                
                if (!datewiseData[date]) datewiseData[date] = {};
                if (!datewiseData[date][agent]) {
                    datewiseData[date][agent] = {
                        totalHours: 0,
                        sessions: 0,
                        isLive: false
                    };
                }
                
                let hours;
                if (activity.end_time) {
                    const start = new Date(activity.start_time);
                    const end = new Date(activity.end_time);
                    hours = (end - start) / (1000 * 60 * 60);
                } else {
                    // Agent is live
                    const start = new Date(activity.start_time);
                    const now = new Date();
                    hours = (now - start) / (1000 * 60 * 60);
                    datewiseData[date][agent].isLive = true;
                }
                
                datewiseData[date][agent].totalHours += hours;
                datewiseData[date][agent].sessions++;
            });

            // Sort dates descending
            const sortedDates = Object.keys(datewiseData).sort().reverse();
            
            sortedDates.forEach(date => {
                const agents = Object.keys(datewiseData[date]);
                agents.forEach(agentName => {
                    const data = datewiseData[date][agentName];
                    const hours = data.totalHours;
                    const isLowHours = hours < 6;
                    
                    const row = document.createElement('tr');
                    if (isLowHours) {
                        row.classList.add('low-hours');
                    }
                    
                    row.innerHTML = `
                        <td>${new Date(date).toLocaleDateString()}</td>
                        <td class="agent-name">${agentName}</td>
                        <td>
                            <span class="status-badge ${data.isLive ? 'live' : 'offline'}">
                                ${data.isLive ? 'Live' : 'Offline'}
                            </span>
                        </td>
                        <td class="metric-value ${isLowHours ? 'metric-negative' : 'metric-positive'}">
                            ${hours.toFixed(1)}h
                        </td>
                        <td class="metric-value">${data.sessions}</td>
                        <td class="metric-value ${isLowHours ? 'metric-negative' : 'metric-positive'}">
                            ${isLowHours ? 'Low Hours' : 'Good'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        // Update performance table
        function updatePerformanceTable() {
            const tbody = document.getElementById('performanceTableBody');
            tbody.innerHTML = '';

            // Calculate agent working hours
            const agentHours = {};
            activityData.forEach(activity => {
                if (activity.activity_type !== 'Regular') return;
                
                if (!agentHours[activity.agent_name]) {
                    agentHours[activity.agent_name] = 0;
                }
                
                let hours;
                if (activity.end_time) {
                    const start = new Date(activity.start_time);
                    const end = new Date(activity.end_time);
                    hours = (end - start) / (1000 * 60 * 60);
                } else {
                    const start = new Date(activity.start_time);
                    const now = new Date();
                    hours = (now - start) / (1000 * 60 * 60);
                }
                
                agentHours[activity.agent_name] += hours;
            });

            // Calculate agent totals
            const agentTotals = {};
            performanceData.forEach(agent => {
                if (!agentTotals[agent.agent]) {
                    agentTotals[agent.agent] = {
                        type: agent.agent_type,
                        chats: 0,
                        bookings: 0,
                        cancelled: 0,
                        revenue: 0
                    };
                }
                agentTotals[agent.agent].chats += agent.chats_handled || 0;
                agentTotals[agent.agent].bookings += agent.total_bookings || 0;
                agentTotals[agent.agent].cancelled += agent.cancelled_bookings || 0;
                agentTotals[agent.agent].revenue += agent.total_revenue || 0;
            });

            // Sort by revenue descending
            const sortedAgents = Object.keys(agentTotals).sort((a, b) => 
                agentTotals[b].revenue - agentTotals[a].revenue
            );

            sortedAgents.forEach(agentName => {
                const agent = agentTotals[agentName];
                const workingHours = agentHours[agentName] || 0;
                
                const conversionRate = agent.chats > 0 ? 
                    ((agent.bookings / agent.chats) * 100) : 0;
                const cancellationRate = agent.bookings > 0 ? 
                    ((agent.cancelled / agent.bookings) * 100) : 0;
                
                // Calculate efficiency (revenue per hour)
                const efficiency = workingHours > 0 ? 
                    Math.round(agent.revenue / workingHours) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="agent-name">${agentName}</td>
                    <td>
                        <span class="agent-type-badge ${agent.type === 'primary' || agent.type === 'both' ? 'primary' : 'secondary'}">
                            ${agent.type === 'both' ? 'Primary' : agent.type}
                        </span>
                    </td>
                    <td class="metric-value ${workingHours < 6 ? 'metric-negative' : 'metric-neutral'}">
                        ${workingHours.toFixed(1)}h
                    </td>
                    <td class="metric-value">${agent.chats.toLocaleString()}</td>
                    <td class="metric-value">${agent.bookings.toLocaleString()}</td>
                    <td class="metric-value metric-negative">${agent.cancelled.toLocaleString()}</td>
                    <td class="metric-value ${conversionRate < 45 ? 'conversion-problem' : conversionRate >= 60 ? 'metric-positive' : 'metric-neutral'}">
                        ${conversionRate.toFixed(1)}%
                    </td>
                    <td class="metric-value ${cancellationRate > 30 ? 'cancellation-problem' : cancellationRate > 20 ? 'metric-warning' : 'metric-positive'}">
                        ${cancellationRate.toFixed(1)}%
                    </td>
                    <td class="metric-value metric-positive">₹${agent.revenue.toLocaleString()}</td>
                    <td class="metric-value metric-primary">₹${efficiency}/hr</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Show/hide loading
        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
        }

        // Export data
        function exportData() {
            const csvContent = generateCSV();
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agent-performance-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Generate CSV
        function generateCSV() {
            const headers = [
                'Date', 'Agent', 'Type', 'Chats', 'Bookings', 'Cancelled',
                'Conversion Rate', 'Cancellation Rate', 'Revenue', 'Working Hours'
            ];

            const rows = performanceData.map(agent => [
                agent.date,
                agent.agent,
                agent.agent_type,
                agent.chats_handled || 0,
                agent.total_bookings || 0,
                agent.cancelled_bookings || 0,
                agent.chats_handled > 0 ? (((agent.total_bookings || 0) / agent.chats_handled) * 100).toFixed(2) + '%' : '0%',
                agent.total_bookings > 0 ? (((agent.cancelled_bookings || 0) / agent.total_bookings) * 100).toFixed(2) + '%' : '0%',
                agent.total_revenue || 0,
                'Calculated from activity data'
            ]);

            return [headers, ...rows]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');
        }
    </script>
</body>
</html>

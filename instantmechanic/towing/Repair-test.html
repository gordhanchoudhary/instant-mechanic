<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FF6B35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Mechanic Repair Tracker</title>
    <style>
        :root {
            --primary: #FF6B35;
            --secondary: #1a1a1a;
            --success: #4CAF50;
            --warning: #FFA726;
            --danger: #EF5350;
            --gray: #757575;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light-gray);
            color: var(--secondary);
            line-height: 1.4;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            user-select: none;
        }

        /* Header */
        .header {
            background: var(--white);
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary);
        }

        .mechanic-name {
            font-size: 14px;
            color: var(--gray);
            font-weight: 500;
        }

        /* Container */
        .container {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
            min-height: calc(100vh - 80px);
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Car Cards */
        .car-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .car-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .car-card:active {
            transform: scale(0.98);
        }

        .car-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
        }

        .car-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        .car-details {
            font-size: 18px;
            color: var(--gray);
            margin-bottom: 12px;
        }

        .car-status {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-badge.pending {
            background: var(--light-gray);
            color: var(--gray);
        }

        .status-badge.in-progress {
            background: rgba(255, 167, 38, 0.15);
            color: var(--warning);
        }

        .status-badge.completed {
            background: rgba(76, 175, 80, 0.15);
            color: var(--success);
        }

        /* Car Detail View */
        .back-button {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            color: var(--secondary);
            background: none;
            border: none;
            cursor: pointer;
            margin-bottom: 24px;
            padding: 8px 0;
        }

        .car-info {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .car-info h2 {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .car-info p {
            font-size: 20px;
            color: var(--gray);
        }

        /* Action Buttons */
        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .action-button {
            background: var(--white);
            border: none;
            border-radius: var(--radius);
            padding: 32px 16px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        .action-button:active {
            transform: scale(0.95);
        }

        .action-button.before {
            background: linear-gradient(135deg, #FF6B35 0%, #FF8E53 100%);
            color: white;
        }

        .action-button.during {
            background: linear-gradient(135deg, #FFA726 0%, #FFB74D 100%);
            color: white;
        }

        .action-button.after {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
        }

        .action-button.test {
            background: linear-gradient(135deg, #5C6BC0 0%, #7986CB 100%);
            color: white;
            grid-column: 1 / -1;
        }

        .action-button.completed {
            opacity: 0.7;
            position: relative;
        }

        .action-button.completed::after {
            content: 'âœ“';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 24px;
            font-weight: bold;
        }

        .action-button svg {
            width: 48px;
            height: 48px;
        }

        .action-button span {
            font-size: 22px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Camera Modal */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        .camera-modal.active {
            display: flex;
        }

        .camera-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .camera-title {
            color: white;
            font-size: 20px;
            font-weight: 600;
        }

        .close-camera {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        #video-preview {
            width: 100%;
            height: 100vh;
            object-fit: cover;
        }

        .camera-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
        }

        .capture-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            border: 4px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .capture-button:active {
            transform: scale(0.9);
        }

        .capture-button.recording {
            background: var(--danger);
        }

        /* Success Message */
        .success-message {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            box-shadow: var(--shadow);
            display: none;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Media Gallery */
        .media-gallery {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 16px;
            box-shadow: var(--shadow);
        }

        .media-gallery h3 {
            font-size: 20px;
            margin-bottom: 16px;
            color: var(--secondary);
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        .media-item {
            position: relative;
            padding-top: 100%;
            background: var(--light-gray);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }

        .media-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-type {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            text-transform: uppercase;
        }

        /* Summary Section */
        .summary-section {
            background: linear-gradient(135deg, var(--primary), #FF8E53);
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 20px;
        }

        .summary-section h3 {
            font-size: 20px;
            margin-bottom: 16px;
        }

        .summary-item {
            margin-bottom: 12px;
        }

        .summary-item h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .summary-item p {
            font-size: 16px;
            line-height: 1.5;
        }

        /* File Input */
        .file-input {
            display: none;
        }

        /* Admin Button */
        .admin-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            z-index: 99;
        }

        /* Responsive */
        @media (max-width: 400px) {
            .action-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Add Car Button */
        .add-car-button {
            width: 100%;
            margin-top: 20px;
            padding: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .add-car-button:active {
            transform: scale(0.98);
        }

        /* Add Car Form Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .add-car-form {
            background: var(--white);
            border-radius: var(--radius);
            padding: 24px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .form-header h2 {
            font-size: 24px;
            color: var(--secondary);
        }

        .close-form {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-form:hover {
            background: var(--light-gray);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .form-button {
            flex: 1;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-button.cancel {
            background: var(--light-gray);
            color: var(--secondary);
        }

        .form-button.save {
            background: var(--primary);
            color: white;
        }

        .form-button:active {
            transform: scale(0.98);
        }

        /* Voice Recording Section */
        .voice-section {
            position: absolute;
            bottom: 140px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: var(--radius);
            padding: 16px;
        }

        .voice-button {
            width: 100%;
            padding: 16px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .voice-button:active {
            transform: scale(0.98);
        }

        .voice-button.recording {
            animation: pulse 1.5s infinite;
            background: #FF3333;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .voice-timer {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            color: var(--secondary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: none;
        }

        /* Admin Dashboard Styles */
        .admin-header {
            padding: 0 16px;
            margin-bottom: 24px;
        }

        .admin-header h2 {
            font-size: 28px;
            color: var(--secondary);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            padding: 0 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray);
        }

        .admin-repairs-list {
            padding: 0 16px 20px;
        }

        .repair-summary-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .repair-summary-card:active {
            transform: scale(0.98);
        }

        .repair-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .repair-car-info h3 {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .repair-car-info p {
            color: var(--gray);
            font-size: 14px;
        }

        .progress-indicator {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .stage-dot {
            width: 40px;
            height: 8px;
            background: var(--light-gray);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .stage-dot.completed {
            background: var(--success);
        }

        .repair-summary-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--gray);
            font-size: 14px;
        }

        .ai-badge {
            background: linear-gradient(135deg, var(--primary), #FF8E53);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Repair Detail Modal */
        .repair-detail-modal {
            background: var(--white);
            border-radius: var(--radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .repair-detail-content {
            padding: 24px;
        }

        .timeline {
            margin-bottom: 30px;
        }

        .timeline-item {
            position: relative;
            padding-left: 40px;
            margin-bottom: 30px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 30px;
            bottom: -30px;
            width: 2px;
            background: var(--light-gray);
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: absolute;
            left: 10px;
            top: 5px;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            border: 3px solid var(--white);
            box-shadow: 0 0 0 2px var(--primary);
        }

        .timeline-content {
            background: var(--light-gray);
            padding: 16px;
            border-radius: var(--radius);
        }

        .timeline-stage {
            font-weight: 600;
            text-transform: uppercase;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .timeline-meta {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 12px;
        }

        .timeline-media {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .timeline-media-item {
            position: relative;
            padding-top: 100%;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }

        .timeline-media-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .export-button {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .export-button:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>Mechanic App</h1>
        <div class="mechanic-name" id="mechanic-name">Rajesh Kumar</div>
    </div>

    <!-- Container -->
    <div class="container">
        <!-- Car List View -->
        <div id="car-list-view" class="view active">
            <div class="car-list" id="car-list">
                <!-- Cars will be dynamically added here -->
            </div>
            
            <!-- Add Car Button -->
            <button class="add-car-button" onclick="showAddCarForm()">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                <span>Add New Car</span>
            </button>
        </div>

        <!-- Car Detail View -->
        <div id="car-detail-view" class="view">
            <button class="back-button" onclick="showView('car-list-view')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
                Back
            </button>

            <div class="car-info" id="car-info">
                <!-- Car details will be inserted here -->
            </div>

            <div class="action-grid">
                <button class="action-button before" onclick="openCamera('before')">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    <span>BEFORE</span>
                </button>

                <button class="action-button during" onclick="openCamera('during')">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/>
                    </svg>
                    <span>DURING</span>
                </button>

                <button class="action-button after" onclick="openCamera('after')">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                    </svg>
                    <span>AFTER</span>
                </button>

                <button class="action-button test" onclick="openCamera('test')">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                    </svg>
                    <span>TEST DRIVE</span>
                </button>
            </div>

            <!-- Media Gallery -->
            <div class="media-gallery" id="media-gallery" style="display: none;">
                <h3>Captured Media</h3>
                <div class="media-grid" id="media-grid">
                    <!-- Media items will be added here -->
                </div>
            </div>

            <!-- AI Summary -->
            <div class="summary-section" id="summary-section" style="display: none;">
                <h3>ðŸ¤– AI-Generated Summary</h3>
                <div id="summary-content">
                    <!-- Summary will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="camera-modal">
        <div class="camera-header">
            <div class="camera-title" id="camera-title">BEFORE</div>
            <button class="close-camera" onclick="closeCamera()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                </svg>
            </button>
        </div>

        <video id="video-preview" autoplay playsinline></video>
        
        <div class="camera-controls">
            <button class="capture-button" id="capture-button" onclick="capturePhoto()"></button>
        </div>
        
        <!-- Voice Recording Section -->
        <div class="voice-section" id="voice-section" style="display: none;">
            <button class="voice-button" id="voice-button" onclick="toggleVoiceRecording()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
                <span id="voice-text">Add Voice Note (Optional - 20 sec max)</span>
            </button>
        </div>
    </div>

    <!-- File Input for fallback -->
    <input type="file" id="file-input" class="file-input" accept="image/*,video/*" capture="environment" onchange="handleFileSelect(event)">

    <!-- Success Message -->
    <div class="success-message" id="success-message">
        Saved Successfully!
    </div>

    <!-- Admin Toggle Button -->
    <button class="admin-toggle" onclick="showAdminDashboard()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
        </svg>
    </button>

    <!-- Admin Dashboard View -->
    <div id="admin-view" class="view">
        <div class="admin-header">
            <button class="back-button" onclick="showView('car-list-view')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
                Back to Cars
            </button>
            <h2 style="margin-top: 16px;">Admin Dashboard</h2>
        </div>

        <!-- Statistics -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="total-repairs">0</div>
                <div class="stat-label">Total Cars</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="in-progress">0</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completed">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="ai-summaries">0</div>
                <div class="stat-label">AI Summaries</div>
            </div>
        </div>

        <!-- Repairs List -->
        <div class="admin-repairs-list" id="admin-repairs-list">
            <!-- Repair cards will be added here -->
        </div>
    </div>

    <!-- Repair Detail Modal -->
    <div class="modal-overlay" id="repair-detail-modal">
        <div class="repair-detail-modal">
            <div class="modal-header">
                <h2 id="repair-modal-title">Repair Details</h2>
                <button class="close-form" onclick="closeRepairModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                    </svg>
                </button>
            </div>
            
            <div class="repair-detail-content" id="repair-detail-content">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Add Car Form Modal -->
    <div class="modal-overlay" id="add-car-modal">
        <div class="add-car-form">
            <div class="form-header">
                <h2>Add New Car</h2>
                <button class="close-form" onclick="hideAddCarForm()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                    </svg>
                </button>
            </div>
            
            <form onsubmit="addNewCar(event)">
                <div class="form-group">
                    <label for="car-number">Car Number *</label>
                    <input 
                        type="text" 
                        id="car-number" 
                        placeholder="e.g. DL 5C AB 1234" 
                        required
                        autocomplete="off"
                        style="text-transform: uppercase;"
                    >
                </div>
                
                <div class="form-group">
                    <label for="car-make">Car Make & Model *</label>
                    <input 
                        type="text" 
                        id="car-make" 
                        placeholder="e.g. Honda City" 
                        required
                        autocomplete="off"
                    >
                </div>
                
                <div class="form-actions">
                    <button type="button" class="form-button cancel" onclick="hideAddCarForm()">
                        Cancel
                    </button>
                    <button type="submit" class="form-button save">
                        Add Car
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // State Management
        let currentCar = null;
        let currentStage = null;
        let mediaStream = null;
        let audioRecorder = null;
        let audioChunks = [];
        let voiceTimer = null;
        let voiceSeconds = 0;
        let capturedPhotoData = null;
        let repairs = JSON.parse(localStorage.getItem('repairs')) || {};
        let cars = JSON.parse(localStorage.getItem('cars')) || [
            { id: 1, number: 'DL 5C AB 1234', make: 'Honda City' },
            { id: 2, number: 'HR 26 CD 5678', make: 'Maruti Swift' },
            { id: 3, number: 'UP 32 EF 9012', make: 'Toyota Innova' }
        ];

        // Initialize App
        function init() {
            renderCarList();
            
            // Check if camera is available
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.log('Camera API not available');
            }
        }

        // Show/Hide Views
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        // Render Car List
        function renderCarList() {
            const carListEl = document.getElementById('car-list');
            carListEl.innerHTML = '';

            cars.forEach(car => {
                const carRepairs = repairs[car.id] || {};
                const progress = calculateProgress(carRepairs);
                const statusClass = progress === 100 ? 'completed' : progress > 0 ? 'in-progress' : 'pending';
                const statusText = progress === 100 ? 'Completed' : progress > 0 ? `${progress}% Done` : 'Not Started';

                const cardDiv = document.createElement('div');
                cardDiv.className = 'car-card';
                cardDiv.innerHTML = `
                    <div class="car-number">${car.number}</div>
                    <div class="car-details">${car.make}</div>
                    <div class="car-status">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                `;
                
                // Regular click to select car
                cardDiv.onclick = () => selectCar(car.id);
                
                // Long press to delete (optional)
                let pressTimer;
                cardDiv.addEventListener('touchstart', (e) => {
                    pressTimer = setTimeout(() => {
                        if (confirm(`Delete ${car.number}?`)) {
                            deleteCar(car.id);
                        }
                    }, 1000); // 1 second long press
                });
                
                cardDiv.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                });
                
                cardDiv.addEventListener('touchmove', () => {
                    clearTimeout(pressTimer);
                });
                
                carListEl.appendChild(cardDiv);
            });
        }

        // Calculate Progress
        function calculateProgress(carRepairs) {
            const stages = ['before', 'during', 'after', 'test'];
            const completed = stages.filter(stage => carRepairs[stage] && carRepairs[stage].length > 0).length;
            return Math.round((completed / 4) * 100);
        }

        // Select Car
        function selectCar(carId) {
            currentCar = cars.find(c => c.id === carId);
            showCarDetail();
        }

        // Show Car Detail
        function showCarDetail() {
            showView('car-detail-view');
            
            const carInfoEl = document.getElementById('car-info');
            carInfoEl.innerHTML = `
                <h2>${currentCar.number}</h2>
                <p>${currentCar.make}</p>
            `;

            updateButtonStates();
            displayMedia();
            generateSummaryIfComplete();
        }

        // Update Button States
        function updateButtonStates() {
            const carRepairs = repairs[currentCar.id] || {};
            const buttons = document.querySelectorAll('.action-button');
            
            buttons.forEach(button => {
                const stage = button.classList[1];
                if (carRepairs[stage] && carRepairs[stage].length > 0) {
                    button.classList.add('completed');
                } else {
                    button.classList.remove('completed');
                }
            });
        }

        // Open Camera
        async function openCamera(stage) {
            currentStage = stage;
            document.getElementById('camera-title').textContent = stage.toUpperCase();
            
            try {
                // Try to access camera
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });
                
                document.getElementById('video-preview').srcObject = mediaStream;
                document.getElementById('camera-modal').classList.add('active');
            } catch (err) {
                console.log('Camera access denied, using file input');
                // Fallback to file input
                document.getElementById('file-input').click();
            }
        }

        // Close Camera
        function closeCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            document.getElementById('camera-modal').classList.remove('active');
        }

        // Capture Photo
        function capturePhoto() {
            const video = document.getElementById('video-preview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Show voice recording option
            document.getElementById('voice-section').style.display = 'block';
            
            // Change capture button to save button
            const captureBtn = document.getElementById('capture-button');
            captureBtn.style.background = '#4CAF50';
            captureBtn.onclick = saveMediaWithVoice;
            captureBtn.innerHTML = 'âœ“';
        }

        // Handle File Select (Fallback)
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    saveMedia(e.target.result, file.type.startsWith('video') ? 'video' : 'photo');
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        // Save Media
        function saveMedia(dataUrl, type, voiceData = null) {
            if (!currentCar || !currentStage) return;

            // Initialize repairs structure
            if (!repairs[currentCar.id]) {
                repairs[currentCar.id] = {};
            }
            if (!repairs[currentCar.id][currentStage]) {
                repairs[currentCar.id][currentStage] = [];
            }

            // Add media
            repairs[currentCar.id][currentStage].push({
                type: type,
                data: dataUrl,
                voiceNote: voiceData,
                timestamp: new Date().toISOString()
            });

            // Save to localStorage
            localStorage.setItem('repairs', JSON.stringify(repairs));

            // Update UI
            updateButtonStates();
            displayMedia();
            generateSummaryIfComplete();
            showSuccess();
        }

        // Toggle Voice Recording
        async function toggleVoiceRecording() {
            const voiceButton = document.getElementById('voice-button');
            const voiceText = document.getElementById('voice-text');
            
            if (audioRecorder && audioRecorder.state === 'recording') {
                // Stop recording
                audioRecorder.stop();
                clearInterval(voiceTimer);
                voiceButton.classList.remove('recording');
                voiceText.textContent = 'Voice Note Recorded!';
            } else {
                // Start recording
                try {
                    const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioChunks = [];
                    audioRecorder = new MediaRecorder(audioStream);
                    
                    audioRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    audioRecorder.onstop = () => {
                        audioStream.getTracks().forEach(track => track.stop());
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            // Store audio data with the photo
                            if (capturedPhotoData) {
                                saveMedia(capturedPhotoData, 'photo', reader.result);
                                closeCamera();
                            }
                        };
                        reader.readAsDataURL(audioBlob);
                    };
                    
                    audioRecorder.start();
                    voiceButton.classList.add('recording');
                    
                    // Start timer
                    voiceSeconds = 0;
                    voiceText.textContent = 'Recording... 0s';
                    voiceTimer = setInterval(() => {
                        voiceSeconds++;
                        voiceText.textContent = `Recording... ${voiceSeconds}s`;
                        
                        // Auto stop after 20 seconds
                        if (voiceSeconds >= 20) {
                            toggleVoiceRecording();
                        }
                    }, 1000);
                    
                } catch (err) {
                    console.error('Microphone access denied:', err);
                    alert('Please allow microphone access to record voice notes');
                }
            }
        }

        // Save Media with Voice
        function saveMediaWithVoice() {
            if (capturedPhotoData) {
                // If voice is still recording, stop it first
                if (audioRecorder && audioRecorder.state === 'recording') {
                    toggleVoiceRecording();
                } else {
                    // Save without voice
                    saveMedia(capturedPhotoData, 'photo');
                    closeCamera();
                }
            }
        }

        // Update Close Camera
        function closeCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if (audioRecorder && audioRecorder.state === 'recording') {
                audioRecorder.stop();
            }
            clearInterval(voiceTimer);
            
            // Reset states
            capturedPhotoData = null;
            audioChunks = [];
            voiceSeconds = 0;
            
            // Reset UI
            document.getElementById('camera-modal').classList.remove('active');
            document.getElementById('voice-section').style.display = 'none';
            document.getElementById('voice-button').classList.remove('recording');
            document.getElementById('voice-text').textContent = 'Add Voice Note (Optional - 20 sec max)';
            
            // Reset capture button
            const captureBtn = document.getElementById('capture-button');
            captureBtn.style.background = 'white';
            captureBtn.onclick = capturePhoto;
            captureBtn.innerHTML = '';
        }

        // Display Media
        function displayMedia() {
            const carRepairs = repairs[currentCar.id];
            if (!carRepairs) return;

            const mediaGallery = document.getElementById('media-gallery');
            const mediaGrid = document.getElementById('media-grid');
            
            mediaGrid.innerHTML = '';
            let hasMedia = false;

            ['before', 'during', 'after', 'test'].forEach(stage => {
                if (carRepairs[stage] && carRepairs[stage].length > 0) {
                    hasMedia = true;
                    carRepairs[stage].forEach((media, index) => {
                        const mediaItem = document.createElement('div');
                        mediaItem.className = 'media-item';
                        mediaItem.style.position = 'relative';
                        mediaItem.innerHTML = `
                            <img src="${media.data}" alt="${stage} ${media.type}">
                            <span class="media-type">${stage}</span>
                            ${media.voiceNote ? '<span class="voice-indicator" style="position: absolute; top: 4px; left: 4px; background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">ðŸŽ¤ Voice</span>' : ''}
                        `;
                        
                        // Play voice note on click if available
                        if (media.voiceNote) {
                            mediaItem.style.cursor = 'pointer';
                            mediaItem.onclick = () => {
                                const audio = new Audio(media.voiceNote);
                                audio.play();
                            };
                        }
                        
                        mediaGrid.appendChild(mediaItem);
                    });
                }
            });

            mediaGallery.style.display = hasMedia ? 'block' : 'none';
        }

        // Generate Summary if Complete
        function generateSummaryIfComplete() {
            const carRepairs = repairs[currentCar.id];
            if (!carRepairs) return;

            // Check if after or test stage is complete
            if ((carRepairs.after && carRepairs.after.length > 0) || 
                (carRepairs.test && carRepairs.test.length > 0)) {
                
                // Generate AI Summary (Mock)
                const summary = generateAISummary(carRepairs);
                displaySummary(summary);
            } else {
                document.getElementById('summary-section').style.display = 'none';
            }
        }

        // Generate AI Summary (Enhanced)
        function generateAISummary(carRepairs) {
            // In a real app, this would analyze voice notes and images with AI
            // For now, we'll generate contextual summaries based on repair stages
            
            const problemTemplates = [
                {
                    problem: "Engine making unusual knocking noise during idle. Check engine light illuminated.",
                    work: "Diagnosed faulty ignition coil and worn spark plugs. Replaced all 4 spark plugs and ignition coil pack. Cleaned throttle body and MAF sensor.",
                    parts: ["Spark plugs (4 units - NGK Iridium)", "Ignition coil pack", "MAF sensor cleaner"],
                    result: "Engine running smoothly with no abnormal sounds. Check engine light cleared after ECU reset."
                },
                {
                    problem: "Vehicle experiencing rough idle and misfiring on cylinder 3. Reduced engine power.",
                    work: "Compression test revealed low compression on cylinder 3. Found burnt exhaust valve. Performed valve job and replaced valve seals.",
                    parts: ["Exhaust valve", "Valve seals", "Head gasket", "Engine oil (5L)"],
                    result: "Compression restored to factory specifications. Engine running perfectly with smooth idle."
                },
                {
                    problem: "Excessive vibration while driving. Steering wheel shaking at speeds above 60 km/h.",
                    work: "Found worn front wheel bearings and unbalanced wheels. Replaced both front wheel bearings and performed wheel alignment and balancing.",
                    parts: ["Front wheel bearings (2 units)", "Wheel weights"],
                    result: "Vibration eliminated. Vehicle drives smoothly at all speeds. Alignment within specifications."
                },
                {
                    problem: "Oil leak detected under engine. Low oil pressure warning light intermittent.",
                    work: "Identified leaking oil pan gasket and worn oil pressure sensor. Replaced oil pan gasket, oil pressure sensor, and performed complete oil change.",
                    parts: ["Oil pan gasket", "Oil pressure sensor", "Engine oil (4.5L)", "Oil filter"],
                    result: "Oil leak fixed. Oil pressure normal and warning light no longer appearing."
                },
                {
                    problem: "AC not cooling properly. Compressor making clicking noise.",
                    work: "AC system diagnosis showed low refrigerant and failing compressor clutch. Replaced AC compressor, recharged system with R134a refrigerant.",
                    parts: ["AC compressor", "R134a refrigerant (850g)", "AC oil (150ml)"],
                    result: "AC cooling efficiently. Cabin temperature reaching 18Â°C. No abnormal noises."
                }
            ];

            // Select template based on stages completed
            const hasAllStages = carRepairs.before && carRepairs.during && carRepairs.after;
            const templateIndex = Math.floor(Math.random() * problemTemplates.length);
            const template = problemTemplates[templateIndex];

            // Add timestamp variations
            const timeSpent = hasAllStages ? "3.5 hours" : "2 hours";
            const mechanicNotes = [
                "Customer advised for next service after 5000 km.",
                "Recommend coolant flush in next service.",
                "All fluids checked and topped up.",
                "Test drive completed - 5km city and highway.",
                "Battery health checked - good condition."
            ];

            return {
                problemObserved: template.problem,
                workCarriedOut: template.work,
                partsReplaced: template.parts,
                finalResult: template.result,
                timeSpent: timeSpent,
                additionalNotes: mechanicNotes[Math.floor(Math.random() * mechanicNotes.length)],
                generatedAt: new Date().toISOString(),
                mechanicName: document.getElementById('mechanic-name').textContent
            };
        }

        // Display Summary
        function displaySummary(summary) {
            const summarySection = document.getElementById('summary-section');
            const summaryContent = document.getElementById('summary-content');
            
            summaryContent.innerHTML = `
                <div class="summary-item">
                    <h4>Problem Observed</h4>
                    <p>${summary.problemObserved}</p>
                </div>
                <div class="summary-item">
                    <h4>Work Carried Out</h4>
                    <p>${summary.workCarriedOut}</p>
                </div>
                <div class="summary-item">
                    <h4>Parts Replaced</h4>
                    <p>${summary.partsReplaced.join(', ')}</p>
                </div>
                <div class="summary-item">
                    <h4>Final Result</h4>
                    <p>${summary.finalResult}</p>
                </div>
                ${summary.additionalNotes ? `
                <div class="summary-item">
                    <h4>Additional Notes</h4>
                    <p>${summary.additionalNotes}</p>
                </div>` : ''}
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 14px; opacity: 0.8;">
                    <p>Time Spent: ${summary.timeSpent || 'N/A'}</p>
                    <p>Mechanic: ${summary.mechanicName || 'Rajesh Kumar'}</p>
                    <p>Generated: ${new Date(summary.generatedAt).toLocaleString()}</p>
                </div>
            `;
            
            summarySection.style.display = 'block';
        }

        // Show Success Message
        function showSuccess() {
            const successMsg = document.getElementById('success-message');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }

        // Show Admin Dashboard
        function showAdminDashboard() {
            showView('admin-view');
            updateAdminStats();
            renderAdminRepairsList();
        }

        // Update Admin Statistics
        function updateAdminStats() {
            const totalCars = cars.length;
            let inProgress = 0;
            let completed = 0;
            let aiSummaries = 0;

            cars.forEach(car => {
                const carRepairs = repairs[car.id];
                if (carRepairs) {
                    const progress = calculateProgress(carRepairs);
                    if (progress === 100) {
                        completed++;
                    } else if (progress > 0) {
                        inProgress++;
                    }
                    
                    // Check for AI summary
                    if (carRepairs.aiSummary) {
                        aiSummaries++;
                    }
                }
            });

            document.getElementById('total-repairs').textContent = totalCars;
            document.getElementById('in-progress').textContent = inProgress;
            document.getElementById('completed').textContent = completed;
            document.getElementById('ai-summaries').textContent = aiSummaries;
        }

        // Render Admin Repairs List
        function renderAdminRepairsList() {
            const listEl = document.getElementById('admin-repairs-list');
            listEl.innerHTML = '';

            cars.forEach(car => {
                const carRepairs = repairs[car.id] || {};
                const progress = calculateProgress(carRepairs);
                
                const repairCard = document.createElement('div');
                repairCard.className = 'repair-summary-card';
                repairCard.onclick = () => showRepairDetail(car.id);
                
                repairCard.innerHTML = `
                    <div class="repair-summary-header">
                        <div class="repair-car-info">
                            <h3>${car.number}</h3>
                            <p>${car.make}</p>
                        </div>
                        ${carRepairs.aiSummary ? '<span class="ai-badge">AI Summary</span>' : ''}
                    </div>
                    
                    <div class="progress-indicator">
                        <div class="stage-dot ${carRepairs.before ? 'completed' : ''}"></div>
                        <div class="stage-dot ${carRepairs.during ? 'completed' : ''}"></div>
                        <div class="stage-dot ${carRepairs.after ? 'completed' : ''}"></div>
                        <div class="stage-dot ${carRepairs.test ? 'completed' : ''}"></div>
                    </div>
                    
                    <div class="repair-summary-footer">
                        <span>${progress}% Complete</span>
                        <span>${getLastUpdateTime(carRepairs)}</span>
                    </div>
                `;
                
                listEl.appendChild(repairCard);
            });
        }

        // Get Last Update Time
        function getLastUpdateTime(carRepairs) {
            let lastTime = null;
            ['before', 'during', 'after', 'test'].forEach(stage => {
                if (carRepairs[stage]) {
                    carRepairs[stage].forEach(media => {
                        const time = new Date(media.timestamp);
                        if (!lastTime || time > lastTime) {
                            lastTime = time;
                        }
                    });
                }
            });
            
            if (!lastTime) return 'No updates';
            
            const now = new Date();
            const diff = now - lastTime;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            return 'Just now';
        }

        // Show Repair Detail
        function showRepairDetail(carId) {
            const car = cars.find(c => c.id === carId);
            const carRepairs = repairs[carId] || {};
            
            document.getElementById('repair-modal-title').textContent = `${car.number} - ${car.make}`;
            
            const content = document.getElementById('repair-detail-content');
            content.innerHTML = '';
            
            // Add AI Summary if available
            if (carRepairs.aiSummary) {
                content.innerHTML += `
                    <div class="summary-section">
                        <h3>ðŸ¤– AI-Generated Summary</h3>
                        <div class="summary-item">
                            <h4>Problem Observed</h4>
                            <p>${carRepairs.aiSummary.problemObserved}</p>
                        </div>
                        <div class="summary-item">
                            <h4>Work Carried Out</h4>
                            <p>${carRepairs.aiSummary.workCarriedOut}</p>
                        </div>
                        <div class="summary-item">
                            <h4>Parts Replaced</h4>
                            <p>${carRepairs.aiSummary.partsReplaced.join(', ')}</p>
                        </div>
                        <div class="summary-item">
                            <h4>Final Result</h4>
                            <p>${carRepairs.aiSummary.finalResult}</p>
                        </div>
                    </div>
                `;
            } else if ((carRepairs.after && carRepairs.after.length > 0) || 
                       (carRepairs.test && carRepairs.test.length > 0)) {
                // Generate AI summary if repair is complete but no summary exists
                const summary = generateAISummary(carRepairs);
                carRepairs.aiSummary = summary;
                repairs[carId] = carRepairs;
                localStorage.setItem('repairs', JSON.stringify(repairs));
                
                content.innerHTML += `
                    <div class="summary-section">
                        <h3>ðŸ¤– AI-Generated Summary</h3>
                        <div class="summary-item">
                            <h4>Problem Observed</h4>
                            <p>${summary.problemObserved}</p>
                        </div>
                        <div class="summary-item">
                            <h4>Work Carried Out</h4>
                            <p>${summary.workCarriedOut}</p>
                        </div>
                        <div class="summary-item">
                            <h4>Parts Replaced</h4>
                            <p>${summary.partsReplaced.join(', ')}</p>
                        </div>
                        <div class="summary-item">
                            <h4>Final Result</h4>
                            <p>${summary.finalResult}</p>
                        </div>
                    </div>
                `;
            }
            
            // Add timeline
            content.innerHTML += '<h3 style="margin-top: 30px; margin-bottom: 20px;">Repair Timeline</h3>';
            content.innerHTML += '<div class="timeline">';
            
            ['before', 'during', 'after', 'test'].forEach(stage => {
                if (carRepairs[stage] && carRepairs[stage].length > 0) {
                    carRepairs[stage].forEach((media, index) => {
                        const timelineItem = document.createElement('div');
                        timelineItem.className = 'timeline-item';
                        
                        timelineItem.innerHTML = `
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div class="timeline-stage">${stage}</div>
                                <div class="timeline-meta">
                                    ${new Date(media.timestamp).toLocaleString()}
                                    ${media.voiceNote ? ' â€¢ ðŸŽ¤ Voice note attached' : ''}
                                </div>
                                <div class="timeline-media">
                                    <div class="timeline-media-item" onclick="viewMedia('${media.data}', '${media.voiceNote || ''}')">
                                        <img src="${media.data}" alt="${stage}">
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        content.querySelector('.timeline').appendChild(timelineItem);
                    });
                }
            });
            
            content.innerHTML += '</div>';
            
            // Add export button
            content.innerHTML += `
                <button class="export-button" onclick="exportRepairReport(${carId})">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                    </svg>
                    Export Report
                </button>
            `;
            
            document.getElementById('repair-detail-modal').classList.add('active');
        }

        // Close Repair Modal
        function closeRepairModal() {
            document.getElementById('repair-detail-modal').classList.remove('active');
        }

        // View Media
        function viewMedia(imageData, voiceData) {
            // Show image in full screen
            const img = new Image();
            img.src = imageData;
            img.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; background: black; z-index: 9999;';
            img.onclick = () => img.remove();
            document.body.appendChild(img);
            
            // Play voice if available
            if (voiceData) {
                const audio = new Audio(voiceData);
                audio.play();
            }
        }

        // Export Repair Report
        function exportRepairReport(carId) {
            const car = cars.find(c => c.id === carId);
            const carRepairs = repairs[carId] || {};
            
            let report = `REPAIR REPORT\n`;
            report += `================\n\n`;
            report += `Car: ${car.number}\n`;
            report += `Make/Model: ${car.make}\n`;
            report += `Date: ${new Date().toLocaleDateString()}\n\n`;
            
            if (carRepairs.aiSummary) {
                report += `AI SUMMARY\n`;
                report += `----------\n`;
                report += `Problem: ${carRepairs.aiSummary.problemObserved}\n`;
                report += `Work Done: ${carRepairs.aiSummary.workCarriedOut}\n`;
                report += `Parts: ${carRepairs.aiSummary.partsReplaced.join(', ')}\n`;
                report += `Result: ${carRepairs.aiSummary.finalResult}\n\n`;
            }
            
            report += `TIMELINE\n`;
            report += `--------\n`;
            ['before', 'during', 'after', 'test'].forEach(stage => {
                if (carRepairs[stage] && carRepairs[stage].length > 0) {
                    report += `\n${stage.toUpperCase()}:\n`;
                    carRepairs[stage].forEach((media, index) => {
                        report += `- ${new Date(media.timestamp).toLocaleString()}`;
                        report += media.voiceNote ? ' (with voice note)\n' : '\n';
                    });
                }
            });
            
            // Create downloadable file
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `repair_report_${car.number.replace(/\s/g, '_')}_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showSuccess();
        }

        // Show Add Car Form
        function showAddCarForm() {
            document.getElementById('add-car-modal').classList.add('active');
            document.getElementById('car-number').focus();
        }

        // Hide Add Car Form
        function hideAddCarForm() {
            document.getElementById('add-car-modal').classList.remove('active');
            document.getElementById('car-number').value = '';
            document.getElementById('car-make').value = '';
        }

        // Add New Car
        function addNewCar(event) {
            event.preventDefault();
            
            const carNumber = document.getElementById('car-number').value.trim().toUpperCase();
            const carMake = document.getElementById('car-make').value.trim();
            
            // Check if car number already exists
            const exists = cars.some(car => car.number === carNumber);
            if (exists) {
                alert('This car number already exists!');
                return;
            }
            
            // Generate new ID
            const newId = cars.length > 0 ? Math.max(...cars.map(c => c.id)) + 1 : 1;
            
            // Add new car
            const newCar = {
                id: newId,
                number: carNumber,
                make: carMake
            };
            
            cars.push(newCar);
            
            // Save to localStorage
            localStorage.setItem('cars', JSON.stringify(cars));
            
            // Refresh car list
            renderCarList();
            
            // Close form
            hideAddCarForm();
            
            // Show success message
            showSuccess();
            
            // Optional: Auto-select the new car
            selectCar(newId);
        }

        // Delete Car (optional function for admin)
        function deleteCar(carId) {
            if (confirm('Are you sure you want to delete this car and all its repair data?')) {
                // Remove from cars array
                cars = cars.filter(c => c.id !== carId);
                
                // Remove repair data
                delete repairs[carId];
                
                // Save to localStorage
                localStorage.setItem('cars', JSON.stringify(cars));
                localStorage.setItem('repairs', JSON.stringify(repairs));
                
                // Refresh UI
                renderCarList();
                showView('car-list-view');
            }
        }

        // Initialize on load
        window.addEventListener('load', init);

        // Handle back button
        window.addEventListener('popstate', function() {
            showView('car-list-view');
        });

        // Add to home screen prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        // Service Worker Registration (for PWA)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript,' + encodeURIComponent(`
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('activate', e => clients.claim());
                self.addEventListener('fetch', e => e.respondWith(fetch(e.request)));
            `));
        }
    </script>
</body>
</html>
